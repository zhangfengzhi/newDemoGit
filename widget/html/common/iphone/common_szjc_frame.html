<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<!-- html5：在创建html时为了防止页面缩放等不兼容效果，要创建个viewport  -->
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<!-- 在IOS设备上，有时会将数字转为手机号，这里也要禁止下 -->
		<meta name="format-detection" content="telephone=no"/>
		<title>设置教材frame</title>
		<link rel="stylesheet" type="text/css" href="../../../css/aui/aui.css" />
		<link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
		<style>
			body:before{display:block;content:"";height:10px; visibility:hidden;}
			.common{position:relative;line-height:45px;margin-top:10px;padding:0 15px;border-top:1px solid #e0e0e0;border-bottom:1px solid #e0e0e0;background:#f6f6f6;color:#333;}
			.common .title{position:absolute;left:15px;display:inline-block;}
			.common .name{display:inline-block;width:100%;padding-left:60px;text-align:right;}
			.common-ul{background:#fff;color:#555;}
			.common-ul li{line-height:45px;padding:0 15px;border-bottom:1px solid #e0e0e0;}
			.common-ul li .right{float:right;}
			.pb60{padding-bottom:65px;}
			.footer-div{display: block;position:fixed;bottom: 0px;width:100%;height:55px;border-top:1px solid #E2E2E2;background:#F6F6F6;font-size:14px;z-index: 999999;}
			.footer-div .wid{width:92%;line-height:36px;text-align:center;color:#ffffff;margin-top:10px;border-radius:2px;margin-left:4%;}
		</style>
	</head>
	<body class="common-iphone-szjc">
		<div class="common" style="margin-top:0;" onclick="displayDropDownMenu(this,'stage')">
			<span class="title">学段</span>
			<span class="stage name"><span id="j_stage_name"></span><i class="aui-iconfont aui-icon-unfold"></i></span>
		</div>
		<ul id="j_stage" class="common-ul display-none"></ul>
		<div class="common" onclick="displayDropDownMenu(this,'subject')">
			<span class="title">学科</span>
			<span class="subject name"><span id="j_subject_name"></span><i class="aui-iconfont aui-icon-unfold"></i></span>
		</div>
		<ul id="j_subject" class="common-ul display-none"></ul>
		<div class="common" id="banben" onclick="displayDropDownMenu(this,'version')">
			<span class="title">版本</span>
			<span class="version name"><span id="j_version_name"></span><i class="aui-iconfont aui-icon-unfold"></i></span>
		</div>
		<ul id="j_version" class="common-ul display-none"></ul>
		<div class="common" onclick="displayDropDownMenu(this,'scheme')">
			<span class="title">教材</span>
			<span class="scheme name"><span id="j_scheme_name"></span><i class="aui-iconfont aui-icon-unfold"></i></span>
		</div>
		<ul id="j_scheme" class="common-ul display-none pb60"></ul>
		<div class="footer-div">
			<div class="wid" onclick="saveSchemeProgress();">保存</div>
		</div>
	</body>
	<script type="text/javascript" src="../../../script/api.js"></script>
	<script type="text/javascript" src="../../../script/base_config.js"></script>
	<script type="text/javascript" src="../../../script/plug-in/base64.js" ></script>
	<script type="text/javascript" src="../../../script/common/common.js"></script>
	<script type="text/javascript">
		var BASE_URL_ACTION;
		var all_szjc_data={};//设置教材所需所有的变量以及学段、学科、版本以及教材的数据
		var lobal_variable;//全局变量
	    var stage_subject_data;//学段学科的数据
	    var volume_list;//教材的数据
	    var version_list = [];//版本数据
	    var subject_list = [];//学科数据
		apiready = function() {
			commonSetTheme({"level":3,"type":0});
			BASE_URL_ACTION = $api.getStorage('BASE_URL_ACTION');
			all_szjc_data.stage_id=0;//学段id
			all_szjc_data.stage_list=[];//所有学段
			lobal_variable = $api.strToJson(api.pageParam.lobal_variable);
	        showSelfProgress('加载中...');
	        getCrmStageSubject();
		};
		
	   /*
	    *author:zhaoj
	    *function:设置教材版本
	    *interface：申建
	    *date：20171013
	    */
	    function getCrmStageSubject(){
	    	var product_id='';
	    	if(BASE_CRM_TYPE){
	    		product_id = 'hjx';
	    	}else{
	    		product_id = 'ythxxpt';
	    	}
	        api.ajax({
	            url : BASE_URL_ACTION + '/ypt/getCrmStageSubject?random_num='+creatRandomNum()+'&&product_id='+product_id,
	            method : 'get',
	            timeout : 0,
	            dataType : 'json',
	            headers : {
	    'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
	        }, function(ret, err) {
	           if(err){
					popToast('获取教材信息失败，请稍候重试');
				}else{
					if(ret.success){
						stage_subject_data = ret;
						var flag_stage = true;
						for(var i = 0; i < ret.xd_subject_list.length; i ++){
	                        if(ret.xd_subject_list[i].xd_id == lobal_variable.stage_id){
	                        	subject_list = ret.xd_subject_list[i].subject_list;
	                            $api.text($api.byId('j_stage_name'),ret.xd_subject_list[i].xd_name);
	                            flag_stage = false;
	                            all_szjc_data.stage_id=lobal_variable.stage_id;
	                            changeSubject(lobal_variable.stage_id,0);
	                        }else{
	                            if(i == ret.xd_subject_list.length-1 && flag_stage){
	                            	api.hideProgress();
	                            	subject_list = ret.xd_subject_list[0].subject_list;
	                            	$api.text($api.byId('j_stage_name'),'请设置学段');
									$api.text($api.byId('j_subject_name'),'请先设置学段');
									$api.text($api.byId('j_version_name'),'请先设置学科');
									$api.text($api.byId('j_scheme_name'),'请先设置版本');
	                            }
	                        }
	                    }
	                    	all_szjc_data.stage_list = [];
							for(var i =0; i < ret.xd_subject_list.length; i++){
								var stage_oparam = new Object();
								stage_oparam.xd_name = ret.xd_subject_list[i].xd_name;
								stage_oparam.xd_id = ret.xd_subject_list[i].xd_id;
								all_szjc_data.stage_list.push(stage_oparam);
							}
								
					}else{
						$api.text($api.byId('j_stage_name'),'请设置学段');
						$api.text($api.byId('j_subject_name'),'请先设置学段');
						$api.text($api.byId('j_version_name'),'请先设置学科');
						$api.text($api.byId('j_scheme_name'),'请先设置版本');
					}
				}
	        });
	    }
		
		
		  /*
    *author:zhaoj
    *function:切换学科
    *param:type:0：初始化进入时；1：学段下拉框数据切换时
    *date：20171013
    */
    function changeSubject(stage_id,type){
        var index = 0;
        for(var i = 0; i < stage_subject_data.xd_subject_list.length; i ++){
            if(stage_subject_data.xd_subject_list[i].xd_id == stage_id){
                index = i;
                //设置选中的学段全局变量值
                lobal_variable.stage_id = stage_id;
                lobal_variable.stage_name = stage_subject_data.xd_subject_list[i].xd_name;
                
                var data = stage_subject_data.xd_subject_list[i].subject_list;
                if(data.length > 0){
                    //学科数量不为0
                    if(lobal_variable.subject_id == ''){
                        //学段下拉框数据切换时
                        lobal_variable.subject_id = data[0].subject_id;
                        lobal_variable.subject_name = data[0].subject_name;
                        $api.text($api.byId('j_subject_name'),data[0].subject_name);
                        getStandardSchemeBySubject(lobal_variable.subject_id,0);
                    }else{
                    	var flag_subject = true;
                        for(var j = 0; j < data.length; j++){
                            if(data[j].subject_id == lobal_variable.subject_id){
                               $api.text($api.byId('j_subject_name'),data[j].subject_name);
                               getStandardSchemeBySubject(lobal_variable.subject_id,0);
                               flag_subject = false;
                            }else{
                                if(j == data.length-1 && flag_subject){
	                            	$api.text($api.byId('j_subject_name'),'请设置学科');
									$api.text($api.byId('j_version_name'),'请先设置学科');
									$api.text($api.byId('j_scheme_name'),'请先设置版本');
									api.hideProgress();
	                            }
                            }
                        }
                    
                    } 
                }else{
                    //学科数量为0情况
                    api.hideProgress();
                   	$api.text($api.byId('j_subject_name'),'暂无学科');
					$api.text($api.byId('j_version_name'),'暂无版本');
					$api.text($api.byId('j_scheme_name'),'暂无教材');
	            }
	        }
	    }
	   }
		
		
	   /*
	    *author:zhaoj
	    *function:获取版本数据
	    *param:type:0：初始化进入时；1：学科下拉框数据切换时
	    *date：20171013
	    */
	    function getStandardSchemeBySubject(subject_id,type){
	    	api.ajax({
	            url : BASE_URL_ACTION + '/ypt/schemeCtl/getStandardSchemeBySubject?random_num='+creatRandomNum()+'&&subject_id='+subject_id,
	            method : 'get',
	            timeout : 0,
	            dataType : 'json',
	            headers : {
	    'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
	        }, function(ret, err) {
	            if(err){
	            	api.hideProgress();
	                popToast('获取版本失败，请稍候重试');
	            }else{
	                if(ret.success){
	                	api.hideProgress();
	                	if(ret.version_list.length > 0){
	                		 version_list = ret.version_list;
	                		//有版本的情况下
	                		if(lobal_variable.scheme_id == '' && type == 0){
		                        //学科下拉框数据切换时
		                        lobal_variable.scheme_id = ret.version_list[0].version_id;
		                        lobal_variable.scheme_name = ret.version_list[0].version_name;
		                        getVolumeByScheme(lobal_variable.scheme_id,0);
		                    }else{
		                    	var flag_scheme = true;
		                        for(var j = 0; j < ret.version_list.length; j++){
		                            if(ret.version_list[j].version_id == lobal_variable.scheme_id){
		                                $api.text($api.byId('j_version_name'),ret.version_list[j].version_name);
		                                getVolumeByScheme(lobal_variable.scheme_id,0);
		                               	flag_scheme = false;
		                            }else{
		                                if(j == ret.version_list.length-1 && flag_scheme){
											$api.text($api.byId('j_version_name'),'请设置版本');
											$api.text($api.byId('j_scheme_name'),'请先设置版本');
											api.hideProgress();
			                            }
		                            }
		                        }
		                    }
		                    if(type == 1){
		                    	setVersionLiHtml();
		                    }
		                }else{
		                	//没有版本的情况下
		                	api.hideProgress();
		                	$api.text($api.byId('j_version_name'),'暂无版本');
							$api.text($api.byId('j_scheme_name'),'暂无教材');
							$api.removeAttr($api.byId('banben'), 'onclick');
		                }
	                }else{
	                	api.hideProgress();
	                    popToast('获取版本学科失败，请稍候重试');
	                }
	            }
	        });
	    }
		
	   /*
	    *author:zhaoj
	    *function:获取教材数据
	    *param:type:0：初始化进入时；1：学科下拉框数据切换时
	    *date：20171013
	    */
	    function getVolumeByScheme(scheme_id,type){
	    	api.ajax({
	            url : BASE_URL_ACTION + '/ypt/bkCtl/getVolumeByScheme?random_num='+creatRandomNum()+'&scheme_id='+scheme_id,
	            method : 'get',
	            timeout : 0,
	            dataType : 'json',
	            headers : {
	    'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
	        }, function(ret, err) {
	        	api.hideProgress();
	            if(err){
	                popToast('获取教材失败，请稍候重试');
	            }else{
	                if(ret.success){
	                	if(ret.volume_list.length > 0){
	                		volume_list = ret.volume_list;
	                		//有教材的情况下
	                		if(lobal_variable.volume_id == '' && type == 0){
		                        //学科下拉框数据切换时
		                        lobal_variable.volume_id = ret.volume_list[0].structure_id;
		                        lobal_variable.volume_name = ret.volume_list[0].structure_name;
		                    }else{
		                    	var flag_volume = true;
		                        for(var j = 0; j < ret.volume_list.length; j++){
		                            if(ret.volume_list[j].structure_id == lobal_variable.volume_id){
		                                $api.text($api.byId('j_scheme_name'),ret.volume_list[j].structure_name);
		                                flag_volume = false;
		                            }else{
		                                if(j == ret.volume_list.length-1 && flag_volume){
			                            	$api.text($api.byId('j_scheme_name'),'请设置教材');
			                            	api.hideProgress();
			                            }
		                            }
		                        }
		                    
		                    }
		                    if(type == 1){
		                    	setSchemeLiHtml();
		                    }
		                }else{
		                	$api.text($api.byId('j_scheme_name'),'暂无教材');
		                	api.hideProgress();
		                }
	                }else{
	                    popToast('获取教材失败，请稍候重试');
	                }
	            }
	        });
	    }
		
		
		/*
		*author:zhaoj
		*function:展示或隐藏下拉菜单
		*date：20170328
		*/
		function displayDropDownMenu(self,id){
			//根据id名称来获取不同的数据
			switch(id) {
				case 'stage':
					setStageLiHtml();
					break;
				case 'subject':
					if(lobal_variable.stage_id == 0) return;
					setSubjectLiHtml();
					break;
				case 'version':
					if(lobal_variable.subject_id == 0) return;
					getStandardSchemeBySubject(lobal_variable.subject_id,1)
					break;
				case 'scheme':
					if(lobal_variable.scheme_id == 0) return;
					getVolumeByScheme(lobal_variable.scheme_id,1);
					break;
			}
			if($api.hasCls($api.byId('j_'+id), 'display-none')){
				$api.removeCls($api.byId('j_'+id), 'display-none');
				$api.removeCls($api.dom(self,'i'),'aui-icon-unfold');
				$api.addCls($api.dom(self,'i'),'aui-icon-fold');
			}else{
				$api.addCls($api.byId('j_'+id), 'display-none');
				$api.removeCls($api.dom(self,'i'),'aui-icon-fold');
				$api.addCls($api.dom(self,'i'),'aui-icon-unfold');
			}
		}

		/*
		*author:zhaoj
		*function:设置学段
		*date：20170328
		*/
		function setStageLiHtml(){
			var li_html="";
			for(var i = 0; i < all_szjc_data.stage_list.length; i++){
				var stage = all_szjc_data.stage_list[i];
				if(stage.xd_id == all_szjc_data.stage_id){
					all_szjc_data.stage_index = i;
					li_html += '<li onclick=selectStage(this,'+i+','+stage.xd_id+',"'+stage.xd_name+'")>'+stage.xd_name+'<i class="aui-iconfont aui-icon-check right"></i></li>';
				}else{
					li_html += '<li onclick=selectStage(this,'+i+','+stage.xd_id+',"'+stage.xd_name+'")>'+stage.xd_name+'</li>';
				}
			}
			$api.html($api.byId('j_stage'),li_html);
		}
		/*
		*author:zhaoj
		*function:设置学段
		*date：20170328
		*/
		function selectStage(self,index,stage_id,stage_name){
			if(lobal_variable.stage_id == stage_id){
			
			}else{
				$api.text($api.byId('j_subject_name'),'请设置学科');
				$api.text($api.byId('j_version_name'),'请先设置学科');
				$api.text($api.byId('j_scheme_name'),'请先设置版本');
				lobal_variable.subject_id = 0;
				lobal_variable.scheme_id = 0
				lobal_variable.volume_id = 0	
			}
			lobal_variable.stage_id = stage_id;
			all_szjc_data.stage_index = index;
			var li_array= $api.domAll($api.byId('j_stage'),'li');
			for(var i = 0; i < li_array.length; i++){
				var el = $api.dom(li_array[i], 'i');
				if(!isEmptyString(el)){
					el.parentNode.removeChild(el);
				}
			}
			$api.html(self,stage_name+'<i class="aui-iconfont aui-icon-check right"></i>');
			commonSet('stage',stage_name);
			commonSetDropDownHidden('subject');
			commonSetDropDownHidden('version');
			commonSetDropDownHidden('scheme');
			all_szjc_data.stage_id = stage_id;//学科id
		}
		/*
		*author:zhaoj
		*function:设置学段
		*date：20170328
		*/
		function setSubjectLiHtml(){
			var li_html="";
			for(var i = 0; i < stage_subject_data.xd_subject_list.length; i++){
				if(lobal_variable.stage_id == stage_subject_data.xd_subject_list[i].xd_id){
					subject_list = stage_subject_data.xd_subject_list[i].subject_list;
					for(var j=0;j<subject_list.length;j++){
						if(lobal_variable.subject_id == subject_list[j].subject_id){
							li_html += '<li onclick=selectSubject(this,'+subject_list[j].subject_id+',"'+Base64.encode(subject_list[j].subject_name)+'")>'+subject_list[j].subject_name+'<i class="aui-iconfont aui-icon-check right"></i></li>';
						}else{
							li_html += '<li onclick=selectSubject(this,'+subject_list[j].subject_id+',"'+Base64.encode(subject_list[j].subject_name)+'")>'+subject_list[j].subject_name+'</li>';
						}		
					}
				}
			}
			$api.html($api.byId('j_subject'),li_html);
		}
		/*
		*author:zhaoj
		*function:设置学科
		*date：20170328
		*/
		function selectSubject(self,subject_id,subject_name){
			if(lobal_variable.subject_id == subject_id){
			
			}else{
				$api.text($api.byId('j_version_name'),'请设置版本');
				$api.text($api.byId('j_scheme_name'),'请先设置版本');
				lobal_variable.scheme_id = 0
				lobal_variable.volume_id = 0	
			}
			lobal_variable.subject_id = subject_id;
			var li_array= $api.domAll($api.byId('j_subject'),'li');
			for(var i = 0; i < li_array.length; i++){
				var el = $api.dom(li_array[i], 'i');
				if(!isEmptyString(el)){
					el.parentNode.removeChild(el);
				}
			}
			$api.html(self,Base64.decode(subject_name)+'<i class="aui-iconfont aui-icon-check right"></i>');
			commonSet('subject',Base64.decode(subject_name));
			commonSetDropDownHidden('version');
			commonSetDropDownHidden('scheme');
			
		}
		/*
		*author:zhaoj
		*function:设置学段
		*date：20170328
		*/
		function setVersionLiHtml(){
			var li_html="";
			for(var i = 0; i <version_list.length; i++){
				if(version_list[i].version_id == lobal_variable.scheme_id){
					li_html += '<li onclick=selectVersion(this,'+version_list[i].version_id+',"'+Base64.encode(version_list[i].version_name)+'")>'+version_list[i].version_name+'<i class="aui-iconfont aui-icon-check right"></i></li>';
				}else{
					li_html += '<li onclick=selectVersion(this,'+version_list[i].version_id+',"'+Base64.encode(version_list[i].version_name)+'")>'+version_list[i].version_name+'</li>';
				}
			}
			$api.html($api.byId('j_version'),li_html);
		}
		/*
		*author:zhaoj
		*function:设置版本
		*date：20170328
		*/
		function selectVersion(self,version_id,version_name){
			if(lobal_variable.scheme_id == version_id){
				
			}else{
				$api.text($api.byId('j_scheme_name'),'请设置教材');
				lobal_variable.volume_id = 0;
			}
			lobal_variable.scheme_id = version_id
			var li_array= $api.domAll($api.byId('j_version'),'li');
			for(var i = 0; i < li_array.length; i++){
				var el = $api.dom(li_array[i], 'i');
				if(!isEmptyString(el)){
					el.parentNode.removeChild(el);
				}
			}
			$api.html(self,Base64.decode(version_name)+'<i class="aui-iconfont aui-icon-check right"></i>');
			commonSet('version',Base64.decode(version_name));
			commonSetDropDownHidden('scheme');
			
		}
		/*
		*author:zhaoj
		*function:设置教材
		*date：20170328
		*/
		function setSchemeLiHtml(){
			var li_html="";
			for(var i = 0; i < volume_list.length; i++){
				if(volume_list[i].structure_id == lobal_variable.volume_id){
					li_html += '<li onclick=selectScheme(this,'+volume_list[i].structure_id+',"'+Base64.encode(volume_list[i].structure_name)+'")>'+volume_list[i].structure_name+'<i class="aui-iconfont aui-icon-check right"></i></li>';
				}else{
					li_html += '<li onclick=selectScheme(this,'+volume_list[i].structure_id+',"'+Base64.encode(volume_list[i].structure_name)+'")>'+volume_list[i].structure_name+'</li>';
				}
			}
			$api.html($api.byId('j_scheme'),li_html);
		}
		/*
		*author:zhaoj
		*function:设置教材
		*date：20170328
		*/
		function selectScheme(self,scheme_id,scheme_name){
			lobal_variable.volume_id = scheme_id;
			var li_array= $api.domAll($api.byId('j_scheme'),'li');
			for(var i = 0; i < li_array.length; i++){
				var el = $api.dom(li_array[i], 'i');
				if(!isEmptyString(el)){
					el.parentNode.removeChild(el);
				}
			}
			$api.html(self,Base64.decode(scheme_name)+'<i class="aui-iconfont aui-icon-check right"></i>');
			commonSet('scheme',Base64.decode(scheme_name));
			all_szjc_data.scheme_id = scheme_id;//教材id
		}
		/*
		*author:zhaoj
		*function:统一设置
		*date：20170328
		*/
		function commonSet(id,name){
			$api.html($api.byId('j_'+id+'_name'),name);
			$api.addCls($api.byId('j_'+id), 'display-none');
			$api.removeCls($api.dom($api.byId('j_'+id+'_name').parentNode,'i'),'aui-icon-fold');
			$api.addCls($api.dom($api.byId('j_'+id+'_name').parentNode,'i'),'aui-icon-unfold');
		}
		/*
		*author:zhaoj
		*function:统一设置下拉列表隐藏
		*date：20170328
		*/
		function commonSetDropDownHidden(id){
			if(!$api.hasCls($api.byId('j_'+id), 'display-none')){
				$api.addCls($api.byId('j_'+id), 'display-none');
				$api.removeCls($api.dom(self,'i'),'aui-icon-fold');
				$api.addCls($api.dom(self,'i'),'aui-icon-unfold');
			}
		}
		
	   /*
		*author:zhaoj
		*function:保存教材设置
		*date：20171013
		*/
		function saveSchemeProgress(){
			if(lobal_variable.stage_id == 0){
				popToast('学段还未设置');
				return;
			}
			if(lobal_variable.subject_id == 0){
				popToast('学科还未设置');
				return;
			}
			if(lobal_variable.scheme_id == 0){
				popToast('版本还未设置');
				return;
			}
			if(lobal_variable.volume_id == 0){
				popToast('教材还未设置');
				return;
			}
			showSelfProgress('保存中...');
			api.ajax({
				url : BASE_URL_ACTION + '/ypt/space/course_package/save_scheme_progress',
				method : 'post',
				timeout : 0,
				dataType : 'json',
				data : {
					values : {
						"random_num" : creatRandomNum(),
						"identity_id" : $api.getStorage("identity"),
						"person_id" : $api.getStorage("person_id"),
						"scheme_id" : lobal_variable.scheme_id,
						"stage_id" : lobal_variable.stage_id,
						"subject_id" : lobal_variable.subject_id,
						"volume_id" : lobal_variable.volume_id,
					}
				},
				headers : {
		'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
			}, function(ret, err) {
				if(err){
					api.hideProgress();
					popAlert('保存失败，请稍候重试');
				}else{
					api.hideProgress();
					if(ret.success){
						api.hideProgress();
						popToast('保存成功');
						var winName = api.pageParam.winName;
						var frName  = api.pageParam.frameName;
						commonExecScript(winName,frName,'setTextbook("'+Base64.encode(JSON.stringify(lobal_variable))+'",1)',1);
						setTimeout(function(){
							api.execScript({
	                            name:'common_szjc_window',
	                            script: 'back();'
                            });
				        },200);
					}else{
						api.hideProgress();
						popAlert('保存失败，请稍候重试');
					}
				}
			});
		}
	</script>
</html>