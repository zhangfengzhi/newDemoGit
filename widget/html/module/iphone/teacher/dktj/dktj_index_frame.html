<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>打卡统计</title>
    <link rel="stylesheet" type="text/css" href="../../../../../css/aui_css_new/aui.css"/>
    <link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
    <style>
    	body{background:#F8F7F3;color:#000000;}
    	.content{height:55px;line-height:55px;padding:0 15px;}
    	.content div{display:inline-block;float:right;line-height:52px;color:#666666;}
    	.bb{border-bottom:1px solid #dfdfdf;}
    	.bt{border-top:1px solid #dfdfdf;}
    	.hr{height:10px;}
    	.bgf{background:#ffffff;}
    	.mb10{margin-bottom:10px;}
    	.person-list li{position:relative;padding:8px 15px;border-bottom:1px solid #dfdfdf;}
    	.person-list li img{position:absolute;left:15px;top:50%;display:inline-block;float:left;width:42px;height:42px;margin-top:-21px;border-radius: 50%;}
    	.person-list li .detail{padding-left:58px;color:#333333;}
    	.person-list li .detail .person-name{font-size:14px;}
    	.person-list li .detail .time span,.person-list li .detail .time div{display:inline-block;float:left;width:50%;font-size:12px;}
    	.person-list li .detail .time div{width:100%;}
    	.pt{padding-top:1px;}
    	.display-none{display:none;}
    	.no-data{line-height:55px;padding-top:0px;border-bottom:1px solid #dfdfdf;}
	</style>
</head>
<body class="common-iphone-dktj">
	<div class="content bb bgf mb10" onclick="selectTime();">
		选择日期
		<div id="start_time"></div>
	</div>
	<div id="dktj_body"></div>
	<script type="text/html" id="dktj_script">
		<!--未签人数-->
		<div class="content bt bb bgf" onclick="openPersonDetail('j_wqrs');">
			未签人数
			<div id="j_wqrs">
				<%=wdk_list.length%>人&nbsp;<i class="aui-iconfont aui-icon-unfold"></i>
			</div>
		</div>
		<ul id="j_wqrs_person" class="person-list bgf clearfix display-none">
			<%if(wdk_list.length == 0){%>
				<div class="no-data">暂无未签的人员</div>
			<%}else{%>
				<%for(var i = 0; i < wdk_list.length; i++){%>
					<li class="clearfix">
						<img onerror="this.src='../../../../../image/common/header.png'" src="<%=wdk_list[i].avatar_url%>" />
						<div class="detail">
							<div class="person-name ellipsis"><%=wdk_list[i].person_name%></div>
							<div class="time pt">
								<%for(var j = 0; j < wdk_list[i].kq_info.length; j++){%>
									<span><%=wdk_list[i].kq_info[j]%></span>
								<%}%>
							</div>
						</div>
					</li>
				<%}%>
			<%}%>
		</ul>
		<!--//未签人数-->
		<!--迟到人数-->
		<div class="content bb bgf" onclick="openPersonDetail('j_cdrs');">
			迟到人数
			<div id="j_cdrs">
				<%=cd_list.length%>人&nbsp;<i class="aui-iconfont aui-icon-unfold"></i>
			</div>
		</div>
		<ul id="j_cdrs_person" class="person-list bgf clearfix display-none">
			<%if(cd_list.length == 0){%>
				<div class="no-data">暂无迟到的人员</div>
			<%}else{%>
				<%for(var i = 0; i < cd_list.length; i++){%>
					<li class="clearfix">
						<img onerror="this.src='../../../../../image/common/header.png'" src="<%=cd_list[i].avatar_url%>" />
						<div class="detail">
							<div class="person-name ellipsis pt"><%=cd_list[i].person_name%></div>
							<div class="time pt">
								<%for(var j = 0; j < cd_list[i].cd_info.length; j++){%>
									<span><%=cd_list[i].cd_info[j].memo%>:<%=cd_list[i].cd_info[j].dksj%></span>
								<%}%>
							</div>
						</div>
					</li>
				<%}%>
			<%}%>
		</ul>
		<!--//迟到人数-->
		<!--请假人数-->
		<div class="content bb bgf" onclick="openPersonDetail('j_qjrs');">
			请假次数
			<div id="j_qjrs">
				<%=qj_list.length%>次&nbsp;<i class="aui-iconfont aui-icon-unfold"></i>
			</div>
		</div>
		<ul id="j_qjrs_person" class="person-list bgf clearfix display-none">
			<%if(qj_list.length == 0){%>
				<div class="no-data">暂无请假的人员</div>
			<%}else{%>
				<%for(var i = 0; i < qj_list.length; i++){%>
					<li class="clearfix">
						<img onerror="this.src='../../../../../image/common/header.png'" src="<%=qj_list[i].avatar_url%>" />
						<div class="detail">
							<div class="person-name ellipsis pt">[<%=qj_list[i].qj_type%>]&nbsp;<%=qj_list[i].person_name%></div>
							<div class="time pt">
								<div>开始时间：<%=qj_list[i].start_time.substring(0,16)%></div>
								<div>结束时间：<%=qj_list[i].end_time.substring(0,16)%><div>
							</div>
						</div>
					</li>
				<%}%>
			<%}%>
		</ul>
		<!--//请假人数-->
		<!--公出人数-->
		<div class="content bb bgf" onclick="openPersonDetail('j_gcrs');">
			公出次数
			<div id="j_gcrs">
				<%=wc_list.length%>次&nbsp;<i class="aui-iconfont aui-icon-unfold"></i>
			</div>
		</div>
		<ul id="j_gcrs_person" class="person-list bgf clearfix display-none">
			<%if(wc_list.length == 0){%>
				<div class="no-data">暂无公出的人员</div>
			<%}else{%>
				<%for(var i = 0; i < wc_list.length; i++){%>
					<li class="clearfix">
						<img onerror="this.src='../../../../../image/common/header.png'" src="<%=wc_list[i].avatar_url%>" />
						<div class="detail">
							<div class="person-name ellipsis pt">[<%=wc_list[i].wc_type%>]&nbsp;<%=wc_list[i].person_name%></div>
							<div class="time pt">
								<div>开始时间：<%=wc_list[i].start_time.substring(0,16)%></div>
								<div>结束时间：<%=wc_list[i].end_time.substring(0,16)%><div>
							</div>
						</div>
					</li>
				<%}%>
			<%}%>
		</ul>
		<!--//公出人数-->
		<!--早退人数-->
		<div class="content bb bgf <%if(!is_show_zt){%>display-none<%}%>" onclick="openPersonDetail('j_ztrs');">
			早退人数
			<div id="j_ztrs">
				<%=zt_list.length%>人&nbsp;<i class="aui-iconfont aui-icon-unfold"></i>
			</div>
		</div>
		<ul id="j_ztrs_person" class="person-list bgf clearfix display-none">
			<%if(zt_list.length == 0){%>
				<div class="no-data">暂无早退的人员</div>
			<%}else{%>
				<%for(var i = 0; i < zt_list.length; i++){%>
					<li class="clearfix">
						<img onerror="this.src='../../../../../image/common/header.png'" src="<%=zt_list[i].avatar_url%>" />
						<div class="detail">
							<div class="person-name ellipsis pt"><%=zt_list[i].person_name%></div>
							<div class="time pt">
								<%for(var j = 0; j < zt_list[i].zt_info.length; j++){%>
									<span><%=zt_list[i].zt_info[j].memo%>:<%=zt_list[i].zt_info[j].dksj%></span>
								<%}%>
							</div>
						</div>
					</li>
				<%}%>
			<%}%>
		</ul>
		<!--//早退人数-->
	</script>
</body>
<script type="text/javascript" src="../../../../../script/api.js"></script>
<script type="text/javascript" src="../../../../../script/base_config.js" ></script>
<script type="text/javascript" src="../../../../../script/plug-in/template.js" ></script>
<script type="text/javascript" src="../../../../../script/common/common.js"></script>
<script type="text/javascript">
	var nowData;//获取服务器的当前时间
	apiready = function(){
		commonSetTheme({"level":5,"type":0});
		commonGetCurrentDate(function(nowTime,nowMillisecond){
			var year = nowTime.getFullYear();
			var month = nowTime.getMonth()*1+1;
			month = month < 10 ? '0'+month : month;
			var day = nowTime.getDate();
			day = day < 10 ? '0'+day : day;
			nowData = year+'-'+month+'-'+day;
			setTime(nowData);//设置时间
			getDayClockInStatisticalInfo(nowData);
		});
	};
	/*
	*author:zhaoj
	*function:打开人员列表
	*date：20170215
	*/
	function openPersonDetail(id){
		if($api.hasCls($api.byId(id+'_person'), 'display-none')){
			$api.removeCls($api.dom($api.byId(id), 'i'), 'aui-icon-unfold');
			$api.addCls($api.dom($api.byId(id), 'i'), 'aui-icon-fold');
			$api.removeCls($api.byId(id+'_person'), 'display-none');
		}else{
			$api.removeCls($api.dom($api.byId(id), 'i'), 'aui-icon-fold');
			$api.addCls($api.dom($api.byId(id), 'i'), 'aui-icon-unfold');
			$api.addCls($api.byId(id+'_person'), 'display-none');
		}
	}
	/*
	*author:zhaoj
	*function:设置时间
	*date：20170215
	*/
	function setTime(time){
		$api.html($api.byId('start_time'), time+'<i class="aui-iconfont aui-icon-right"></i>');
	}
	/*
	*author:zhaoj
	*function:选择时间
	*date：20170215
	*/
	function selectTime(){
		var time = $api.text($api.byId('start_time'));
		api.openPicker({
	        type: 'date',
			date: time,
	        title:'选择时间'
	    },function(ret,err){
			if(err){
				popToast('网络繁忙，请稍候重试');
			}else if(ret){
				var year = ret.year;
		        var month = ret.month;
				month = month > 9 ? month : '0'+month;
		        var day = ret.day;
				day = day > 9 ? day : '0'+day;
		        //这是选择的是日期
				var value=year+'-'+month+'-'+day;
				if(Date.parse(value.replace(/-/g,'\/')) <= Date.parse(nowData.replace(/-/g,'\/'))){
					setTime(value);
					getDayClockInStatisticalInfo(value);
				}else{
					popToast('不支持未来日期，请重新选择');
				}
			}
	    });
	}
	/*
	*author:zhaoj
	*function:获取详细数据
	*date：20170216
	*/
	function getDayClockInStatisticalInfo(data){
		showSelfProgress('加载中...');
		api.ajax({
			url : BASE_URL_ACTION + '/leave/getDayClockInStatisticalInfo?bureau_id='+$api.getStorage("bureau_id")+'&date='+data+'&random_num='+creatRandomNum(),
			method : 'get',
			timeout : 0,
			dataType : 'json',
			headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
			}, function(ret, err) {
				api.hideProgress();
				if (err) {
					popToast('获取打卡统计失败，请稍候重试');
				} else {
					if(ret){
						//未签到
						ret.wdk_list = getPersonHeaderImg(ret.wdk_list);
						//请假
						ret.qj_list = getPersonHeaderImg(ret.qj_list);
						//外出
						ret.wc_list = getPersonHeaderImg(ret.wc_list);
						//早退
						ret.zt_list = getPersonHeaderImg(ret.zt_list);
						//迟到
						ret.cd_list = getPersonHeaderImg(ret.cd_list);
						//如果是鄂托克前旗教育云平台，不显示早退
						if($api.getStorage('bureau_id') == '300372'){
							ret.is_show_zt = 0;
						}else{
							ret.is_show_zt = 1;
						}
						commonAddOnceHtml('dktj_body','dktj_script',ret);
					}else{
						popToast('获取打卡统计失败，请稍候重试');
					}
				}
		});
	}
	/*
	*author:zhaoj
	*function:获取头像
	*date：20170216
	*/
	function getPersonHeaderImg(data){
		//早退
		for(var i = 0; i < data.length; i++){
			var img_url;
			if(BASE_APP_TYPE == 1){
				img_url = BASE_IMAGE_PRE + url_path_suffix+ data[i].avatar_file_id.substring(0, 2) + "/" + data[i].avatar_file_id + commonReturnPhotoCutSize(0);
			}else{
				img_url = BASE_URL_ACTION + BASE_IMAGE_BEGIN + data[i].avatar_file_id.substring(0, 2) + "/" + data[i].avatar_file_id + commonReturnPhotoCutSize(0);
			}
			data[i].avatar_url=img_url;
		}
		return data;
	}
</script>
</html>