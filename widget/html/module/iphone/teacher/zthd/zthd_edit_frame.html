<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>主题活动</title>
    <link rel="stylesheet" type="text/css" href="../../../../../css/aui/aui.css"/>
    <link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
    <style>
    	body{color:#595757;font-size:14px;}
    	.content{position:relative;padding:10px 10px;width: 100%;}
    	.content .name{position:absolute;left:9px;top:50%;margin-top:-10px;padding-left:20px;background:url(../../../../../image/fun-module/ipad/zthd/star.png) 0 -1px no-repeat;background-size:18px auto;z-index:1;font-size:16px;}
    	.content .name-hdfm{position:absolute;left:9px;top:50%;margin-top:-10px;padding-left:20px;background:url(../../../../../image/fun-module/ipad/zthd/star.png) 0 5px no-repeat;background-size:18px auto;z-index:1;font-size:16px;}
    	.content .no-bg{background:none;}
    	.input-box{padding-left:100px}
    	input[type="text"],textarea,select{margin-bottom:0;}
    	input[type="text"],textarea{float:left;}
    	.wid50{width:50%;}
    	.content .top-show{top:25px;}
    	.down-show,.select-show{position:relative;padding-top:43px;}
    	.down-show .left{float:left;padding-left:25px;width:75%;padding-top:20px;}
    	.down-show .right{background:url(../../../../../image/fun-module/ipad/zthd/zthd.png) 0 0 no-repeat;background-size:100% 100%;width: 31%;height:100%;position: absolute;top:0;right:0;text-align:center;vertical-align:middle;visibility:visible;}
    	.down-show .left .select-img-btn{font-size:14px;width:198px;border:1px dashed rgba(0, 0, 0, 0.2);line-height:35px;text-align:center;}
    	.down-show .left .tip-infor{width:100%;font-size:14px;color:#f00;padding-top:5px;}
    	.down-show .left .tip-infor div{padding-top:10px;}
    	.down-show .right img{width:100%;height:100%;}
    	.down-show .right-div{position: absolute;width: 100%;background: #000;height: 100%;opacity: 0.5;}
    	.down-show .right-span{position: absolute;display: block;width: 100%;top: 50%;margin-top: -10px;color: #fff;}
    	.down-show .right .mr-img{position:absolute;top:5px;right:0;width:25%;height:85%;line-height:85%;z-index:1;background:rgba(0,0,0,0.5);color:#fff;text-align:center;padding-top:9%}
    	.resource-content{position:relative;width:100%}
    	.pl370{padding-left:10px;}
    	.pl370 .name{left:10px;}
    	.add-fj{position:relative;display:inline-block;padding:0 20px 0 35px;background:url(../../../../../image/fun-module/ipad/zthd/qbz.png) 10px 0 no-repeat;background-size:17px auto;border-left:1px solid #595757;}
    	.triangle-top{position:absolute;right:0;top:5px;display:inline-block;width: 0; height: 0;border-left: 7px solid transparent;border-right: 7px solid transparent;}
    	.down-show ul li{width:100%;float:left;margin-bottom:10px;}
    	.down-show ul li:nth-child(odd){padding-left:10px;}
    	.down-show ul li:nth-child(even){padding-left:10px;}
    	.down-show ul li .fj-detail{position:relative;display:inline-block;padding:0 37px;max-width:100%;width:100%;line-height:38px;background:#E0F2FC url(../../../../../image/fun-module/ipad/zthd/fj-qbz.png) 9px 10px no-repeat;background-size:17px auto;}
    	.down-show ul li .fj-detail .delete{position:absolute;right:0;top:0;width:30px;height:38px;background:url(../../../../../image/fun-module/common/dm_close.png) center center no-repeat;background-size:13px auto;}
    	.cyqx{display:inline-block;width:120px;border-left:1px solid #595757;color:#595757;padding-left:8px;position:relative;}
    	.cyqx select{width:150px;float:right;height:34px;padding:7px 0;margin-right:0px;border-radius:0;margin-top:-7px;position:absolute;top:-15px;left:0;}
    	.select-down{width:18px;height:34px;position:absolute;top:-22px;right:-30px;}
    	.select-down .triangle-top{border-top: 5px solid #fff;top:15px;right:3px;border-right: 5px solid transparent;border-left: 5px solid transparent;}
    	.select-person{position:relative;padding:10px 0 10px 60px;}
    	.select-person .per-name{position:absolute;left:0;line-height:50px;padding-left:20px;}
    	.select-show ul li{display:inline-block;padding: 5px 10px 4px 10px;margin:7px 10px 0 0;background:#EEEEEE;line-height:26px;}
    	.select-show ul li.active{color:#fff;}
    	.btn{text-align:center;padding:20px 0;}
    	.btn button{width:200px;color:#fff;font-size:18px;padding:8px 12px;}
    	.role{float:right;padding-top:10px;}
    	.role div{display:inline-block;height:35px;line-height:35px;padding: 0 15px;margin-right:10px;background:#EEEEEE;}
    	.role div.active{color:#fff;}
    	.t20{top:20px !important;}
    	.m-height{min-height:60px;}
    	.input-box-jieshao{padding-left:25px;}
    	.edit-select-picture{display:inline-block;width:80px;height:30px;line-height:30px;border:1px solid #ddd;text-align:center;margin-left:10px;}
    	.canyu-quanxian{position:relative;display:inline-block;padding:0 20px 0 8px;border-left:1px solid #595757;}
    	.select-duixiang{float:right}
    	.down-show .right-old{float:right;width:25%;margin-top:-5px;height:85%;border:1px solid #FFFFFF}
    	.down-show .right-old img{width:100%;height:100%;max-height:70px}
    	.ptt0{padding-top:0;}
    	.tip{margin-left:30px; color:#f00;margin-top:8px;}
    	.tip2{font-size:14px; color:#f00;margin-top:10px;margin-bottom:10px;}
    	.fengmian .left{padding-left:19px;}
    	.foot_div {
			display: block;
			bottom: 0px;
			width: 100%;
			min-width: 200px;
			line-height: 30px;
			text-align: right;
			color: #fff;
			background: #ffffff;
			padding: 10px 10px;
			border-top: 1px solid #EDEDED;
			/*position: fixed;*/
		}
    </style>
</head>
<body class="common-iphone-zthd-tea">
	<div id="add-div" style="overflow: scroll">
		<div class="clearfix">
			<div class="content fl">
				<div class="name">活动名称</div></br>
			</div>
		</div>
		<div class="content ptt0">
			<div class="input-box-jieshao clearfix">
				<input oninput="commonRemoveExpression(this)" id="name" disabled="true" type="text" maxlength="40" placeholder="40字符以内" style="height:40px;color:#ddd"/>
			</div>
		</div>
		<div class="clearfix">
			<div class="content fl">
				<div class="name">活动介绍</div></br>
			</div>
		</div>
		<div class="content ptt0" style="margin-bottom:10px;">
			<div class="input-box-jieshao clearfix">
				<!--<textarea id="remarks" placeholder="活动介绍，最多支持200字符（必填）"  maxlength ='200' style=""></textarea>-->
				<textarea id="remarks" maxlength ='200' style="overflow-y: visible" onpropertychange="this.style.posHeight = this.scrollHeight" placeholder="活动介绍，最多支持200字符（必填）"></textarea>
			</div>
		</div>
		<!--<div class="clearfix" style="margin-bottom:10px;">
			<div class="content">
				<div class="name">活动日期</div>
			</div> 
			<div id="time-tip" class="tip aui-hide">注：仅支持修改结束日期！</div>
		</div>
		<div class="content wid50 fl ptt0">
			<div id="j_time_0_div" class="input-box-jieshao clearfix" onclick="openTime(0);">
				<input oninput="commonRemoveExpression(this)" id="j_time_0" type="text" placeholder="开始日期（必填）" disabled="true" style="height:40px;padding-left:10px;"/>
			</div>
		</div>
		<div class="content wid50 fl ptt0">
			<div style="position:absolute;left:0;top:50%;margin-top:-10px;padding-left:5px;">至</div>
			<div class="input-box-jieshao clearfix" onclick="openTime(1);">
				<input oninput="commonRemoveExpression(this)" id="j_time_1" type="text"  placeholder="结束日期（必填）" disabled="true" style="color:#595757;height:40px;padding-left:10px;"/>
			</div>
		</div>-->
		
		<div class="clearfix">
			<div class="content fl">
				<div class="name">活动地点</div></br>
			</div>
		</div>
		<div class="content ptt0">
			<div class="input-box-jieshao clearfix">
				<textarea id="address" placeholder="活动地点，最多支持20字符（必填）"  maxlength ='20' style=""></textarea>
			</div>
		</div>
		<div class="resource-content fl clearfix">
			<div >
				<div class="content">
					<div class="name-hdfm top-show">活动封面<div class="edit-select-picture"  onclick="openUploadZthd();">选择图片</div></div>
					<div class="down-show fengmian clearfix" style="padding-top:10px">
						<div class="left">
							<div class="tip-infor">
								<div>&nbsp;</div>
							</div>
						</div>
						<div id="right" class="right">
						<div  class="right-div"></div>
						<span  class="right-span" id="j_cover_url" fileID="zthd.png">默认封面</span>
							<!--<div id="j_mr_cover" class="mr-img">默认封面</div>-->
						</div>
					</div>
				</div>
			</div>
			<div class="content pl370">
				<div class="name top-show">
					活动附件&nbsp;
					<span class="add-fj" onclick="uploadFj();">添加附件 <div class="triangle-top">&nbsp;</div></span>
				</div>
				<div class="down-show clearfix">
					<div  id="j_fj_no_data" class="left" style="padding-top:0;width:80%;">
						<div class="tip-infor">
							<div id="no-fujian-div"><font id="no-fujian" style="font-size:16px;color:#B5B5B5">暂无附件&nbsp;</font></div>
						</div>
					</div>
					<ul id="j_attachment" class="aui-hide ptt0">
						
					</ul>
				</div>
			</div>
		</div>
		<div id="foot_div" class="foot_div">
	        <button class="aui-btn aui-btn-info" onclick="getTopicParam('save',false);">
	          	  保存
	        </button>
	        &nbsp;&nbsp;
	        <button id="saveAndFbBtn" class="aui-btn aui-btn-info" onclick="getTopicParam('saveAndFb',false);">
	        	保存并发布
	        </button>
	    </div>
	</div>
</body>
<script type="text/javascript" src="../../../../../script/api.js"></script>
<script type="text/javascript" src="../../../../../script/base_config.js" ></script>
<script type="text/javascript" src="../../../../../script/plug-in/template.js" ></script>
<script type="text/javascript" src="../../../../../script/common/common.js"></script>
<script type="text/javascript" src="../../../../../script/assembly/openPicker.js"></script>
<script type="text/javascript" src="../../../../../script/assembly/UIAlbumBrowser2.js"></script>
<script type="text/javascript" src="../../../../../script/assembly/getPicture.js"></script>
<script type="text/javascript" src="../../../../../script/assembly/photoBrowser.js"></script>
<script type="text/javascript" src="../../../../../script/plug-in/base64.js" ></script>
<script type="text/javascript" src="../../../../../script/assembly/executeApp.js" ></script>
<script type="text/javascript" src="../../../../../script/assembly/openResource.js" ></script>
<script type="text/javascript" src="../../../../../script/module/common/fileUpload.js" ></script>
<script type="text/javascript" src="../../../../../script/module/iphone/common/zthd/zthd.js" ></script>
<script type="text/javascript">
	var object_json="";//选择对象的json数据
	var lobal_variable={};//全局变量json
	var oparam;
	var release_org;//参与对象
	var data={'group_list':[],'class_list':[]};
	var first_check_time = false;
	var time_end;
	var header_h;
	apiready = function(){
		commonSetTheme({"level":5,"type":0});
		commonIosAuiHeader();//定位header位置，留出上面电池等空隙，苹果需要
		header_h = api.pageParam.header_h;
		oparam = JSON.parse(Base64.decode(api.pageParam.oparam_base64));
		if (api.pageParam.is_publish == 1){
			$api.removeCls($api.byId('time-tip'), 'aui-hide');
			$api.css($api.byId('j_time_0'), 'color:#ddd');
			$api.removeAttr($api.byId('j_time_0_div'), 'onclick');
			$api.addCls($api.byId('saveAndFbBtn'), 'aui-hide');
		}
		get_topic_by_id();
	};
	/*
	*author:zhaoj
	*function:活动日期选择
	*param:type=0:活动开始日期；type=1：活动结束日期（必填）；
	*date：201701019
	*/
	function openTime(type){
		var now_time = $api.val($api.byId('j_time_'+type));
		if(type){
			setTime(type,now_time);
		}else{
			getCurrentData(function(time){
		   		lobal_variable.now_time = time;
		   		if (now_time){
		   			setTime(type,now_time);
		   		}else{
		     		setTime(type,time);
		     	}
			});
		}
	}
	/*
	*author:zhaoj
	*function:获取当前服务器时间
	*date：201701019
	*/
	function setTime(type,nowTime){
		openPicker.open({"type":0,"time":nowTime},function(time){
			if(type){
				if (api.pageParam.is_publish == 1){
					if(Date.parse(time_end.replace(/-/g,'\/'))>Date.parse(time.replace(/-/g,'\/'))){
						popAlert('结束日期不能小于"'+ time_end +'"！');
						return;
					}
				}
				
				//结束日期
				if(Date.parse($api.val($api.byId('j_time_0')).replace(/-/g,'\/'))<=Date.parse(time.replace(/-/g,'\/'))){
					$api.val($api.byId('j_time_'+type), time);
				}else{
					if($api.val($api.byId('j_time_0')) == '' || typeof($api.val($api.byId('j_time_0'))) == undefined || $api.val($api.byId('j_time_0')) == null){
                        popAlert('请先选择开始日期！');
                    }else{
                        popAlert('结束日期不能小于开始日期！');
                    }
				}
			}else{
				//开始日期
				if(first_check_time){//第一次选择开始日期
					first_check_time = false;
					if(Date.parse(lobal_variable.now_time.substring(0,10).replace(/-/g,'\/'))<=Date.parse(time.replace(/-/g,'\/'))){
	                    $api.val($api.byId('j_time_'+type), time);
	                }else{
	                    popAlert('不能是过去日期，请重新选择！');
	                }
				}else{//非第一次选择开始日期
					var falg_old_time = false;//结束日期小于开始日期
					var falg_less_time = false;//开始日期是过去的时间
					falg_old_time = Date.parse(time.replace(/-/g,'\/'))<=Date.parse($api.val($api.byId('j_time_1')).replace(/-/g,'\/'));
					falg_less_time = Date.parse(lobal_variable.now_time.substring(0,10).replace(/-/g,'\/'))<=Date.parse(time.replace(/-/g,'\/'));
					if($api.val($api.byId('j_time_1')) == '' && falg_less_time){
					   falg_old_time = falg_less_time = true;
					}
					if(falg_old_time && falg_less_time){
	                    $api.val($api.byId('j_time_'+type), time);
	                }else{
	                	if(falg_old_time == false && $api.val($api.byId('j_time_1')) != ''){
	                		popAlert('结束日期不能小于开始日期！');
	                    	return;	
	                	}else{
	                		popAlert('不能是过去日期，请重新选择！');
							return;	
	                	}

	                }
				}
			}
		});
	}
	/*
	*author:zhaoj
	*function:获取当前服务器时间
	*date：201701019
	*/
	function getCurrentData(callback){
		commonGetCurrentDate(function(nowTime,nowMillisecond){
			var year = nowTime.getFullYear();    //获取完整的年份(4位,1970-????)
			var month = nowTime.getMonth()*1+1;       //获取当前月份(0-11,0代表1月)
			month = month < 10?'0'+month:month;
			var day = nowTime.getDate();        //获取当前日(1-31)
			day = day < 10?'0'+day:day;
			var hour = nowTime.getHours();       //获取当前小时数(0-23)
			hour = hour < 10?'0'+hour:hour;
			var minutes = nowTime.getMinutes();     //获取当前分钟数(0-59)
			minutes = minutes < 10?'0'+minutes:minutes;
			var time = year+'-'+month+'-'+day+' '+hour+':'+minutes;
			callback(time);
		});
	}
	/*
    *author:zhaoj
    *function:选择图片
    *date：20171019
    */
    function getAlbum() {
		UIAlbumBrowser.open({"max":1},function(data){
			if(api.systemType == "ios"){
                 UIAlbumBrowser.transPath(data[0].path,function(pic_url_new){
                     openImageClipFrame(pic_url_new);
                 });
            }else{
                 openImageClipFrame(data[0].path);
            }
		});
    }
    /*
    *author:zhaoj
    *function:打开拍照
    *date：20170914
    */
    function openPicture(){
    	getPicture.open({},function(data){
    		openImageClipFrame(data);
    	});
    }
    /*
    *author:zhaoj
    *function:打开才将
    *date：20171020
    */
    function openImageClipFrame(img_url){
    	commonExecScript(api.winName,'','reBackType("imageClip");',0);
    	var param = {"img_url":img_url,"frameName":api.frameName,"winName":api.winName,"backFun":"getClipImageUrl","type":1};
    	commonOpenImageClipFrame(param);
    }
    /*
    *author:zhaoj
    *function:获取裁剪后的图片路径
    *date：20171020
    */
    function getClipImageUrl(img_url){
      	commonUiUploadFiles({"data":[{"path":img_url,"thumbPath":img_url,"size":0}],"is_trans":0}, function(ret_data) {
        	for(var i = 0; i < ret_data.length; i++){
        		var json_data = JSON.parse(ret_data[i]);
        		var file_id = json_data.file_id;
				var ext = json_data.ext;
				var param_json = getParamJson({"file_id" : file_id,"file_name" : json_data.file_name,"resource_format" : ext, "is_show_tip":0,"type":0,"voice_duration":0});
				showCover(param_json);
				commonExecScript(api.winName,'','back();',0);
        	}
        });
    }
    /**
     * 递归上传图片
     * 赵静
     * param:type=0:活动封面；type=1:附件；
     * 2017.09.14
     */
    function dgUploadFiles(p_c, pic_list,type, callback) {
        var pic_l = getJsonObjLength(pic_list);
        if (p_c < pic_l) {
            var pic_url_old = pic_list[p_c].path;
            if (api.systemType == 'ios') {
                //将相册图片地址转换为可以直接使用的本地路径地址
                UIAlbumBrowser.transPath(pic_url_old,function(pic_url_new){
                    commonUploadFiles(pic_url_new, function(is_true, a_file_id, a_ext) {
                        if (is_true) {
                            var param_json = {"file_id" : a_file_id,"ext" : a_ext};
                            type?showPicture(param_json):showCover(param_json);
                            p_c++;
                            return dgUploadFiles(p_c, pic_list,type, callback);
                        } else {
                            return dgUploadFiles(p_c, pic_list,type, callback);
                        }
                    });
                });
            } else {
                commonUploadFiles(pic_url_old, function(is_true, a_file_id, a_ext) {
                    if (is_true) {
                        var param_json = {"file_id" : a_file_id,"ext" : a_ext};
                        type?showPicture(param_json):showCover(param_json);
                        p_c++;
                        return dgUploadFiles(p_c, pic_list,type, callback);
                    } else {
                        return dgUploadFiles(p_c, pic_list,type, callback);
                    }
                });
            }
        } else {
            callback(true);
        }
    }
    /*
    *author:zhaoj
    *function:显示活动封面
    *date：20171019
    */
    function showCover(param_json){
    	var img_url='';//图片路径
    	var fileID = '';
    	if (param_json.resource_format){
    		if (BASE_APP_TYPE == 1) {
				img_url = BASE_IMAGE_PRE+"down/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.resource_format + commonReturnPhotoCutSize(0);		
			} else {
				img_url = BASE_URL_ACTION + "/html/thumb/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.resource_format + commonReturnPhotoCutSize(0);
			}
			
			fileID = param_json.file_id + '.' + param_json.resource_format;
    	}else{
    		if (BASE_APP_TYPE == 1) {
				img_url = BASE_IMAGE_PRE+"down/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + commonReturnPhotoCutSize(0);		
			} else {
				img_url = BASE_URL_ACTION + "/html/thumb/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + commonReturnPhotoCutSize(0);
			}
			
			fileID = param_json.file_id;
    	}
    	
		img_url = '<img id="j_cover_url" src="'+img_url+'" fileID="'+fileID+'" onerror="this.src=../../../../../image/fun-module/ipad/zthd/zthd.png" onclick="displayImg(this);"/>'
		$api.removeCls($api.byId('right'),'right');
		$api.html($api.byId('right'),img_url);
		$api.addCls($api.byId('right'), 'right-old');
		setTimeout(function(){
			$api.addCls($api.byId('right'), 'right-old');
		},300);
		commonAddOrRemoveHideCss('j_mr_cover',0);
    }
    /*
    *author:zhaoj
    *function:将封面图片放大
    *date：20171019
    */
    function displayImg(self){
    	var openImgArray=[$api.attr(self, 'src')];
		//打开图片
		openPictureShowWin(openImgArray,0);
    }
    /*
    *author:zhaoj
    *function:设置参与权限
    *date：20171019
    */
    function changeCyqx(type){
    	p_object = type;
    	switch(type*1){
    		case 0:
    			//公开
    			lobal_variable.p_object =1;
    			commonAddOrRemoveHideCss('j_xzdx',0);
    			break;
    		case 1:
    			//指定参与对象
    			lobal_variable.p_object =4;
    			commonAddOrRemoveHideCss('j_xzdx',1);
    			getClassByteacherid();
    			break;
    		case 2:
    			//全部教师
    			lobal_variable.p_object =2;
    			commonAddOrRemoveHideCss('j_xzdx',0);
    			break;
    		case 3:
    			//全部学生
    			lobal_variable.p_object =3;
    			commonAddOrRemoveHideCss('j_xzdx',0);
    			break;
    	}
    }
    
    /*
     * 功能：上传图片
     * 作者：张自强
     * 时间：201710232
     */
    function openUploadZthd(){
    	open_type = 0;
    	var param_json={
    	   count:1
    	}
    	common_wmMediaResourcesTool.openPhoto(param_json,function(flag,data_arr){
           if(flag){
               openImageClipFrame(data_arr[0].path);
           }
        })
        return;
		var  buttons = ['图片','拍照'];
		commonOpenActionSheet('','取消', '', buttons, function(index){
			if(index == 1){
	         	getAlbum();//从相册中上传
	         }
	         if(index == 2){
	         	openPicture();//从相机中上传
	         }
		});
	}
	
	/*
	 * 功能：通过教师id和身份获取所任教班级
	 * 作者:张自强
	 * 时间：20171024
	 */
	function getClassByteacherid(){
		showSelfProgress('加载中...');
		api.ajax({
	    	url : BASE_URL_ACTION+'/ypt/space/topic/get_class_byteacherid?random_num='+creatRandomNum()+'&person_id='+$api.getStorage("person_id")+'&identity_id='+$api.getStorage("identity"),
			method : 'get',
			timeout : 30,
			dataType : 'json',
			headers : {
				'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
			}
        },function(ret,err){
        	if(err){
        		api.hideProgress();
        		popToast('获取任教班级信息失败，请稍候重试');
        	}else{
        		if(ret.success){
        			data.class_list = ret.list.length;
        			for(var i =0; i < ret.list.length; i++){
        				ret.list[i].is_group = 0;
        			}
        			get_group_bypersonid(ret);
        		}else{
        			api.hideProgress();
        			popToast('获取任教班级信息失败，请稍候重试');
        		}
        	}
        });
	}
	
	 /*
    *author:zhaoj
    *function:通过person_id和身份id 获取所在的群组
    *interface:张海
    *date：20171023
    */
    function get_group_bypersonid(data){
    	api.ajax({
	    	url : BASE_URL_ACTION+'/ypt/space/topic/get_group_bypersonid?random_num='+creatRandomNum()+'&person_id='+$api.getStorage("person_id")+'&identity_id='+$api.getStorage("identity"),
			method : 'get',
			timeout : 30,
			dataType : 'json',
			headers : {
				'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
			}
        },function(ret,err){
        	if(err){
        		popToast('获取群组信息失败，请稍候重试');
        	}else{
        		if(ret.success){
        		  data.group_list = ret.list.length;
        			for(var i =0; i < ret.list.length; i++){
        				ret.list[i].is_group = 1;
        				ret.list[i].org_level = 106;
        				ret.list[i].org_name = ret.list[i].group_name;
        				ret.list[i].org_id = ret.list[i].group_id;;
        				data.list.push(ret.list[i]);
        			}
        		}else{
        			popToast('获取群组信息失败，请稍候重试');
        		}
        	}
        	api.hideProgress();
        	object_json= data;
//      	commonAddOnceHtml('j_select_object','select_object_script',data);
//      	commonAddOnceHtml('j_select_object_qz','select_object_script_qz',data);
//      	if(data.group_list == 0){
//      		commonAddOrRemoveHideCss('qunzu',0);
//      	}
//			commonAddOrRemoveHideCss('j_xzdx',1);
//			if(lobal_variable.p_object == 4 && release_org){
//				var show_org_id="";
//				for(var i = 0; i < release_org.length; i++){
//					//角色分割
//					var role_array = release_org[i].r_identity_id.split(',');
//					if(release_org[i].org_type == 106){
//                      //设置选中对象选中样式
//                      $api.addCls($api.byId('j_'+release_org[i].org_id), 'active');
////						$api.removeAttr($api.byId('j_'+release_org[i].org_id), 'onclick');
//					}
//					if(release_org[i].org_type == 105){
//						//选中选中对象的角色的样式
//						for(var j = 0; j < role_array.length;j++){
//							$api.addCls($api.byId('j_'+release_org[i].org_id+'_'+role_array[j]), 'active');
////							$api.removeAttr($api.byId('j_'+release_org[i].org_id+'_'+role_array[j]), 'onclick');
//						}
//					}
//				}
//			}
        });
    }
	
	
	/*
	 * 功能：选择发布范围（学生或教师或学生和教师）
	 * 作者：张自强
	 * 时间：20171024
	 */
	function selectStuOrTea(type,e){
		if($api.hasCls(e, 'active')){
			$api.removeCls(e, 'active');
			identity_sum=identity_sum-type;
		}else{
			$api.addCls(e, 'active');
			identity_sum=identity_sum+type;
		}	
	}
	
	 /*
    *author:zhaoj
    *function:获取保存主题活动所有参数数值
    *date：20171023
    */
  	/*
    *author:zhaoj
    *function:获取保存主题活动所有参数数值
    *date：20171023
    */
    function getTopicParam(type,isOnlyShowOfPartaker){
		var isSave = true;
   		if (type !== 'save' && type != 'saveAndFb'){
   			lobal_variable = $api.getStorage('zthd_lobal_variable');
   			isSave = false;
   		}else{
   			delete lobal_variable.release_org
   		}
    	
    	lobal_variable.name = $api.val($api.byId('name'));
    	if($api.trimAll(lobal_variable.name).length == 0){
    		popToast('活动名称不能为空');
    		return;
    	}
    	lobal_variable.remarks = $api.val($api.byId('remarks'));
    	if($api.trimAll(lobal_variable.remarks).length == 0){
    		popToast('活动介绍不能为空');
    		return;
    	}
    	
    	lobal_variable.address = $api.val($api.byId('address'));
    	if($api.trimAll(lobal_variable.address).length == 0){
    		popToast('活动地点不能为空');
    		return;
    	}
    	//活动封面
    	lobal_variable.thumb_id ='';
    	lobal_variable.thumb_id = $api.attr($api.byId('j_cover_url'),'fileID');
    	if(lobal_variable.thumb_id == 'zthd.png'){
    		lobal_variable.thumb_id="";
    	}
    	//活动附件
    	lobal_variable.attachment=[];
    	var li_array = $api.domAll($api.byId('j_attachment'), 'li');
    	for(var i = 0; i < li_array.length; i++){
    	    var oparam = new Object();
    	    oparam.res_id=$api.attr(li_array[i], 'attachment');
    		lobal_variable.attachment.push(oparam);
    	}
    	
    	if (type == 'saveAndFb'){
    		setTimeout(function (){
    			saveAndFb();
    		},200);
    	}
    	else{
    		update_topic(isSave,isOnlyShowOfPartaker);
    	}	
    }

	  /*
    *author:zhaoj
    *function:保存主题活动接口
    *interface:张海
    *date：20171023
    */
    function update_topic(isSave,isOnlyShowOfPartaker){
   		if (isSave){
			showSelfProgress('保存中...');
		}else{
			showSelfProgress('发布中...');
		}
    	
    	var data = {
				values : {
					"random_num":creatRandomNum(),
					"address":lobal_variable.address,
		            "person_id": $api.getStorage("person_id"),
		            "person_name":$api.getStorage('person_name'),
		            "identity_id":$api.getStorage("identity"),
		            "attachment": JSON.stringify(lobal_variable.attachment),
		            "end_time":lobal_variable.end_time,
		            "name" :lobal_variable.name,
		            "p_object" :lobal_variable.p_object,
		            "release_org" :JSON.stringify(lobal_variable.release_org),
		            "remarks" :lobal_variable.remarks,
		            "start_time" :lobal_variable.start_time,
		            "thumb_id" :lobal_variable.thumb_id,
		            "topic_id":oparam.id,
				}
			}
			if (isSave){
				delete data.values.release_org;
				delete data.values.p_object;
				delete data.values.start_time;
				delete data.values.end_time;
			}else{
				if (isOnlyShowOfPartaker) {
					data.values.show_identity = 1;
				}
			}
			
    	api.ajax({
	    	url : BASE_URL_ACTION+'/ypt/space/topic/update_topic',
			method : 'post',
			timeout : 30,
			dataType : 'json',
			data : data,
			headers : {
				'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
			}
        },function(ret,err){
        	if(err){
        		api.hideProgress();
        		popToast('更新失败，请稍候重试');
        	}else{
        		if(ret.success){
        			if (!isSave){
	        			var options = {
			                business_type:401,
			                relatived_id:oparam.id,
			                r_person_id:'',
			                r_identity_id:'',
			                operation_content:$api.getStorage("person_name") + '发起主题活动——《'+ lobal_variable.name +'》。',
			                e_relatived_id:''
			            };
			            creditWriteToQueue(options);
	        		}
	        		
        			
        			setTimeout(function(){
        				if (isSave){
        					popToast('保存成功');
        				}else{
        					popToast('发布成功');
        				}
        				
        				api.hideProgress();
        				commonExecScript('zthd_hd_window','zthd_hdjs_frame','getTopic();',1);
        				commonExecScript('zthd_index_window','zthd_index_frame','initData(1);',1);
        			},2900);
        			setTimeout(function(){
        				commonExecScript(api.winName,'','back();',0);
        			},3000);
        		}else{
        			api.hideProgress();
        			if(ret.is_moderation==1){
                        popToast('内容包含敏感信息，请修改后重试');
                    }else {
                        popToast('更新失败，请稍候重试');
                    }
        		}
        	}
        });
    }
    
    /*
    *author:zhaoj
    *function:选择附件图片
    *date：20171019
    */
    function getFjAlbum() {
    	var imgArray = $api.domAll($api.byId('j_attachment'), '.fj-detail');
    	if(imgArray.length >= 5){
    		popToast('只支持上传5个附件');
    		return;
    	}
    	var count = 5-imgArray.length;
		UIAlbumBrowser.open({"type":'all',"max":count},function(data){
			commonUiUploadFiles({"data":data,"is_trans":1}, function(ret_data) {
            	resourceAry = ret_data;
				insertResourceBaseInfoOneByOne();
            });
		});
    }
    
    /*
     * 功能：上传附件
     * 作者：张自强 
     * 时间：20171106 
     */
    function uploadFj(){
    	open_type = 1;
    	var imgArray = $api.domAll($api.byId('j_attachment'), '.fj-detail');
    	if(imgArray.length >= 5){
            popToast('只支持上传5个附件');
            return;
        }
        var count = 5-imgArray.length;
        
    	api.actionSheet({
			cancelTitle : '取消',
			buttons : buttons = ['添加图片','添加视频'],
			style : {
				titleFontColor : '#ff0000'
			}
		}, function(ret, err) {
			if (ret) {
				if (ret.buttonIndex == 1) {
				    var param_json={
                       count:count
                    }
					common_wmMediaResourcesTool.openPhoto(param_json,function(flag,data_arr){
                       if(flag){
                           commonUiUploadFiles({"data":data_arr,"is_trans":0}, function(ret_data) {
                                resourceAry = ret_data;
                                insertResourceBaseInfoOneByOne();
                           });
                       }
                    })
				} else if (ret.buttonIndex == 2) {
				    var param_json={
                       count:count,
                       time:180
                    }
					common_wmMediaResourcesTool.openAudio(param_json,function(flag,data_arr){
                        if(flag){
                           //递归上传视频
                            commonUiUploadFiles({"data":data_arr,"is_trans":0}, function(ret_data) {
                                resourceAry = ret_data;
                                insertResourceBaseInfoOneByOne();
                            });
                        }
                    });
				}
			} else {
			}
		});
    }
    
    /*
     * 功能：调用相机添加附件图片
     * 作者：张自强
     * 时间：2017106
     */
    function openFjPicture(){
    	var imgArray = $api.domAll($api.byId('j_attachment'), '.fj-detail');
    	if(imgArray.length >= 5){
    		popToast('只支持上传5个附件');
    		return;
    	}
    	var count = 5-imgArray.length;
    	getPicture.open({"type":1},function(data){
    		commonUiUploadFiles({"data":data,"is_trans":0}, function(ret_data) {
            	for(var i = 0; i < ret_data.length; i++){
            		var json_data = JSON.parse(ret_data[i]);
            		var file_id = json_data.file_id;
					var ext = json_data.ext;
					var param_json = getParamJson({"file_id" : file_id,"file_name" : json_data.file_name,"resource_format" : ext, "is_show_tip":0,"type":1,"voice_duration":0});
                        //上传到资源库中
                    insertResourceBaseInfo(param_json)
            	}
            });
    	});
    }
    
    /*
    *author:zhaoj
    *function:显示附件图片
    *date：20171023
    */
    function showPicture(param_json){
        //删除事件
//      var li_html ='<li attachment="'+param_json.resource_myinfo_id+'" resource_info_id="'+param_json.resource_info_id+'" resource_id_int="'+param_json.resource_id_int +'" fileName="'+param_json.resource_title+'" onclick="displayAttachmentImg(this)">';
//          li_html +='<div class="fj-detail ellipsis">';
//          li_html +=param_json.resource_title;
//          li_html +='</div>';
//          li_html +='</li>';
        var title = param_json.resource_title.split('.');
        if(title.length > 1 && title[title.length - 1] == param_json.resource_format){
            for (var j = 0; j < title.length - 1; j++){
            	param_json.resource_title = title[j];
            }
        }
		var deleteHtml = "deleteImg(this,this.parentNode,this.parentNode.parentNode,event)";
		var li_html ='<li attachment="'+param_json.resource_myinfo_id+'" resource_info_id="'+param_json.resource_info_id+'" resource_id_int="'+param_json.resource_id_int +'" fileName="'+param_json.resource_title+'" onclick="displayAttachmentImg(this)">';
			li_html +='<div class="fj-detail ellipsis">';
			li_html +=param_json.resource_title+"."+param_json.resource_format;
			li_html +='<div class="delete" onclick='+deleteHtml+'>&nbsp;</div>';
			li_html +='</div>';
			li_html +='</li>';
        $api.append($api.byId('j_attachment'), li_html);
        commonAddOrRemoveHideCss('j_fj_no_data',0);
        commonAddOrRemoveHideCss('j_attachment',1);
    }
    
   /*
    *author:zhaoj
    *function:将封面图片放大
    *date：20171019
    */
    function displayAttachmentImg(self){
        var resource_id_int=$api.attr(self, 'resource_id_int');
        var resource_info_id=$api.attr(self, 'resource_info_id');
        var param_json = {"is_show_tip":1,"resource_id_int":resource_id_int,"resource_info_id":resource_info_id};
        commonGetResInfo(param_json,function(flag,ret){
            api.hideProgress();
            if(flag){
                var oparam ={"res_type":ret.resource_format, "res_path":ret.file_id, "res_title":ret.resource_title,"m3u8_status":ret.m3u8_status,"winName":api.winName,"setBackFun":'reBackType("voice");',"backFun":'back();',"res_id":'open_picture',"pic_back":'picture_edit'};
                
 common_openResource.open_new(JSON.stringify(oparam));
                }else{
                    popToast('打开失败，请稍候重试');
            }
        });
    }
    
   /*
    *author:zhaoj
    *function:删除上传图片
    *date：20171020
    */
    function deleteImg(self, parent, grandpa,e ) {
        var top_parent = $api.byId('j_attachment');
        grandpa.removeChild(parent);
        top_parent.removeChild(grandpa);
        judgeImgLength();//判断已有图片数目
        e.stopPropagation();
    }
    
   /*
    *author:zhaoj
    *function:判断图片的数量
    *date：20171020
    */
    function judgeImgLength(){
    	imgArray = $api.domAll($api.byId('j_attachment'), '.fj-detail');
    	if(imgArray.length > 0){
    		commonAddOrRemoveHideCss('j_fj_no_data',0);
    		commonAddOrRemoveHideCss('j_attachment',1);
    	}else{
    		commonAddOrRemoveHideCss('j_attachment',0);
    		commonAddOrRemoveHideCss('j_fj_no_data',1);
    	}
    }
    
    /*
    *author:zhaoj
    *function:通过作品id获取作品详细信息
    *interface:张海
    *date：20171023
    */
	function get_topic_by_id(){
		showSelfProgress('加载中...');
		api.ajax({
			url : BASE_URL_ACTION + '/ypt/space/topic/get_topic_by_id?random_num='+creatRandomNum()+'&id='+oparam.id,
			method : 'get',
			timeout : 0,
			dataType : 'json',
			headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
			}, function(ret, err) {
				if(err){
					popToast('获取主题活动详细信息失败，请稍候重试');
				}else{
					if(ret.success){
						lobal_variable.p_object =ret.p_object;
//						if(ret.p_object == 4){
////							changeCyqx(1);
//							document.getElementById('j_option_'+ret.p_object).selected = true;
//							commonAddOrRemoveHideCss('j_object_tip',1);
//						}
//						$api.attr($api.byId('j_select'), 'disabled', 'true');
						//参与对象选中
						release_org = ret.release_org;
						$api.attr($api.byId('j_option_'+ret.p_object), 'selected', 'selected');
						$api.val($api.byId('name'), ret.name);
						$api.val($api.byId('remarks'), ret.remarks);
						$api.val($api.byId('j_time_0'), ret.start_time.substring(0,10));
                        $api.val($api.byId('j_time_1'), ret.end_time.substring(0,10));
                        lobal_variable.now_time = ret.start_time.substring(0,10);
                        lobal_variable.end_time = ret.end_time.substring(0,10);
                        time_end = lobal_variable.end_time;
						$api.val($api.byId('address'), ret.address);
						if(ret.thumb_id){
							showCover({"file_id":ret.thumb_id});
						}
						var attachment = ret.attachment;
						if(attachment.length > 0 ){
							for(var i = 0; i < attachment.length;i++){
								var param_temp = {
									resource_myinfo_id:attachment[i].res_id,
//									resource_info_id:attachment[i].res_id,
									resource_id_int:attachment[i].resource_id_int,
									resource_title:attachment[i].resource_title,
									resource_format:attachment[i].resource_format,
								}
								showPicture(param_temp);
							}
						}
					}else{
						popToast('获取主题活动详细信息失败，请稍候重试');
					}
				}
			api.hideProgress();
		});
	}
	
	    /*
	    *author:zhaoj
	    *function:选择对象
	    *date：20171023
	    */
	    function selectObject(self,org_id,is_group){
			if($api.hasCls(self, 'active')){
				//取消选中的情况
				$api.removeCls(self, 'active');
			}else{
				//选中
				$api.addCls(self, 'active');
			}
	    }
	    
	 /*
        *author:zhaoj
        *function:获取到上传资源库中的参数
        *date：20170904
        */
        function getParamJson(param){
            var resource_format =param.resource_format;
            resource_format = resource_format.toLowerCase();
            var check_ext = support_extension.indexOf(resource_format);
            var m3u8_status;
            check_ext != "-1" ? m3u8_status = 1:m3u8_status=0;
            var dot_index = param.file_name.lastIndexOf('.');
            param.file_name = param.file_name.substring(0,dot_index);
            var param_json={
                "app_type_id" : 17,
                "beike_type" : 100,
                "bk_type_name" : -1,
                "file_id" : param.file_id,
                "group_id" : 2,
                "identity_id" : $api.getStorage('identity'),
                "m3u8_status" : m3u8_status,
                "person_id" : $api.getStorage("person_id"),
                "person_name" : Base64.encode($api.getStorage("person_name")),
                "res_type" : 35,
                "resource_format" : resource_format,
                "resource_title" : Base64.encode(param.file_name),
                "structure_id" : -1,
                "is_show_tip":param.is_show_tip,
                "type":param.type,//1:代表视频
                "voice_duration":param.voice_duration
            }
            return param_json;
        }
        
    /*
	 * 打开参与对象界面
	 * 王俭
	 * 2018.5.28
	 */
	function saveAndFb(){
//		commonExecScript(api.winName,'','reBackType("cydxSelect");',0);
		var header_h = api.pageParam.old_header_h;
		$api.setStorage('zthd_lobal_variable',lobal_variable);
//		commonOpenFrame("zthd_cydx_frame","zthd_cydx_frame.html",header_h,false,false,"#FFFFFF",{'from_html':'edit','header_h':header_h,'release_org':release_org,'p_object':lobal_variable.p_object});	
		commonOpenWin('zthd_cydx_window','zthd_cydx_window.html',false,false,{'from_html':'edit',"from_win":api.winName,'header_h':header_h,'release_org':release_org,'p_object':lobal_variable.p_object});
	}
	
	function backClick(){
    	commonExecScript('zthd_hd_window','','back()',0);
    }
</script>
</html>