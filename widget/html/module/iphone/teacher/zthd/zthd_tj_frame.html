<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<!-- html5：在创建html时为了防止页面缩放等不兼容效果，要创建个viewport  -->
	<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
	<!-- 在IOS设备上，有时会将数字转为手机号，这里也要禁止下 -->
	<meta name="format-detection" content="telephone=no"/>
    <title>课件</title>
    <link rel="stylesheet" type="text/css" href="../../../../../css/aui/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../css/aui_css_new/aui.css" />
     <link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
     <style>
    	body{background:#ffffff;}
    	li{
    	   height:80px;
    	   width:100%;
    	   background:url(../../../../../image/fun-module/ipad/zthd/school.png) 10px center no-repeat;
    	   background-size:45px 45px;
    	   padding-left:65px;
    	   border-bottom:1px solid #CDCDCD;
    	   position:relative;
    	   }
    	li .name{
    	   height:50%;
    	   line-height:60px;
    	   width:100%;
    	   max-width:85%;
    	}
    	li .xq{
    	   height:50%;
    	   line-height:30px;
    	   width:100%;
    	   color:#CDCDCD;
    	   font-size:14px;
    	}
    	li .xq .xq-div{
    	   float:left;
    	   width:29%;
    	   max-width:29%;
    	}
    	.mar-left{
    	   margin-right:1%;
    	}
    	.frist-li{
    	   width:40px;
    	   height:40px;
    	   position:absolute;
    	   right:0;
    	   top:0;
    	   background:url(../../../../../image/fun-module/ipad/zthd/top1.png);
    	   background-size:40px 40px;
    	}
    	.frist-second{
           width:40px;
           height:40px;
           position:absolute;
           right:0;
           top:0;
           background:url(../../../../../image/fun-module/ipad/zthd/top2.png);
           background-size:40px 40px;
        }
        .frist-third{
           width:40px;
           height:40px;
           position:absolute;
           right:0;
           top:0;
           background:url(../../../../../image/fun-module/ipad/zthd/top3.png);
           background-size:40px 40px;
        }
	</style>
</head>
<body class="index-body common-iphone-zthd-tea">
	<div class="clearfix">
		<ul id="zthd_div" class="zuoye-content">
		<script  type="text/html" id="zthd_script">
			<%if(list.length == 0){%>
				<div id="no_quanzi" class="no-data">暂无主题活动统计信息</div>
			<%}else{%>
				<%for(var i=0;i< list.length;i++){%>
					<li onclick="openZthd(<%=list[i].bureau_id%>,'<%=list[i].org_name%>');">	
					    <%if(page_num == 1 && i == 0 && sort_type == 'desc'){%>
					       <div class="frist-li">&nbsp;</div>
					    <%}else if(page_num == 1 && i == 1 && sort_type == 'desc'){%>
					       <%if(three_first_flag || first_flag){%>
					           <div class="frist-li">&nbsp;</div>
					       <%}else{%>
					           <div class="frist-second">&nbsp;</div>
					       <%}%>
					    <%}else if(page_num == 1 && i == 2 && sort_type == 'desc'){%>
					       <%if(three_first_flag){%>
                               <div class="frist-li">&nbsp;</div>
                           <%}else if(second_flag){%>
                               <div class="frist-second">&nbsp;</div>
                           <%}else{%>
                               <div class="frist-third">&nbsp;</div>
                           <%}%>
					    <%}%>
						<div class="name ellipsis"><%=list[i].org_name%></div>
						<div class="xq">
						     <div class="xq-div mar-left ellipsis">活动：<%=list[i]._count%></div>
						     <div class="xq-div mar-left ellipsis" style="width:40%;max-width:40%;"> 参与人次：<%=list[i].played_num%></div>
						     <div class="xq-div ellipsis">作品：<%=list[i].works_num%></div>
						</div>
					</li>
				<%}%>
			<%}%>
		</script>
	</ul>
	</div>
</body>
<script type="text/javascript" src="../../../../../script/api.js"></script>
<script type="text/javascript" src="../../../../../script/base_config.js" ></script>
<script type="text/javascript" src="../../../../../script/common/common.js" ></script>
<script type="text/javascript" src="../../../../../script/plug-in/template.js" ></script>
<script type="text/javascript">
	var currentPage = 1;//当前分页数
	var totalPages = 0;//总页数
	var totalData = 0;//定义一个变量存储第一次加载返回来的总记录数
	var start_time = '';//开始时间
	var end_time = '';//结束时间
	var sort_column = 1;//排序类型，1：活动数量，2：参与人数，3：作品数量
	var sort_type = 'desc';//排序方式
	apiready = function(){
		initData(1);
		commonScrollBottomReload();
		commonRefreshHeaderInfo(); 
	};
	
	/*
	 * 功能：加载主题活动列表
	 * 作者：张自强
	 * 时间：20171023
	 * 接口提供人：张海
	 */
	function initData(current_page){
		showSelfProgress('加载中...');
		api.removeEventListener({
	        name:'scrolltobottom'
        });
		currentPage = current_page;
        if(start_time != ''){
            start_time += ' 00:00:00'
        }
        if(end_time != ''){
            end_time += ' 23:59:59'
        }
		api.ajax({
				url :BASE_URL_ACTION + '/ypt/space/topic/get_topic_stat_by_districtid?district_id='+$api.getStorage('district_id')+'&page_num='+currentPage+'&page_size=20&end_time='+end_time+'&start_time='+start_time+'&sort_column='+sort_column+'&sort_type='+sort_type+'&random_num='+creatRandomNum(),
				method : 'get',
				timeout : 0,
				dataType : 'json',
				headers : {
		'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
			}, function(ret, err) {
				totalPages = ret.total_page;
				totalData = ret.total_row;//定义一个变量存储第一次加载返回来的总记录数
				if(err){
					popToast('获取主题活动列表失败，请稍候重试');
				}else{
					if(ret.success){
					    ret.sort_type = sort_type;
					    var list = ret.list;
					    var first_flag = false;
					    var second_flag = false;
					    var three_first_flag = false;
					    if(list && list.length >= 2){
					       switch(sort_column*1){
					           case 1://活动数量
					               if(list[0]._count == list[1]._count){
					                   first_flag = true;
					               }
					               if(list.length >=3){
					                   if(list[1]._count == list[2]._count){
                                           second_flag = true;
                                       }
                                       if(list[0]._count == list[1]._count && list[1]._count == list[2]._count){
                                           three_first_flag = true;
                                       }
					               }
					               break;
					           case 2://作品数量
					               if(list[0].works_num == list[1].works_num){
                                       first_flag = true;
                                   }
                                   if(list.length >=3){
                                       if(list[1].works_num == list[2].works_num){
                                           second_flag = true;
                                       }
                                       if(list[0].works_num == list[1].works_num && list[1].works_num == list[2].works_num){
                                           three_first_flag = true;
                                       }
                                   }
                                   break;
                               case 3://参与人数
                                   if(list[0].played_num == list[1].played_num){
                                       first_flag = true;
                                   }
                                   if(list.length >=3){
                                       if(list[1].played_num == list[2].played_num){
                                           second_flag = true;
                                       }
                                       if(list[0].played_num == list[1].played_num && list[1].played_num == list[2].played_num){
                                           three_first_flag = true;
                                       }
                                   }
                                   break;
					       }
					    }
					    ret.first_flag = first_flag;
					    ret.second_flag = second_flag;
					    ret.three_first_flag = three_first_flag;
						commonAddManyHtml('zthd_div','zthd_script',ret);
					}else{
						popToast('获取主题活动列表失败，请稍候重试');
					}
				}
				//通知顶部下拉刷新数据加载完毕，组件会恢复到默认状态
				commonControlRefresh();
				commonScrollBottomReload();
				api.hideProgress();
			});
	}
	
	/*
     * 功能：修改时间并加载数据
     * 作者 ：张自强
     * 时间：20180912
     */
    function changeTimeAndInit(startTime,endTime){
        start_time = startTime;
        end_time = endTime;
        initData(1);
    }
    
    /*
     * 功能：修改排序方式
     * 作者：张自强
     * 时间：20180912
     */
    function changeSortType(sortColumn,sortType){
        sort_column = sortColumn;
        sort_type = sortType;
        initData(1);
    } 
    
    /*
     * 功能：打开某个机构下的主题活动列表
     * 作者：张自强
     * 时间：20180913
     */
    function openZthd(id,org_name){
        var pageParamJson = {
            'bureau_id':id,
            'from_tj':1,
            'org_name':org_name,
            'header_h':api.pageParam.header_h,
            'start_time' :  start_time,//开始时间
            'end_time' : end_time//结束时间
        }
        commonOpenWin('zthd_index_window', 'zthd_index_window.html', false, false, pageParamJson);
    }
</script>
</html>