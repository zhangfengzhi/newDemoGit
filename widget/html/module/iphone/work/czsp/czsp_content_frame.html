<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<!-- html5：在创建html时为了防止页面缩放等不兼容效果，要创建个viewport  -->
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<!-- 在IOS设备上，有时会将数字转为手机号，这里也要禁止下 -->
		<meta name="format-detection" content="telephone=no"/>
		<title>申请详情</title>
		<link rel="stylesheet" type="text/css" href="../../../../../css/aui/aui.css" />
		<link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
		<style>
			.clearfix:after {content: ' ';display: block;clear: both;visibility: hidden;line-height: 0;height: 0;}
			.ellipsis {white-space: nowrap;overflow: hidden;text-overflow: ellipsis;}
			.title {font-size: 20px;padding: 5px 0 15px 0;line-height: 30px;color: #1abc9c;word-break: break-all;word-wrap:break-word;}
			.footer-div{position:fixed;height:55px;background:#ffffff;display: block;bottom: 0px;z-index:2;width:100%;box-shadow:3px 0 4px #aaaaaa;line-height:55px;text-align:center;color:#ffffff;}
			.footer-div > div{width:50%;float:left;}
			.bggreen{background:#1abc9c;}
			.bgred{background:#e60012;}
			.aui-content{padding:10px 15px;}
			.detail_list li{position:relative;line-height: 22px;padding:5px 0px;}
			.detail_list li em{position:absolute;color:#595757;}
			.detail_list li > span{padding-left:85px;color: #aaaaaa;display: block;padding-top:1px;}
			.detail_list li > span a{display: block;margin-bottom:5px;color:#fe931f;background: url(../../../../../image/fun-module/iphone/czsp/fj-qbz.png) 0px bottom no-repeat;background-size:15px auto;word-break:break-all; white-space: nowrap;overflow:hidden; text-overflow:ellipsis;padding-left: 20px;}
			.items{position:relative;margin-top:10px;}
			.items > div{border:1px solid #d5d5d5;padding:8px 10px 10px 10px;background:#fff;border-radius:20px;float:left;width:100%;}
			.items > img{float:left;}
			.items_sort{width:50px;height:50px; position: absolute;
left: 0px;top:0;padding-left:6px;padding-top:6px;}
			.items_sort img{position: absolute;left: 0px;top:0;z-index: 1;width:50px;}
			.items_sort span{position:relative;z-index: 1;color:#f76735;display:block;background:#fff;width:20px;height:20px;border-radius:15px;text-align:center;line-height:20px;font-size:13px;}
			.detail_img img{position: absolute;left:10px;width:117px;top:50%;margin-top:-53px;z-index: 0;}
			.items .detail_list{padding-left:125px;}
			.items .detail_list li{padding:2px 0; font-size:14px;line-height: 18px;}
			.items .detail_list li > span{padding-left:85px;}
			.mt10{margin-top:10px;}
			.pl110{padding-left:125px !important;}
			.pl48{padding-left:48px !important;}
			.height55{height:55px;}
			.sp_status{width:100%;padding-left: 76px;padding-top: 3px; font-size:13px;}
			.sp_status span{width:33%;display:block;float:left; text-align:center;}
			.red{color:#e60012 !important;}
			.none{display:none;}
			.pl80{padding-left: 80px !important;}
			.heji{text-align:center;color: #595757;}
			.fujian{border-top:1px solid #cdd8de; border-bottom:1px solid #cdd8de;padding:9px 0 7px 0 !important;}
		</style>
	</head>
	<body id="j_body">
		<div id="j_shadow" class="shadow"></div>
		<div id="j_content">
		
		</div>
		<script type="text/html" id="j_content_script">
		<div class="aui-content">
			<div id="" class="clearfix">	
				
					<div id="title_div" class="title"><%=project_name%></div>
					<ul class="detail_list">
						<li>
							<em>备案部门：</em>
							<span><%=office_name%></span>
						</li>
						<li>
							<em>申请人：</em>
							<span><%=person_name%></span>
						</li>
						<li>
							<em>申请单位：</em>
							<span><%=org_name%></span>
						</li>
						<li>
							<em>申请日期：</em>
							<span><%=create_time.substring(0,10)%></span>
						</li>
						<li>
							<em>单据编码：</em>
							<span><%=order_code%></span>
						</li>
						<li>
							<em>项目编码：</em>
							<span><%=project_code%></span>
						</li>
						<li>
							<em>申请理由：</em>
							<span>
							<%if(explain_info){%>
								<%=#explain_info%>
							<%}else{%>
								暂无申请理由
							<%}%>
							</span>
						</li>
					</ul>
					<%if(details.length>0){%>
						<%for(var i=0;i<details.length;i++){%>
							<div class="items clearfix">
								<div>
									<span class="items_sort">
										<img src="../../../../../image/fun-module/iphone/czsp/sort_bg.png" />
										<span><%=i+1%></span>
									</span>
									<div class="detail_img">
										<img src="../../../../../image/fun-module/iphone/czsp/detail_img.png" width="80">
									</div>
									<div>
										<ul class="detail_list">
											<li>
												<em>物品名称：</em>
												<span><%=details[i].thing_name%></span>
											</li>
											<li>
												<em>品牌及规格：</em>
												<span><%=details[i].name%></span>
											</li>
											<li>
												<em>数量：</em>
												<span><%=details[i].num%></span>
											</li>
											<li>
												<em>单位：</em>
												<span><%=details[i].unit%></span>
											</li>
											<li>
												<em>单价（元）：</em>
												<span><%=details[i].price_money%></span>
											</li>
											<li>
												<em>总价（元）：</em>
												<span><%=details[i].total_money%></span>
											</li>
										</ul>
									</div>
								</div>
								<img src="../../../../../image/fun-module/iphone/czsp/detail_bg.png" width="100%" />
							</div>
						<%}%>
					<%}%>
					<div class="heji">
						合计金额（元）：<span class="red"><%=money%></span>
					</div>
					<ul class="detail_list mt10">
						<%if(attachment_list.length>0){%>
							<li class="fujian">
								<em>附件：</em>
								<span class="pl48">
									<%for(var i=0;i<attachment_list.length;i++){%>
										<a href="javascript:;" onclick="openAttachment('<%=attachment_list[i].resource_id_int%>');">
											<%=attachment_list[i].resource_title%>&nbsp;
										</a>
									<%}%>
								</span>
							</li>
						<%}%>
						<li>
							<em>审批状态：</em>
							<div class="sp_status">
								<img id="img_status" src="" style="width:100%;">
								<span id="fir_sp">
									校级<br/>
									<%if(status_info[0].status==0){%>
										待审批
									<%}else if(status_info[0].status==1){%>
										通过
									<%}else if(status_info[0].status==2){%>
										未通过
									<%}%>
								</span>
								<%if(status_info[0].status==2){%>
								<%}else{%>  <!--校级通过才展示之后的两级-->
									<span id="sec_sp">
										<%=office_name%><br/>
										<%if(status_info[1].status==0){%>
											待审批
										<%}else if(status_info[1].status==1){%>
											通过
										<%}else if(status_info[1].status==2){%>
											未通过
										<%}%>
									</span>
									<%if(status_info[1].status==2){%>
									<%}else{%>  <!--校级、科级通过才展示局级-->	
										<span id="thir_sp">
											局级<br/>
											<%if(status_info[2].status==0){%>
												待审批
											<%}else if(status_info[2].status==1){%>
												通过
											<%}else if(status_info[2].status==2){%>
												未通过
											<%}%>
										</span>
									<%}%>
								<%}%>
							</div>
						</li>
						<li id="bohui" class="none">
							<em>驳回理由：</em>
							<span id="bohui_con" class="pl80">
								<%=#remarks%>&nbsp;
							</span>
						</li>
					</ul>
			</div>
		</div>
			<%if(levelValue==1){%>
				<div id="j_footer_use" class="height55">&nbsp;</div>
				<div id="j_footer" class="footer-div">
				 	<div class="bggreen" onclick="spPass(1);">通过</div>
				 	<div class="bgred" onclick="spPass(2);">驳回</div>
				</div>
			<%}%>
		</script>
	
	</body>
	<script type="text/javascript" src="../../../../../script/api.js" ></script>
	<script type="text/javascript" src="../../../../../script/base_config.js" ></script>
	<script type="text/javascript" src="../../../../../script/plug-in/template.js" ></script>
	<script type="text/javascript" src="../../../../../script/common/common.js" ></script>
	<script type="text/javascript" src="../../../../../script/plug-in/base64.js" ></script>
	<script type="text/javascript" src="../../../../../script/plug-in/echo.min.js" ></script>
	<script type="text/javascript" src="../../../../../script/assembly/photoBrowser.js"></script>
	<script type="text/javascript" src="../../../../../script/assembly/executeApp.js" ></script>
	<script type="text/javascript" src="../../../../../script/assembly/openResource.js" ></script>
	<script type="text/javascript">
		var BASE_URL_ACTION;
		var BASE_APP_TYPE;
		var image_array=[];//所有图片路径
		var levelValue;
		var title;  //申请单名称
		var sp_level; //审批级别，1 校级审批，2部门审批人员，3局级审批人员，4财务审批人员
		apiready = function() {
			commonSetTheme({"level":5,"type":0});
			BASE_URL_ACTION = $api.getStorage('BASE_URL_ACTION');
			BASE_APP_TYPE = $api.getStorage('BASE_APP_TYPE');
			levelValue = api.pageParam.levelValue;
			title = api.pageParam.title;
			sp_level = api.pageParam.sp_level;
			getConInfo();
		};
		
		/*
		 *author:zfz
		 *function:获取详细信息
		 *date：20171123
		 */
		function getConInfo(){
			api.ajax({
			url : BASE_URL_ACTION + "/ypt/space/examine/findRequestInfo?id="+api.pageParam.id+"&person_id="+$api.getStorage("person_id")+"&identity_id="+$api.getStorage("identity")+"&random_num="+creatRandomNum(),
			method : 'get',
			timeout : 30,
			dataType : 'json',
			headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
}
		}, function(ret, err) {
			if (ret.success) {
				ret.success[0].explain_info = commonTransferBrStr(ret.success[0].explain_info);
		        ret.success[0].remarks = commonTransferBrStr(ret.success[0].remarks);
		        ret.success[0].levelValue = levelValue;
				addTemplateHtml('j_content', 'j_content_script', ret.success[0]);
				var status0 = Number(ret.success[0].status_info[0].status);
				var status1 = Number(ret.success[0].status_info[1].status);
				var status2 = Number(ret.success[0].status_info[2].status);
				setStatusImgSrc(status0,status1,status2);
				api.execScript({
					name : 'czsp_content_window',
					script : 'getOrgInfo('+ret.success[0].org_id+','+ret.success[0].org_type+',"'+ret.success[0].office_name+'","'+ret.success[0].org_name+'",'+ret.success[0].office_id+');'
			    });
			} else {
				api.alert({
					msg : '对不起，获取申请单列表信息失败'
				});
			}
		});
		}
		
		/*
		 *author:zhaoj
		 *function:渲染html
		 *date：20160627
		 */
		function addTemplateHtml(div_id, script_id, data){
			var html_type = template.render(script_id, data);
			document.getElementById(div_id).innerHTML = html_type;
		}
		
		/*
		 * function:设置不同审批状态不同级别人员展示的审批图片
		 * data:20171121
		 * author:zfz
		 */ 
		function setStatusImgSrc(status0,status1,status2){
			var src = "";
			//待审批   fir_sp = "校长<br/>待审批";sec_sp = "信息中心<br/>待审批";thir_sp = "局长<br/>待审批";
			if(status0==0 && status1==0 & status2==0){
				src = "../../../../../image/fun-module/iphone/czsp/status1.png";
			}
			//审批中  校审批完，其余两级未审批-status2.png ;  
			//fir_sp = "校长<br/>通过";sec_sp = "信息中心<br/>待审批";thir_sp = "局长<br/>待审批";
			if(status0==1 && status1==0 && status2==0){
				src = "../../../../../image/fun-module/iphone/czsp/status2.png";
			}
			//审批中  校审批完，科审批完-status21.png
			//fir_sp = "校长<br/>通过";sec_sp = "信息中心<br/>通过";thir_sp = "局长<br/>待审批";
			if(status0==1 && status1==1 && status2==0){
				src = "../../../../../image/fun-module/iphone/czsp/status21.png";
			}
			////已通过(均审批完)
			//fir_sp = "校长<br/>通过";sec_sp = "信息中心<br/>通过";thir_sp = "局长<br/>通过";
			if(status0==1 && status1==1 && status2==1){
				src = "../../../../../image/fun-module/iphone/czsp/status3.png";
			}
			//未通过   校未通过
			//fir_sp = "校长<br/>未通过";
			if(status0==2){
				src = "../../../../../image/fun-module/iphone/czsp/status4.png";
			}
			//未通过      校通过，科未通过
			//fir_sp = "校长<br/>通过";sec_sp = "信息中心<br/>未通过";
			if(status0==1 && status1==2){
				src = "../../../../../image/fun-module/iphone/czsp/status41.png";
			}
			//未通过  校审批完，科通过，局长未通过
			//fir_sp = "校长<br/>通过";sec_sp = "信息中心<br/>通过";thir_sp = "局长<br/>未通过";
			if(status0==1 && status1==1 && status2==2){
				src = "../../../../../image/fun-module/iphone/czsp/status42.png";
			}
			
			if(levelValue==4){   //审批状态为未通过时，显示驳回理由
				$api.removeCls($api.byId('bohui'), 'none');
			}
			$api.attr($api.byId('img_status'), 'src', src);	
		}
		
		
		//替换所有的回车换行
		function transferBrStr(content) {
			var string = content;
			try {
				string = string.replace(/\r\n/g, "<br />")
				string = string.replace(/\n/g, "<br />");
			} catch(e) {
				popAlert(e.message);
			}
			return string;
		}
		
		/*
		 * function:审批通过
		 * data:20171122
		 * author:zfz
		 */ 
		function spPass(type){
			if(type == 1){
				spPassFun(1,'');
			}else if(type == 2){
				commonOpenFrame('czsp_bohui_frame', 'czsp_bohui_frame.html',0, false, false,"rgba(0,0,0,0.5);",{"header_h":api.pageParam.header_h});//打开index页面
			}
			
		}
		
		/*
		 * function:审批函数
		 * data:20171124
		 * author:zfz
		 */
		function spPassFun(type,content){
			if(content){
				content = Base64.decode(content);
			}
			showSelfProgress('加载中...');
			api.ajax({
					url : BASE_URL_ACTION + '/ypt/space/examine/dealRequset',
					method : 'post',
					timeout : 0,
					dataType : 'json',
					data:{
						values : {
							e_p_id : $api.getStorage("person_id"),
							info_id : api.pageParam.id,
							level : sp_level,
							status : type,
							remarks : content,
							identity_id : $api.getStorage("identity"),
							random_num : creatRandomNum()
						}
					},
					headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
}
					}, function(ret, err) {
						api.hideProgress();
						if (err) {
							popBottomToast('操作失败，请稍候重试');
						} else {
							if(ret.success){
								popBottomToast('操作成功');
								api.execScript({
									name : 'czsp_index_window',
									frameName : 'czsp_index_frame',
									script : 'initData(1,'+true+');'
							    });
								setTimeout(function(){
									api.execScript({
										name:'czsp_content_window',
								        script: 'back();'
								    });
								},500);
							}else{
								popBottomToast('操作失败，请稍候重试');
							}
						}
				});
		}
		
		/*
		*author:zhaoj
		*function:替换所有的回车换行
		*date：20170914
		*/
		function commonTransferBrStr(content) {
			var string = content;
			try {
				string = string.replace(/\r\n/g, "<br />")
				string = string.replace(/\n/g, "<br />");
			} catch(e) {
				popAlert(e.message);
			}
			return string;
		}
		
		/*
	    *author:zhaoj
	    *function:打开附件
	    *date：20171023
	    */
		function openAttachment(resource_id_int){
			var param_json = {"is_show_tip":1,"resource_id_int":resource_id_int};
	            commonGetResInfo(param_json,function(flag,ret){
	                api.hideProgress();
	                if(flag){
	                    var oparam ={"res_type":ret.resource_format, "res_path":ret.file_id, "res_title":ret.resource_title,"m3u8_status":ret.m3u8_status,"winName":api.winName,"setBackFun":'reBackType("voice");',"backFun":'back();',"res_id":'open_picture',"pic_back":'picture'};
	 common_openResource.open_new(JSON.stringify(oparam));
	                }else{
	                    popToast('打开失败，请稍候重试');
	                }
	            });
		}
		
		/*
		*author:zhaoj
		*function:获取资源详情
		*date：20170904
		*/
		function commonGetResInfo(param_json,callback){
			param_json.is_show_tip ? showSelfProgress('加载中...'):'';
			var data = {"random_num" : creatRandomNum()};
			var res_url='';
			if(param_json.resource_id_int){
				data.resource_id_int = param_json.resource_id_int;
				res_url = BASE_URL_ACTION+'/ypt/resource/getResourceByIDInt';
			}else{
				data.ids = param_json.resource_info_id;
				res_url = BASE_URL_ACTION+'/ypt/resource/getResourceInfoByIds';
			}
			var headers = {
		'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
		}
			api.ajax({
				url : res_url,
				method : 'get',
				timeout : 30,
				dataType : 'json',
				data : {
					values : data
				},
				headers : {
		'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
		}
				}, function(ret, err) {
					if(err){
						callback(false,"");
					}else{
						if(ret.success){
							callback(true,ret);
						}else{
							callback(false,"");
						}
					}
			});
		}
		
	</script>
</html>