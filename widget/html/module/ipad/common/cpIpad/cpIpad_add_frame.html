<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<!-- html5：在创建html时为了防止页面缩放等不兼容效果，要创建个viewport  -->
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<!-- 在IOS设备上，有时会将数字转为手机号，这里也要禁止下 -->
		<meta name="format-detection" content="telephone=no"/>
		<title>发布食谱</title>
		<link rel="stylesheet" type="text/css" href="../../../../../css/aui/aui.css" />
		<link rel="stylesheet" type="text/css" href="../../../../../css/module/ipad/popup-body.css"/>
		<link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
		<style>
			.popup-body-new	.commont-content{padding:52px 0 50px 0;}
	    	.content-name{height:60px;}
	    	input[type='text'],textarea{border:none;margin-bottom:0;}
	    	input[type='text']{height:59px;border-bottom:1px dashed #aaaaaa;padding:10px 0;}
	    	textarea{height:165px;padding:20px;max-height:165px;overflow-y: auto;}
	    	.popup-body-new .commont-content .position{font-size:16px;padding:20px 0 0 30px;}
		</style>
	</head>
	<body class="popup-body-new common-ipad-cpIpadstu">
		<div id="j_select_picture" class="select-picture-bg aui-hide">
			<div class="select-picture">
				<div class="option" onclick="getAlbum();">图片</div>
				<div class="option" onclick="openPicture();">拍照</div>
				<div class="option" onclick="commonExecScript('cpIpad_index_window','','back();',0);">取消</div>
			</div>
		</div>
		<div class="commont-content">
			<div class="top fl">
				<div class="name">添加食谱</div>
				<div class="close fr" onclick="closeFrame();"></div>
			</div>
			<div class="content">
				<div class="content-name plr20 clearfix ">
					<input oninput="commonRemoveExpression(this)" id="notice_title" type="text" placeholder="标题，最多支持30字符（必填）" maxlength ='30' />
				</div>
				<div class="content-text plr120 clearfix ">
					<textarea id="notice_content" placeholder="请输入内容" rows="4"></textarea>
				</div>
				<div class="add-img-file">
					<ul id="j_files">
						<li id="j_add_btn" class="add-btn fl" onclick="selectPicture();">
							<a class="aui-iconfont aui-icon-add fl"></a>
						</li>
					</ul>
				</div>
			</div>
			<div class="btn" onclick="addNotice('cpIpad',104);">保存</div>
		</div>
	</body>
	<script type="text/javascript" src="../../../../../script/api.js" ></script>
	<script type="text/javascript" src="../../../../../script/base_config.js" ></script>
	<script type="text/javascript" src="../../../../../script/plug-in/template.js" ></script>
	<script type="text/javascript" src="../../../../../script/plug-in/base64.js" ></script>
	<script type="text/javascript" src="../../../../../script/common/common.js" ></script>
	<script type="text/javascript" src="../../../../../script/assembly/UIAlbumBrowser.js"></script>
	<script type="text/javascript" src="../../../../../script/assembly/getPicture.js"></script>
	<script type="text/javascript" src="../../../../../script/assembly/photoBrowser.js"></script>
	<script type="text/javascript">
		var uICustomPicker;
		var notice_img_path;//附件图片上传服务器路径
		var header_h;
		var BASE_URL_ACTION;
		var BASE_APP_TYPE;
		var obj_scan;
		apiready = function() {
			commonSetTheme({"level":5,"type":0});
			BASE_URL_ACTION = $api.getStorage('BASE_URL_ACTION');
			BASE_APP_TYPE = $api.getStorage('BASE_APP_TYPE');
			obj_scan = api.require('UIAlbumBrowser');
			//初始化管辖区域选择器
			uICustomPicker = api.require('UICustomPicker');
			header_h = api.pageParam.header_h;
		};
		/*
*作者:zhaoj
*功能:发布数据
*日期：20161008
*/
function addNotice(mode_name,org_type){
	org_type = 104;
	$api.css($api.byId('shadow'),'z-index:3;');
	var title = $api.val($api.byId('notice_title'));
	if (title == '') {
		api.alert({
			msg : '标题不能为空！'
		}, function(ret, err) {
			$api.byId('notice_title').focus();
		});
		$api.css($api.byId('shadow'),'z-index:-1;');
		return false;
	}
	var content = $api.val($api.byId('notice_content'));
	if (content == '') {
		api.alert({
			msg : '对不起，请输入内容'
		}, function(ret, err) {
			$api.byId('notice_content').focus();
		});
		$api.css($api.byId('shadow'),'z-index:-1;');
		return false;
	}
	var overview = content.substring(0,100);
	content = '<p>' + content + '</p><br/>';
	//验证是否有附件
	var dlArray = $api.domAll($api.byId('j_files'), '.j_img');
	var img_suffix =commonReturnPhotoCutSize(0)
	if (dlArray.length != 0) {
		var thumbnail;//缩略图路径
		if (BASE_APP_TYPE == 2) {
			for (var i = 0; i < dlArray.length; i++) {
				if (i == 0) {
					thumbnail = $api.attr(dlArray[i], 'src');
					var startIndex = thumbnail.indexOf('/dsideal_yy/');
					thumbnail = thumbnail.substring(startIndex,thumbnail.length);
					thumbnail = thumbnail.replaceAll(img_suffix, '');
				}
				var img_url = $api.attr(dlArray[i], 'src');
				var startIndex = img_url.indexOf('/dsideal_yy/');
				img_url = img_url.substring(startIndex,img_url.length);
				img_url = img_url.replaceAll(img_suffix, '');
				var img_html = '<img src="' + img_url + '" alt="" />'
				content = content+ img_html;
			}
		} else {
			for (var i = 0; i < dlArray.length; i++) {
				if (i == 0) {
					thumbnail = $api.attr(dlArray[i], 'src');
					thumbnail = thumbnail.replaceAll(img_suffix, '');
				}
				var img_url = $api.attr(dlArray[i], 'src');
				img_url = img_url.replaceAll(img_suffix, '');
				var img_html = '<img src="' + img_url + '" alt="" />'
				content = content+ img_html;
			}
		}
	}
	showSelfProgress('发布中...');
	api.ajax({
		url :BASE_URL_ACTION + '/ypt/notice/addNotice',
		method : 'post',
		timeout : 30,
		dataType : 'json',
		data : {
			values : {
				"content":content,
				"identity_id":$api.getStorage("identity"),
				"notice_type":1,
				"org_id":$api.getStorage("school_id"),
				"org_type":org_type,
				"overview":overview,
				"person_id":$api.getStorage("person_id"),
				"register_id":api.pageParam.register_id,
				"thumbnail":thumbnail,
				"title":title,
				"random_num":creatRandomNum()
			}
		},
		headers : {
'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
	}, function(ret, err) {
		if (err) {
			api.hideProgress();
			$api.css($api.byId('shadow'),'z-index:-1;');
			popToast('发布失败，请稍候再试！');
		} else {
			if(ret.success){
				setTimeout(function(){
					api.hideProgress();
					popToast('发布成功');
					$api.css($api.byId('shadow'),'z-index:-1;');
					api.execScript({
						name : mode_name+'_index_window',
						frameName : mode_name+'_index_frame',
						script : 'initData(1);'
					});
					api.execScript({
						name : mode_name+'_index_window',
						script : 'back();'
					});
				},3000);
			}else{
				api.hideProgress();
				$api.css($api.byId('shadow'),'z-index:-1;');
				popToast('发布失败，请稍候再试！');
			}
		}
	});
}
		/*
		*author:zhaoj
		*function:关闭页面
		*date：20170912
		*/
		function closeFrame(){
			commonExecScript('cpIpad_index_window','','back();',0);
		}
		
		/*
		*author:zhaoj
		*function:选择图片
		*date：20170914
		*/
		function selectPicture(){
			commonExecScript('cpIpad_index_window','','reBackType("picture_sel");',0);
			$api.removeCls($api.byId('j_select_picture'),'aui-hide');
		}
		
		/*
		*author:zhaoj
		*function:关闭选择图片
		*date：20170914
		*/
		function closePicture(){
			$api.addCls($api.byId('j_select_picture'),'aui-hide');
		}
		
		/*
	     *author:zhaoj
	     *function:选择图片
	     *date：20170914
	     */
	    function getAlbum() {
			var num = 5 - judgeImgCount();
			if(num != 0){
				UIAlbumBrowser.open(num,function(data){
					//递归上传图片
					commonUiUploadFiles({"data":data,"is_trans":1}, function(ret_data) {
						for(var i = 0; i < ret_data.length; i++){
							var json_data = JSON.parse(ret_data[i]);
		            		var file_id = json_data.file_id;
							var ext = json_data.ext;
							var param_json = {"file_id" : file_id,"ext" : ext};
                            showPicture(param_json);
						}
						commonExecScript('cpIpad_index_window','','back();',0);
					})
				})
			}else{
				popToast('最多上传5张图片');
			}
	    }
		/*
	 	*author:zhaoj
	 	*function:判断图片的数量
	 	*date：20170915
	 	*/
	    function judgeImgCount(){
	    	var imgArray = $api.domAll($api.byId('j_files'), '.j_img');
	    	if(imgArray.length == 5){
	    		$api.addCls($api.byId('j_add_btn'), 'aui-hide');
	    	}else{
	    		$api.removeCls($api.byId('j_add_btn'), 'aui-hide');
	    	}
	    	return imgArray.length;
		}
		/**
	     * 递归上传图片
	     * zfz
	     * 2017.09.14
	     */
	    function dgUploadFiles(p_c, pic_list,type, callback) {
	        var pic_l = getJsonObjLength(pic_list);
	        if (p_c < pic_l) {
	            var pic_url_old = pic_list[p_c].path;
	            if (api.systemType == 'ios' && type == 1) {
	                //将相册图片地址转换为可以直接使用的本地路径地址
	                UIAlbumBrowser.transPath(pic_url_old,function(pic_url_new){
	                    commonUploadFiles(pic_url_new, function(is_true, a_file_id, a_ext) {
	                        if (is_true) {
	                            var param_json = {"file_id" : a_file_id,"ext" : a_ext,};
	                            showPicture(param_json);
	                            p_c++;
	                            return dgUploadFiles(p_c, pic_list,type, callback);
	                        } else {
	                            return dgUploadFiles(p_c, pic_list,type, callback);
	                        }
	                    });
	                });
	            } else {
	                commonUploadFiles(pic_url_old, function(is_true, a_file_id, a_ext) {
	                    if (is_true) {
	                        var param_json = {"file_id" : a_file_id,"ext" : a_ext,};
	                        showPicture(param_json);
	                        p_c++;
	                        return dgUploadFiles(p_c, pic_list,type, callback);
	                    } else {
	                        return dgUploadFiles(p_c, pic_list,type, callback);
	                    }
	                });
	            }
	        } else {
	            callback(true);
	        }
	    }
	    /*
	 	*author:zhaoj
	 	*function:显示图片
	 	*date：20170914
	 	*/
	    function showPicture(param_json){
	    	var img_url='';//图片路径
	    	var img_url_original="";//原图
	    	if (BASE_APP_TYPE == 1) {
				img_url = BASE_IMAGE_PRE+"down/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext + commonReturnPhotoCutSize(0);	
				img_url_original = 	BASE_IMAGE_PRE+"down/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext;		
			} else {
				img_url = BASE_URL_ACTION + "/html/thumb/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext + commonReturnPhotoCutSize(0);
				img_url_original = BASE_URL_ACTION + "/html/thumb/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext;
			}
			var error_html ="this.src='../../../image/yingyong/weike/wk_default.png'";
	    	var li_html = '<li class="fl">';
				li_html += '<img class="j_img" onclick="openImg(this);" openSrc="'+img_url_original+'" onerror="'+error_html+'" src="'+img_url+'" />';
				li_html += '<div class="delete" onclick="deleteImg(event,this);"></div>';
				li_html += '</li>';
	    	$api.before($api.byId('j_add_btn'), li_html);
	    	judgeImgCount();
	    }
	    /*
	 	*author:zhaoj
	 	*function:删除图片
	 	*date：20170915
	 	*/
	    function deleteImg(e,self){
	    	var parent = self.parentNode;
	    	var grandpa = parent.parentNode;
	    	grandpa.removeChild(parent);
	    	judgeImgCount();
	    	e.stopPropagation();
	    }
	    /*
	 	*author:zhaoj
	 	*function:打开图片
	 	*date：20170915
	 	*/
	    function openImg(self){
	    	var parent = self.parentNode;
	    	var grandpa = parent.parentNode;
	    	//获取当前文件的位置
	    	var index;
			if (parent) {
				index = 0;
				while ( parent = parent.previousSibling) {
					if (parent.nodeType == 1)
						index++;
				}
			}
			//获取图片路径
			var openImgArray = [];
			var imgArray = $api.domAll($api.byId('j_files'), '.j_img');
			for (var i = 0; i < imgArray.length; i++) {
				openImgArray.push($api.attr(imgArray[i], 'openSrc'));
			}
			//打开图片
			photoBrowser.open(openImgArray, index);
	    }
		/**
		 * 上传文件
		 * 周枫
		 * 2015.11.25
		 */
		function uploadFiles(file_path, callback) {
			api.showProgress({
				title : '上传中...',
				text : '请稍候...',
				modal : true
			});
			//扩展名
			var ldot = file_path.lastIndexOf(".");
			var ext = file_path.substring(ldot + 1);
			//			var ext = file_path.substring(ldot + 1).substring(0,3);
			if (ext != "jpg" && ext != "png" && ext != "JPG" && ext != "PNG") {
				api.hideProgress();
				popToast("文件格式只支持png和jpg");
				return;
			}
			if (BASE_APP_TYPE == 1) {
				var v_guid = newGuid();
				//图片上传服务器时路径
				var _key = url_path_suffix + v_guid.substring(0, 2) + "/" + v_guid + "." + ext;
				notice_img_path = _key;
				api.ajax({
					url : BASE_URL_ACTION + '/res/uploadFileToAliyun',
					method : 'post',
					timeout : 30,
					dataType : 'json',
					returnAll : false,
					data : {
						values : {
							key : _key
						},
						files : {
							file : file_path
						}
					}
				}, function(ret, err) {
					//					api.hideProgress();
					if (err) {
						callback(false, '', '');
					} else {
						if (ret.success) {
							callback(true, v_guid, ext);
						} else {
							callback(false, '', '');
						}
					}
				});
			} else {
				//局版
				var v_guid = newGuid();
				var extension = ext;
				//图片上传服务器时路径
				var _key = url_path_suffix + v_guid.substring(0, 2) + "/" + v_guid + "." + ext;
				notice_img_path = _key;
				api.ajax({
					url : BASE_URL_ACTION + '/res/newUpload/',
					method : 'post',
					timeout : 30,
					dataType : 'json',
					returnAll : false,
					data : {
						values : {
							key : _key
						},
						files : {
							file : file_path
						}
					}
				}, function(ret, err) {
					//					api.hideProgress();
					if (err) {
						callback(false, '', '');
					} else {
						if (ret.success) {
							callback(true, v_guid, extension);
						} else {
							callback(false, '', '');
						}
					}
				});
			}
		}

		/*
		 *author:zhaoj
		 *function:上传的图片
		 *date：20160307
		 */
		function uploadImg(file_id, ext) {
			var img_width = api.winWidth - 40;
			var img_height = Math.floor((api.winWidth - 60));
			var img_url;
			img_size = commonReturnPhotoCutSize(1,img_width,img_height,ext);
			if (BASE_APP_TYPE == 1) {
				img_url = BASE_IMAGE_PRE+"down/Material/" + file_id.substring(0, 2) + "/" + file_id + '.' + ext + commonReturnPhotoCutSize(0);
			} else {
				img_url = BASE_URL_ACTION + "/html/thumb/Material/" + file_id.substring(0, 2) + "/" + file_id + '.' + ext + commonReturnPhotoCutSize(0);
			}
			var img_html = '<p id="add_sucai" class="common-content add-img bgf sucai clearfix">';
			img_html = img_html + '<img id="sucai_img" class="sucai-img" src=' + img_url + ' width=' + img_width + ' />';
			img_html = img_html + '<img class="shanchu" width="25" height="25" src="../../image/yingyong/zuoye/shanchu.png" alt="删除" onclick="deleteImg(event,this.parentNode,this.parentNode.parentNode,this);" />'
			img_html = img_html + '</p>';
			$api.after($api.byId('add_img'), img_html);
			$api.html($api.byId('img_title'), '&nbsp;素材&nbsp;');
			$api.addCls($api.byId('add_img'), 'bb');
			//给上传素材删除点击事件
		}
		
		/**
		 * 选取图片
		 * 周枫
		 * 2016.1.16
		 */
		function openPicture(sourceType) {
			getPicture.open({"type":1},function(data){
	    		//递归上传图片
            	commonUiUploadFiles({"data":data,"is_trans":0}, function(ret_data) {
            		for(var i = 0; i < ret_data.length; i++){
						var json_data = JSON.parse(ret_data[i]);
	            		var file_id = json_data.file_id;
						var ext = json_data.ext;
						var param_json = {"file_id" : file_id,"ext" : ext};
                        showPicture(param_json);
					}
					commonExecScript('cpIpad_index_window','','back();',0);
            	})
	    	});
		}

		/*
		 *author:zhaoj
		 *function:图片格式
		 *date：20160222
		 */
		function getImgSize() {
			img_size = (api.winWidth - 30) * 0.18;
			img_size = Math.floor(img_size);
			var img_format = '@' + img_size + 'w_' + img_size + 'h_100Q_1x.';
			return img_format;
		}
	</script>
</html>