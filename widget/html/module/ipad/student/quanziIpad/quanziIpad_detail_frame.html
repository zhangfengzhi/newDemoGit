<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>圈子</title>
    <link rel="stylesheet" type="text/css" href="../../../../../css/aui/aui.css"/>
    <link rel="stylesheet" type="text/css" href="../../../../../css/module/ipad/left-right-layout.css"/>
    <link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
    <style>
		@media screen and (max-width: 464px) {
			.right-layout-body .person-info .headset div{height:22px;background-size:18px auto !important;margin:2px 0; }
			.right-layout-body .person-info .headset{font-size:12px;}
		}
	</style>
</head>
<body id="j_body" class="right-layout-body aui-hide common-ipad-quanziIpadstu">
<!--	<div class="triangle-left">&nbsp;</div>-->
	<div class="top">
		<div class="name">详情</div>
		<div class="close" onclick="closeFrame();">关闭</div>
	</div>
	<div class="person-info">
		<img id="j_header_img" class="header-img" onerror="this.src='../../../../../image/common/header.png'" src="" />
		<div id="j_person_name" class="person-name ellipsis">鹿晗</div>
		<div id="j_time" class="time">2017-08-17 09：11</div>
		<div class="top-opt">
			<div id="j_delete" class="delete fr aui-hide" onclick="deleteQuanzi();">
				<div>&nbsp;</div>
				删除
			</div>
			<div id="j_praise" class="praise fr" onclick="addPraiseInfo(this);">
				<div>&nbsp;</div>
				点赞
			</div>
			<div class="comment fr" onclick='openCommentFrame(0,0,0,0,0);'>
				<div>&nbsp;</div>
				评论
			</div>
		</div>
	</div>
	<div id="j_title" class="detail-title word-wrap"></div>
	<div id="j_content" class="detail-content word-wrap"></div>
	<div class="praise-comment-content">
		<div class="triangle-down">&nbsp;</div>
		<div class="praise-infor">
			<div class="bg"></div>
			<div id="j_praise_no_data" class="no-data">暂无点赞</div>
			<div id="j_praise_person" class="detail word-wrap aui-hide">
			</div>
		</div>
		<div id="comment_body" class="comment-infor">
			<div class="bg"></div>
			<div class="no-data">暂无评论</div>
		</div>
		<script type="text/html" id="comment_script">
			<div class="bg"></div>
			<% if(reply_list.length == 0){ %>
				<div class="no-data">暂无评论</div>
			<% }else{ %>
				<ul>
				<%for(var i=0; i < reply_list.length; i++) {%>
					<li>
						<img class="header-img" onerror="this.src='../../../../../image/common/header.png'" src="<%=reply_list[i].icon_url%>" />
						<div class="person-name ellipsis"><%=reply_list[i].person_name%></div>
						<div class="time"><%=reply_list[i].time %></div>
						<div class="comment-text word-wrap">
							<%if(reply_list[i].has_reply){%>
								回复<font class="plr5"><%=reply_list[i].parent_person_name%></font>
							<%}%>
							<%=#reply_list[i].content %>
						</div>
						<div class="comment-opt">
							<%if(reply_list[i].show_delete){%>
								<div class="delete fr" onclick="popTwoBtnConfirm('提示','确定删除该评论内容？','messageBoard_deletePost(<%=reply_list[i].topic_id %>,<%=reply_list[i].id %>)');">&nbsp;</div>
							<%}%>
							<div class="reply fr" onclick='openCommentFrame(1,<%=reply_list[i].id %>,<%=reply_list[i].person_id %>,<%=reply_list[i].identity_id %>,"<%=reply_list[i].person_name %>");'>&nbsp;</div>
						</div>
					</li>
				<%}%>
				</ul>
			<%}%>
		</script>
	</div>
</body>
<script type="text/javascript" src="../../../../../script/api.js"></script>
<script type="text/javascript" src="../../../../../script/base_config.js" ></script>
<script type="text/javascript" src="../../../../../script/plug-in/template.js" ></script>
<script type="text/javascript" src="../../../../../script/common/common.js"></script>
<script type="text/javascript" src="../../../../../script/plug-in/base64.js" ></script>
<script type="text/javascript" src="../../../../../script/assembly/photoBrowser.js"></script>
<script type="text/javascript" src="../../../../../script/init/iphone/init_quanzi.js"></script>
<script type="text/javascript" src="../../../../../script/assembly/openResource.js" ></script>
<script type="text/javascript">
	var oparam;//从list页面传递过来的参数
	var currentPage = 1;//当前分页数
	var totalPages = 0;//总页数
	var article_person_id;//发表文章的人的id
	var image_array=[];//所有图片路径
	apiready = function(){
		commonSetTheme({"level":5,"type":0});
		oparam = JSON.parse(Base64.decode(api.pageParam.oparam));
		$api.attr($api.byId('j_header_img'), 'src',oparam.avatar_fileid);
		showSelfProgress('加载中...');
		isExistsPraise(1);
		commonScrollBottomReload();
	};
	/*
	*author:zhaoj
	*function:打开评论页面
	*date：20170912
	*/
	function openCommentFrame(d, pid, person_id, identity_id, person_name){
		commonExecScript('quanziIpad_index_window','','openCommentFrame('+d+','+pid+','+person_id+','+identity_id+',"'+person_name+'",'+oparam.id+');',0);
	}
	/*
	*author:zhaoj
	*function:关闭页面
	*date：20170912
	*/
	function closeFrame(){
		commonExecScript('quanziIpad_index_window','','back();',0);
	}
	/*
	*author:zhaoj
	*function:加载圈子的详情
	*date：20170914
	*/
	function loadWzContentData(){
		var typeUrl = '';
		if(api.pageParam.org_type == 105){
			typeUrl = BASE_URL_ACTION + '/blog_expand/get_article_expand?id=' +  oparam.id+ '&expand_id=' + oparam.expand_id+ '&business_type=3&business_id=' + api.pageParam.org_id+ '&business_iid=105';
		}else{
			typeUrl = BASE_URL_ACTION + '/ypt/blog/getArticleById?id=' + oparam.id + '&expand_id=' + oparam.expand_id;
		}
		api.ajax({
			url : typeUrl,
			method : 'get',
			timeout : 30,
			dataType : 'json',
			headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
}
		}, function(ret, err) {
			if (err) {
				api.hideProgress();
				popToast('获取圈子详情失败，请稍候重试');
			} else {
				if(ret.success){
					//发表文章的人的id
					article_person_id = ret.person_id;
					//如果是同一个人，可以删除该圈子
					if(article_person_id == $api.getStorage("person_id")){
						$api.removeCls($api.byId('j_delete'), 'aui-hide');
					}
					oparam.title = ret.title;
					//获取圈子标题
					$api.html($api.byId('j_title'),ret.title);
					//获取圈子时间
					$api.text($api.byId('j_time'),ret.create_time.substring(0,16));
					//获取圈子创建人
					$api.text($api.byId('j_person_name'),ret.person_name);
					//获取圈子内容
					var notice_con = commonTransferBrStr(ret.content);
					var  onerror_img="this.src='../../../../../image/common/tpsx.png'";
					if (BASE_APP_TYPE == 1) {
						var notice_str1 = '<img';
						var notice_str2 = '<img class="ima_notice" onerror='+onerror_img+' onclick="openImage(this)" ';
						notice_con = notice_con.replaceAll(notice_str1, notice_str2);
					} else {
							var notice_str3 = '<img';
							var notice_str4 = '<img class="ima_notice" onerror='+onerror_img+' onclick="openImage(this)" ';
							notice_con = notice_con.replaceAll(notice_str3, notice_str4);
					}
					var key = '/dsideal_yy';
					if (notice_con.indexOf(key) != -1) {
                        var key_re = BASE_URL_ACTION;
                        notice_con = notice_con.replaceAll(key, key_re);
                    }
					$api.html($api.byId('j_content'), notice_con);
					notice_con.replace(/<img [^>]*src=['"]([^'"]+)[^>]*>/gi, function (match, capture) {
					  image_array.push(capture);
					});
					//获取点赞数据
					getPraiseinfoList();
					//显示圈子内容
					$api.removeCls($api.byId('j_body'), 'aui-hide');
					//播放内容需要加密
			        var voice_content = $api.text($api.byId('j_content'));
			        commonVoiceContent(voice_content);
				}else{
					api.hideProgress();
					popToast('获取圈子详情失败，请稍候重试');
				}
			}
		});
	}
	/*
	*author:zhaoj
	*function:打开图片预览
	*date：20171026
	*/
	function openImage(self){
		//图片
		var res_url=$api.attr(self, 'src');
		//打开图片
		var index = 0;
		for(var i = 0; i <image_array.length;i++){
			if(image_array[i] == res_url){
				index = i;
			}
		}
		openPictureShowWin(image_array,index)
	}
	/*
     *author:zhaoj
     *function:删除圈子
     *date：20170914
     */
    function deleteQuanzi(){
        popTwoBtnConfirm('提示','确定删除“'+oparam.title+'”圈子吗？','deleteArticle()');
    }
	/*
	 *author:zhaoj
	 *function:验证本人是否已经点赞
	 *date：20170914
	 */
	function isExistsPraise(type) {
		api.ajax({
			url : BASE_URL_ACTION + '/ypt/space/praise/isexists_praise?random_num='+creatRandomNum()+'&business_id='+oparam.id+'&business_type=1&person_id='+$api.getStorage("person_id")+'&identity_id='+$api.getStorage("identity"),
			method : 'get',
			timeout : 30,
			dataType : 'json',
			headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
}
		}, function(ret, err) {
			if (err) {
			} else {
				if(ret.success){
					if(ret.is_exists_praise){
						$api.addCls($api.byId('j_praise'), 'praised');
						$api.html($api.byId('j_praise'), '<div>&nbsp;</div>已赞');
					}else{
						$api.removeCls($api.byId('j_praise'), 'praised');
						$api.html($api.byId('j_praise'), '<div>&nbsp;</div>点赞');
					}
				}else{
				}
			}
			if(type){
				loadWzContentData();
			}
		});
	}
	/*
	*author:zhaoj
	*function:获取点赞数据
	*date：20170914
	*/
	function getPraiseinfoList(){
		api.ajax({
			url : BASE_URL_ACTION + '/space/praise/get_praiseinfo_list?random_num='+creatRandomNum()+'&business_id='+oparam.id+'&business_type=1&page_num=1&page_size=9999',
			method : 'get',
			timeout : 30,
			dataType : 'json',
			headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
}
		}, function(ret, err) {
			if (err) {
				api.hideProgress();
				popToast('获取点赞失败，请稍候重试');
			} else {
				if(ret.success){
					var person_name="";
					if(ret.praise_list.length > 0){
						$api.addCls($api.byId('j_praise_no_data'), 'aui-hide');
						person_name = "";
						for(var i = 0; i < ret.praise_list.length; i++){
							if(i == 0){
								person_name += ret.praise_list[i].person_name;
							}else{
								person_name += '，'+ret.praise_list[i].person_name;
							}
						}
						$api.html($api.byId('j_praise_person'), person_name);
						$api.removeCls($api.byId('j_praise_person'), 'aui-hide');
					}else{
						$api.html($api.byId('j_praise_person'), "");
						$api.addCls($api.byId('j_praise_person'), 'aui-hide');
						$api.removeCls($api.byId('j_praise_no_data'), 'aui-hide');
					}
					initData(currentPage);//获取评论的数据
				}else{	
					api.hideProgress();
					popToast('获取点赞失败，请稍候重试');
				}
			}
		});
	}
	/*
	*author:zhaoj
	*function:初始化列表数据
	*date：20170913
	*/
	function initData(current_page){
		currentPage = current_page;
		getCommentInfo();
	}
	/*
	 *author:zhaoj
	 *function:获取评论
	 *date：20170914
	 */
	function getCommentInfo() {
		api.ajax({
			url : BASE_URL_ACTION + '/bbs/topic/view?pageNumber=' + currentPage + '&pageSize=' + BASE_PAGE_SIZE + '&sort=1&type_id=' + "person_blog_article_" + oparam.id + '&message_type=2&random_num=' + creatRandomNum(),
			method : 'get',
			dataType : 'json',
			timeout : 30,
			cache : false,
			headers : {
				'Cookie' : 'person_id=' + $api.getStorage("person_id") + ';identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
			}
		}, function(ret, err) {
			api.hideProgress();
			if(err){
				popToast('获取评论失败，请稍候重试');
			}else{
				if (ret.success) {
					totalPages = ret.totalPage;
					var list = ret.reply_list;
					//对数据进行处理
					for (var i = 0; i < list.length; i++) {
						ret.reply_list[i]["content"] = commonTransferBrStr(ret.reply_list[i]["content"]);
						//评论时间显示的处理
						list[i]["time"] = list[i].create_time.substring(0, 16);
						list[i]["content"] = commonTransferBrStr(list[i]["content"]);
						//是否是回复
						if (list[i].parent_person_id * 1) {
							list[i]["has_reply"] = 1
						} else {
							list[i]["has_reply"] = 0;
						}
						//是自己发表的文章，可以删除评论，不是自己发表的文章，不能删除
						if ($api.getStorage("person_id") * 1 == article_person_id * 1 || $api.getStorage("person_id") * 1 == list[i].person_id * 1) {
							list[i]["show_delete"] = 1;
						} else {
							list[i]["show_delete"] = 0;
						}
						//获取头像
						if(BASE_APP_TYPE == 1){
							list[i].icon_url = BASE_IMAGE_PRE + url_path_suffix + list[i].icon_url.substring(0, 2) + "/" +list[i].icon_url + commonReturnPhotoCutSize(0);
						}else{
							list[i].icon_url = BASE_URL_ACTION + BASE_IMAGE_BEGIN + list[i].icon_url.substring(0, 2) + "/" + list[i].icon_url + commonReturnPhotoCutSize(0);
						}
					}
					commonAddManyHtml('comment_body', 'comment_script', ret);
				} else {
					popToast('获取评论失败，请稍候重试');
				}
			}
		});
	}
	/*
	 *author:zhaoj
	 *function:点赞接口
	 *date：20170914
	 */
	function addPraiseInfo(self){
		if($api.hasCls(self, 'praised')){
			cancelPraise();//取消点赞
		}else{
			api.ajax({
				url : BASE_URL_ACTION + '/ypt/space/praise/add_praise_info',
				method : 'post',
				timeout : 0,
				dataType : 'json',
				data : {
					values : {
						random_num : creatRandomNum(),
						business_id : oparam.id,
						business_type : 1,
						identity_id	 : $api.getStorage("identity"),
						person_id :$api.getStorage("person_id")
					}
				},
				headers : {
		'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
			}, function(ret, err) {
				if (err) {
					popToast('点赞失败');
				} else {
					if(ret.success){
						popToast('点赞成功');
						oparam.praise++;
						setIndexFramePraiseNum();
					}else{
						popToast('点赞失败');
					}
				}
			});
		}
	}
	/*
	*author:zhaoj
	*function:取消点赞
	*date：20170914
	*/
	function cancelPraise(){
		api.ajax({
			url : BASE_URL_ACTION + '/ypt/space/praise/cancel_praise_info',
			method : 'post',
			timeout : 30,
			dataType : 'json',
			data : {
				values : {
					random_num : creatRandomNum(),
					business_id : oparam.id,
					business_type : 1,
					identity_id	 : $api.getStorage("identity"),
					person_id :$api.getStorage("person_id")
				}
			},
			headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
}
		}, function(ret, err) {
			if (err) {
				popToast('取消失败');
			} else {
				if(ret.success){
					popToast('取消点赞');
					oparam.praise--;
					setIndexFramePraiseNum();
				}else{
					popToast('取消失败');
				}
			}
		});
	}
	/*
	 *author:zhaoj
	 *function:删除留言
	 *date：20160319
	 */
	function messageBoard_deletePost(topic_id, postid) {
		showSelfProgress('删除中...');
		api.ajax({
			url : BASE_URL_ACTION + '/ypt/bbs/post/delete',
			method : 'get',
			dataType : 'json',
			cache : false,
			timeout : 30,
			data : {
				values : {
					"random_num" : creatRandomNum(),
					"topic_id" : topic_id,
					"post_id" : postid
				}
			},
			headers : {
				'Cookie' : 'person_id=' + $api.getStorage("person_id") + ';identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
			}
		}, function(ret, err) {
			if (err) {
				api.hideProgress();
				popToast("删除评论失败");
			}else{
				if (ret.success) {
					setTimeout(function() {
						popToast("删除成功");
						setIndexFrameCommentNum(0);
					}, 2000);
					subCommentNum();
				} else {
					api.hideProgress();
					popToast("删除评论失败，" + ret.info);
				}
			}
		});
	}
	/*
	 *author:zhaoj
	 *function:删除留言数
	 *date：20160319
	 */
	function subCommentNum() {
		api.ajax({
			url : BASE_URL_ACTION + '/ypt/blog/subCommentNum',
			method : 'post',
			dataType : 'json',
			cache : false,
			timeout : 30,
			data : {
				values : {
					"random_num" : creatRandomNum(),
					"article_id" : oparam.id,
					"person_id" : $api.getStorage("person_id"),
					"identity_id" : $api.getStorage("identity")
				}
			},
			headers : {
				'Cookie' : 'person_id=' + $api.getStorage("person_id") + ';identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
			}
		}, function(ret, err) {
		});
	}
	/*
	*author:zhaoj
	*function:设置列表数据点赞数量显示
	*date：20170914
	*/
	function setIndexFramePraiseNum(){
		isExistsPraise(0);
		getPraiseinfoList();
		commonExecScript('quanziIpad_index_window','quanziIpad_index_frame','setIndexFramePraiseOrCommentNum(0,'+oparam.praise+','+oparam.id+');',1);
	}
	/*
	*author:zhaoj
	*function:设置列表评论数量显示
	*date：20170914
	*/
	function setIndexFrameCommentNum(type){
		initData(1);
		if(type){
			oparam.comment++;
		}else{
			oparam.comment--;
		}
		commonExecScript('quanziIpad_index_window','quanziIpad_index_frame','setIndexFramePraiseOrCommentNum(1,'+oparam.comment+','+oparam.id+');',1);
	}
	/*
	*author:zhaoj
	*function:删除圈子
	*date：20170914
	*/
	function deleteArticle(){
		showSelfProgress('删除中...');
		var ids = [{"id":oparam.id,"category_id":oparam.category_id,"expand_id":oparam.expand_id}];
		api.ajax({
			url : BASE_URL_ACTION + '/blog/deleteArticle',
			method : 'post',
			dataType : 'json',
			timeout : 30,
			cache : false,
			data : {
				values : {
					"random_num":creatRandomNum(),
		            "ids": JSON.stringify(ids)
				}
			},
			headers : {
				'Cookie' : 'person_id='+$api.getStorage("person_id")+';identity_id='+$api.getStorage("identity")+'; token='+$api.getStorage("token_ypt")+';'
			}
		}, function(ret, err) {
			api.hideProgress();
			if(err){
	            popToast('删除失败');
			} else {
				if(ret.success) {	
					commonExecScript('quanziIpad_index_window','quanziIpad_index_frame','setIndexFramePraiseOrCommentNum(2,0,'+oparam.id+');',1);
					setTimeout(function() {
						closeFrame();
					}, 100);
				} else {
					popToast('删除失败');
				}
			}
		});
	}
</script>
</html>