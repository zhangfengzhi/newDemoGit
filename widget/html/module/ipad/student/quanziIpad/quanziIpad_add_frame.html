<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>圈子</title>
    <link rel="stylesheet" type="text/css" href="../../../../../css/aui/aui.css"/>
    <link rel="stylesheet" type="text/css" href="../../../../../css/module/ipad/popup-body.css"/>
    <link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
    <style>
    	.popup-body-new	.commont-content{padding:52px 0 50px 0;}
    	.content-name{height:60px;}
    	input[type='text'],textarea{border:none;margin-bottom:0;}
    	input[type='text']{height:59px;border-bottom:1px dashed #aaaaaa;padding:10px 0;}
    	textarea{height:165px;padding:20px;max-height:165px;overflow-y: auto;}
    	.popup-body-new .commont-content .position{font-size:16px;padding:20px 0 0 30px;}
    </style>
</head>
<body class="popup-body-new common-ipad-quanziIpadstu">
	<div id="j_select_picture" class="select-picture-bg aui-hide">
		<div class="select-picture">
			<div class="option" onclick="getAlbum();">图片</div>
			<div class="option" onclick="openPicture();">拍照</div>
			<div class="option" onclick="commonExecScript('quanziIpad_index_window','','back();',0);">取消</div>
		</div>
	</div>
	<div class="commont-content">
		<div class="top fl">
			<div class="name">发表班级圈</div>
			<div class="close fr" onclick="closeFrame();"></div>
		</div>
		<div class="content">
			<div class="content-name plr20 clearfix ">
				<input oninput="commonRemoveExpression(this)" id="j_title" type="text" placeholder="标题，最多支持40字符（必填）" maxlength ='40' />
			</div>
			<div class="content-text plr120 clearfix ">
				<textarea id="j_content" placeholder="请输入内容" rows="4"></textarea>
			</div>
			<div class="add-img-file">
				<ul id="j_files">
					<li id="j_add_btn" class="add-btn fl" onclick="selectPicture();">
						<a class="aui-iconfont aui-icon-add fl"></a>
					</li>
				</ul>
			</div>
		</div>
		<div class="btn" onclick="getArticleValue();">保存</div>
	</div>
</body>
<script type="text/javascript" src="../../../../../script/api.js"></script>
<script type="text/javascript" src="../../../../../script/base_config.js" ></script>
<script type="text/javascript" src="../../../../../script/common/common.js"></script>
<script type="text/javascript" src="../../../../../script/assembly/UIAlbumBrowser.js"></script>
<script type="text/javascript" src="../../../../../script/assembly/getPicture.js"></script>
<script type="text/javascript" src="../../../../../script/assembly/photoBrowser.js"></script>
<script type="text/javascript">
	var storage_json;//缓存中的数据
	var xx_fl_id = 0;
	var gr_fl_id = 0;
	var lx_id = 0;
	apiready = function(){
		commonSetTheme({"level":5,"type":0});
		storage_json = $api.strToJson($api.getStorage('quanziIpad_infor_'+$api.getStorage('identity')+'_'+$api.getStorage('person_id')));//从缓存中取出当前人记录的
		getCategory('',1,'');//个人分类
		getCategory(storage_json.org_id,105,storage_json.org_name);//班级分类
		getCategory($api.getStorage('school_id'),104,$api.getStorage('school_name'));//学校分类
	};
	/*
	*author:zhaoj
	*function:关闭页面
	*date：20170912
	*/
	function closeFrame(){
		commonExecScript('quanziIpad_index_window','','back();',0);
	}
	/*
	*author:zhaoj
	*function:选择图片
	*date：20170914
	*/
	function selectPicture(){
		commonExecScript('quanziIpad_index_window','','reBackType("picture");',0);
		$api.removeCls($api.byId('j_select_picture'),'aui-hide');
	}
	/*
	*author:zhaoj
	*function:关闭选择图片
	*date：20170914
	*/
	function closePicture(){
		$api.addCls($api.byId('j_select_picture'),'aui-hide');
	}
	/*
     *author:zhaoj
     *function:选择图片
     *date：20170914
     */
    function getAlbum() {
		var num = 9 - judgeImgCount();
	    if(num != 0){
            UIAlbumBrowser.open(num,function(data){
                //递归上传图片
                commonUiUploadFiles({"data":data,"is_trans":1}, function(ret_data) {
                    for(var i = 0; i < ret_data.length; i++){
                        var json_data = JSON.parse(ret_data[i]);
                        var file_id = json_data.file_id;
                        var ext = json_data.ext;
                        var param_json = {"file_id" : file_id,"ext" : ext};
                        showPicture(param_json);
                    }
                    commonExecScript('quanziIpad_index_window','','back();',0);
                })
            })
        }else{
            popToast('最多上传9张图片');
        }
    }
    /*
     *author:zhaoj
     *function:打开拍照
     *date：20170914
     */
    function openPicture(){
    	getPicture.open({"type":1},function(data){
            //递归上传图片
            commonUiUploadFiles({"data":data,"is_trans":0}, function(ret_data) {
                for(var i = 0; i < ret_data.length; i++){
                    var json_data = JSON.parse(ret_data[i]);
                    var file_id = json_data.file_id;
                    var ext = json_data.ext;
                    var param_json = {"file_id" : file_id,"ext" : ext};
                    showPicture(param_json);
                }
                commonExecScript('quanziIpad_index_window','','back();',0);
            })
        });
    }
   
    /*
 	*author:zhaoj
 	*function:显示图片
 	*date：20170914
 	*/
    function showPicture(param_json){
    	var img_url='';//图片路径
    	var img_url_original="";//原图
    	if (BASE_APP_TYPE == 1) {
			img_url = BASE_IMAGE_PRE+"down/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext + commonReturnPhotoCutSize(0);	
			img_url_original = 	BASE_IMAGE_PRE+"down/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext;		
		} else {
			img_url = BASE_URL_ACTION + "/html/thumb/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext + commonReturnPhotoCutSize(0);
			img_url_original = BASE_URL_ACTION + "/html/thumb/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext;
		}
		var error_html ="this.src='../../../../../image/yingyong/weike/wk_default.png'";
    	var li_html = '<li class="fl">';
			li_html += '<img class="j_img" onclick="openImg(this);" openSrc="'+img_url_original+'" onerror="'+error_html+'" src="'+img_url+'" />';
			li_html += '<div class="delete" onclick="deleteImg(event,this);"></div>';
			li_html += '</li>';
    	$api.before($api.byId('j_add_btn'), li_html);
    	judgeImgCount();
    }
    /*
 	*author:zhaoj
 	*function:删除图片
 	*date：20170915
 	*/
    function deleteImg(e,self){
    	var parent = self.parentNode;
    	var grandpa = parent.parentNode;
    	grandpa.removeChild(parent);
    	judgeImgCount();
    	e.stopPropagation();
    }
    /*
 	*author:zhaoj
 	*function:打开图片
 	*date：20170915
 	*/
    function openImg(self){
    	var parent = self.parentNode;
    	var grandpa = parent.parentNode;
    	//获取当前文件的位置
    	var index;
		if (parent) {
			index = 0;
			while ( parent = parent.previousSibling) {
				if (parent.nodeType == 1)
					index++;
			}
		}
		//获取图片路径
		var openImgArray = [];
		var imgArray = $api.domAll($api.byId('j_files'), '.j_img');
		for (var i = 0; i < imgArray.length; i++) {
			openImgArray.push($api.attr(imgArray[i], 'openSrc'));
		}
		openPictureShowWin(openImgArray,index)
    }
    /*
 	*author:zhaoj
 	*function:判断图片的数量
 	*date：20170915
 	*/
    function judgeImgCount(){
    	var imgArray = $api.domAll($api.byId('j_files'), '.j_img');
    	if(imgArray.length == 9){
    		commonAddOrRemoveHideCss('j_add_btn',0);
    	}else{
    		commonAddOrRemoveHideCss('j_add_btn',1);
    	}
    	return imgArray.length;
	}
    /*
	*author:zhaoj
	*function:获取文章的值
	*date：20170915
	*/
	function getArticleValue() {
		//文章标题
		var article_title = $api.val($api.byId('j_title'));
		//文章文字内容
		var article_content = $api.val($api.byId('j_content'));
		//个人id
		person_category_id = gr_fl_id;
		//本校id
		org_category_id = xx_fl_id;
		//班级id
		b_category_id = bjflID;
		//图片缩略图
		var thumb_id;
		//图片缩略图数组
		var thumb_ids = new Array();
		//简介
		var overview;
		if (article_content.length > 100) {
			overview = article_content.substring(0, 100);
		} else {
			overview = article_content;
		}
		//文章加上图片和文字的整体内容
		var content = article_content;
		//验证文章标题
		var article_title_vad = $api.trimAll(article_title);
		if (article_title_vad.length == 0) {
			popAlert("标题不能为空！");
			return;
		}
		//验证是否有附件
		var dlArray = $api.domAll($api.byId('j_files'), '.j_img');
		if (dlArray.length != 0) {
			var img_suffix = commonReturnPhotoCutSize(0);
			if (BASE_APP_TYPE == 2) {
				for (var i = 0; i < dlArray.length; i++) {
					if (i == 0) {
						thumb_id = $api.attr(dlArray[i], 'src');
						var startIndex = thumb_id.indexOf('/dsideal_yy/');
						thumb_id = thumb_id.substring(startIndex,thumb_id.length);
						thumb_id = thumb_id.replaceAll(img_suffix, '');
					}
					var img_url = $api.attr(dlArray[i], 'src');
					img_url = img_url.substring(startIndex,img_url.length);
					img_url = img_url.replaceAll(img_suffix, '');
					thumb_ids.push(img_url);
					var img_html = '<img src="' + img_url + '" alt="" />'
					content = content + img_html;
				}
			} else {
				for (var i = 0; i < dlArray.length; i++) {
					if (i == 0) {
						thumb_id = $api.attr(dlArray[i], 'src');
						thumb_id = thumb_id.replaceAll(img_suffix, '');
					}
					var img_url = $api.attr(dlArray[i], 'src');
					img_url = img_url.replaceAll(img_suffix, '');
					var img_html = '<img src="' + img_url + '" alt="" />'
					thumb_ids.push(img_url);
					content = content + img_html;
				}
			}
		}
		//验证文章内容
		var article_content_vad = $api.trimAll(article_content);
		if (article_content_vad.length == 0 && dlArray.length == 0) {
			popAlert("内容不能为空！");
			return;
		}
		var value ={}; 
		var org_type = storage_json.org_type;
		if(org_type == 0 || org_type == 1 || org_type == 104){
			//学校
			value={"person_id":$api.getStorage("person_id"),"person_name":$api.getStorage('person_name'),"identity_id" : $api.getStorage("identity"),"business_type" : 1,"title" : article_title,"city_id" : $api.getStorage('city_id'),"district_id" : $api.getStorage('district_id'),"province_id" : $api.getStorage('province_id'),"school_id" : $api.getStorage('school_id'),"person_category_id" : person_category_id,"org_category_id" : org_category_id,"id" : "","content" : content,"overview" : overview,"thumb_id" : thumb_id,"thumb_ids" : JSON.stringify(thumb_ids)};
		}else{
			//班级
			value={"person_id":$api.getStorage("person_id"),"person_name":$api.getStorage('person_name'),"identity_id" : $api.getStorage("identity"),"business_type" : 3,"title" : article_title,"city_id" : $api.getStorage('city_id'),"district_id" : $api.getStorage('district_id'),"province_id" : $api.getStorage('province_id'),"school_id" : $api.getStorage('school_id'),"person_category_id" : person_category_id,"b_category_id" : b_category_id,"org_category_id" : org_category_id,"id" : "","content" : content,"overview" : overview,"thumb_id" : thumb_id,"thumb_ids" : JSON.stringify(thumb_ids),"business_id":storage_json.org_id,"business_iid":105};
		}
		saveArticle(JSON.stringify(value));
	}
	/*
	 *author:zhaoj
	 *function:保存文章
	 *date：20160415
	 */
	function saveArticle(value){
		var org_type = storage_json.org_type;
		if(org_type == 0 || org_type == 1 || org_type == 104){
			typeUrl = BASE_URL_ACTION + '/ypt/blog/saveArticle';
		}else{
			typeUrl = BASE_URL_ACTION + '/ypt/blog_expand/save_article_expand';
		}
		showSelfProgress('发表中...');
		var dataValue = JSON.parse(value);
		api.ajax({
			url : typeUrl,
			method : 'post',
			dataType : 'json',
			timeout : 30,
			cache : false,
			returnAll : false,
			data : {
				values : dataValue
			},
			headers : {
				'Cookie' : 'person_id=' + $api.getStorage("person_id") + ';identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
			}
		}, function(ret, err) {
			if (err) {
				api.hideProgress();
				popToast('发表失败，请稍候重试');
			} else {
				if (ret.success) {
					//添加积分
					var options = {
                        business_type:107,
                        relatived_id:ret.id,
                        r_person_id:"",
                        r_identity_id:"",
                        operation_content:$api.getStorage("person_name") + '发表了圈子' + dataValue.title + '。',
                        e_relatived_id:ret.expand_id
                    };
					if (org_type == 105) {
                        options.business_type = 131;
                        options.r_person_id = storage_json.org_id;
                        options.r_identity_id = 105;
                    }
                    creditWriteToQueue(options);
                    setTimeout(function(){
                    	api.hideProgress();
                    	//刷新index数据列表
                    	commonExecScript('quanziIpad_index_window','quanziIpad_index_frame','initData(1);',1);
                    },2900);  
                    setTimeout(function(){
                    	//关闭添加页面
                    	commonExecScript('quanziIpad_index_window','','back();',0);
                    },3000);        
				} else {
					api.hideProgress();
					popToast('发表失败，请稍候重试');
				}
			}
		});
	}
	
	function extend(destination, source) { 
	    for (var property in source) 
		destination[property] = source[property]; 
	    return destination; 
	}
	/*
	 *author:zhaoj
	 *function:获取分类
	 *date：20160425
	 */
	function getCategory(org_id,org_type,org_name) {
		var type_url = BASE_URL_ACTION + '/blog/getCategory?';
		switch(org_type){
			case 0:
				type_url = type_url + 'business_id=1&business_type=1&level=1&identity_id=' + $api.getStorage('identity') + '&random_num=' + creatRandomNum();
				break;
			case 1:
				type_url=type_url+'person_id='+$api.getStorage("person_id")+'&identity_id='+$api.getStorage("identity")+'&business_type=1&business_id='+$api.getStorage("person_id")+'&business_iid='+$api.getStorage("identity")+'&level=2&random_num='+creatRandomNum();
				break;
			case 101:
				type_url = type_url + 'business_id='+org_id+'&person_id='+org_id+'&business_type=1&level=1&identity_id=' + org_type + '&business_iid='+org_type+ '&random_num=' + creatRandomNum();
				break;
			case 102:
				type_url = type_url + 'business_id='+org_id+'&person_id='+org_id+'&business_type=1&level=1&identity_id=' +org_type + '&business_iid='+org_type+ '&random_num=' + creatRandomNum();
				break;
			case 103:
				type_url = type_url + 'business_id='+org_id+'&person_id='+org_id+'&business_type=1&level=1&identity_id=' + org_type + '&business_iid='+org_type+ '&random_num=' + creatRandomNum();
				break;
			case 104:
				//现在是专栏分类，也就是默认分类
				type_url = type_url + 'business_id=1&business_type=1&level=1&identity_id=' + $api.getStorage('identity') + '&random_num=' + creatRandomNum();
				break;
			case 105:
				type_url = type_url + 'business_id='+org_id + '&person_id='+org_id + '&business_iid='+org_type+ '&identity_id=' + org_type + '&level='+1 + '&business_type='+3;
				break;
		}
		api.ajax({
			url : type_url,
			method : 'get',
			timeout : 30,
			dataType : 'json',
			headers : {
				'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
			}
		}, function(ret, err) {
			api.hideProgress();
			if (ret) {
				if (ret.success == false) {
					var data ={'list':[]};
					if(org_type==1){
						grfl(data);
					}else if(org_type == 104){
						bxfl(data);
					}else if(org_type == 105){
						bjfl(data,org_id,org_name);
					}
				} else {
					if(org_type==1){
						grfl(ret);
					}else if(org_type == 104){
						bxfl(ret);
					}else if(org_type == 105){
						bjfl(ret,org_id,org_name);
					}
				}
			} else {
				var data ={'list':[]};
				if(org_type==1){
					grfl(data);
				}else if(org_type == 104){
					bxfl(data);
				}else if(org_type == 105){
					bjfl(data,org_id,org_name);
				}
			}
		});
	}
	/*
	 *author:zhaoj
	 *function:设置个人分类
	 *date：20160425
	 */
	function grfl(data){
		var fl_list = data.list;
		var fl_list_l = getJsonObjLength(fl_list);
		if (fl_list_l > 0) {
			gr_fl_id = fl_list[0].id;
		} else {
			api.ajax({
				url : BASE_URL_ACTION + '/ypt/blog/savePersonCategory',
				method : 'post',
				dataType : 'json',
				timeout : 30,
				cache : false,
				data : {
					values : {
						"random_num":creatRandomNum(),
			            "person_id": $api.getStorage("person_id"),
			            "person_name":$api.getStorage('person_name'),
			            "identity_id":$api.getStorage("identity"),
			            "business_type": 1,
			            "business_id": $api.getStorage("person_id"),
			            "business_iid":$api.getStorage("identity"),
			            "level":2,
			            "sequence":1,
			            "name" :'默认分类'
					}
				},
				headers : {
					'Cookie' : 'person_id='+$api.getStorage("person_id")+';identity_id='+$api.getStorage("identity")+'; token='+$api.getStorage("token_ypt")+';'
				}
			}, function(ret, err) {
				if(err){
					popToast('服务器连接失败，请稍候再试');
				}else{
					if(ret.success) {
						getCategory('',1,'');	
					} else {
						popToast('服务器连接失败，请稍候再试');			
					}
				}
			});	
		}
	}
	/*
	 *author:zhaoj
	 *function:设置班级分类
	 *date：20160425
	 */
	function bjfl(data,org_id,org_name){
		var fl_list = data.list;
		var fl_list_l = getJsonObjLength(fl_list);
		if (fl_list_l > 0) {
			bjflID = fl_list[0].id 
			//机构分类添加点击事件
		}
	}
	/*
	 *author:zhaoj
	 *function:设置本校分类
	 *date：20160425
	 */
	function bxfl(data){
		var fl_list = data.list;
		var fl_list_l = getJsonObjLength(fl_list);
		if (fl_list_l > 0) {
			xx_fl_id = fl_list[0].id;
		}
	}
</script>
</html>