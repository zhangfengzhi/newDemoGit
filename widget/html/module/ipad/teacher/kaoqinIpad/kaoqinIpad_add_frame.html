<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>考勤申请</title>
		<link rel="stylesheet" type="text/css" href="../../../../../css/aui/aui.css"/>
		<link rel="stylesheet" type="text/css" href="../../../../../css/module/ipad/popup-body.css"/>
		<link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
		<style>
			.time-content{height:40px;line-height:40px;padding:0 15px;color:#141414;}
	    	.time-content div{display:inline-block;float:right;color:#666666;}
	    	.bb{border-bottom:1px solid #efefef;}
	    	.bt{border-top:1px solid #efefef;}
	    	.hr{height:10px;}
	    	.bgf{background:#ffffff;}
	    	.input-time[type="text"]{display: inline-block;width: 40px;padding: 9px 0 6px 0;text-align:center;height:39px;}
	    	.common-name span{float:right;line-height: 45px;}
	    	.tip{padding:15px 0 10px 15px;font-size:14px;color:#ff0000;}
	    	.mt60{margin-top:55px !important;}
	    	.mb10 {margin-bottom: 10px !important;}
			.common-name{margin-top:60px !important;border-top: 1px solid #efefef;}
			.common-name input{margin-top:16px;}
	    	input[type="text"]{padding-left:0;height:45px;}
	    	.common-content{display:inline-block;width:65%;line-height:45px;float:right;text-align:right;}
	    	.ellipsis{white-space: nowrap;overflow: hidden;text-overflow: ellipsis;}
	    	.aui-switch{margin-top:10px;}
	    	select{margin-bottom:0;border:none;height:45px;padding:0;}
	    	.common-btn {width:100%;}
	    	.aui-iconfont {color: #666666;}
	    	.popup-body-new	.commont-content{padding:52px 0 50px 0;}
	    	.content-name{height:60px;}
	    	input[type='text'],textarea{border:none;margin-bottom:0;}
	    	input[type='text']{height:59px;padding:10px 0;}
	    	textarea{height:86px;padding:20px;max-height:86px;overflow-y: auto;}
	    	.popup-body-new .commont-content .position{font-size:16px;padding:20px 0 0 30px;}
	    	.popup-body-new .commont-content{width: 620px;height: 558px;margin-left: -310px;margin-top: -279px;}
	    	.vm-line{line-height:60px;}
	    	.borderb{border-bottom:1px solid #efefef;background:#ffffff;margin: 0 20px;padding: 0;}
	    	.manage{height:50px;}
	    	.rela{position:relative;}
	    	.triangle-top{position:absolute;top:-9px;right:15px;display:inline-block;width: 0; height: 0;border-right: 9px solid transparent;opacity: 0.9;border-left: 9px solid transparent;}
	    	.popup-body-new .select-menu{position: absolute;z-index: 9999;text-align: center;width: 170px;right: 0px;top:57px;color: #fff;opacity: 0.9;border-radius: 10px;}
	    	.popup-body-new .select-menu div{line-height:40px; font-size:15px;border-bottom:1px solid #eee;}
	    	.bbn{border-bottom:0 !important;}
		</style>
	</head>	
	<body class="popup-body-new common-ipad-kaoqinIpad-tea">
		<div id="j_select_picture" class="select-picture-bg aui-hide">
			<div class="select-picture">
				<div class="option" onclick="getAlbum();">图片</div>
				<div class="option" onclick="openPicture();">拍照</div>
				<div class="option" onclick="closePicture();">取消</div>
			</div>
		</div>
		<div class="commont-content">
			<div class="top fl">
				<div class="name">申请</div>
				<div class="close fr" onclick="closeFrame();"></div>
			</div>
			<div id="sq_div" class="content-name plr20 clearfix vm-line borderb rela" onclick="showSqMenu();">
				<label class="fl">申请类型</label>
				<div class="manage fr">
					<a class="aui-iconfont aui-icon-right"></a>
				</div>
				<label id="j_select_sq" class="fr">请假</label>
				<div id="j_select_sq_menu" class="aui-hide">
					<div class="select-menu">
						<p class="triangle-top">&nbsp;</p>
						<div class="option" onclick="verExitContent(event);">请假</div>
						<div class="option" onclick="verExitContent(event);">公出</div>
						<div class="option bbn" onclick="closeSqMenu(event)">取消</div>
					</div>
				</div>
			</div>
			<div id="style_div" class="content-name plr20 clearfix vm-line borderb rela" onclick="showTypeMenu();">
				<label class="fl" id="j_type">请假类型</label>
				<div class="manage fr">
					<a class="aui-iconfont aui-icon-right"></a>
				</div>
				<label id="style" class="fr"></label>
				<div id="j_select_type_menu" class="aui-hide">
					<div class="select-menu" id="style_body">
						<script type="text/html" id="style_script">
							<p class="triangle-top">&nbsp;</p>
							<%for(var i=0; i<list.length; i++) {%>
								<div class="option" onclick='selectedType(event,"<%=list[i].name%>",<%=list[i].id%>)' flag=<%=list[i].right%> styleID=<%=list[i].id%> >
									<%=list[i].name%>
								</div>
							<% } %>
							<div class="option bbn" onclick="closeTypeMenu(event)">取消</div>
						</script>
						
					</div>
				</div>
			</div>
			<div class="content-text plr120 clearfix ">
					<textarea id="j_content" onscroll="this.rows++;" placeholder="请输入内容（必填）"></textarea>
			</div>
			<div class="add-img-file">
				<ul id="j_files">
					<li id="j_add_btn" class="add-btn fl" onclick="selectPicture();">
						<a class="aui-iconfont aui-icon-add fl"></a>
					</li>
				</ul>
			</div>
			
			<div class="content-name plr20 clearfix vm-line borderb rela mt60" onclick="openPickerTime(0);">
				<label class="fl">开始时间</label>
				<label id="start_time" class="fr"></label>
			</div>
			<div class="content-name plr20 clearfix vm-line borderb rela" onclick="openPickerTime(1);">
				<label class="fl">结束时间</label>
				<label id="end_time" class="fr"></label>
			</div>
			<div class="content-name plr20 clearfix vm-line borderb rela" onclick="openPickerTime(1);">
				<label class="fl">合计时间</label>
					<div id="total_time" class="fr">
						<input id="j_days" class="input-time" type="text" disabled="disabled" />天
						<input id="j_hours" class="input-time" type="text" disabled="disabled" />时
						<input id="j_minutes" class="input-time" type="text" disabled="disabled" />分
					</div>
			</div>
			<div class="tip">注：合计时间根据公司上下班时间进行计算！</div>
			<div class="btn" onclick="addLeaveInfo();">保存</div>
		</div>
	</body> 
	<script type="text/javascript" src="../../../../../script/api.js"></script>
	<script type="text/javascript" src="../../../../../script/base_config.js" ></script>
	<script type="text/javascript" src="../../../../../script/plug-in/template.js" ></script>
	<script type="text/javascript" src="../../../../../script/assembly/UIAlbumBrowser.js"></script>
	<script type="text/javascript" src="../../../../../script/assembly/getPicture.js"></script>
	<script type="text/javascript" src="../../../../../script/assembly/photoBrowser.js"></script>
	<script type="text/javascript" src="../../../../../script/common/common.js"></script>
	<script type="text/javascript" src="../../../../../script/common/kaoqinIpad_common.js"></script>
	<script type="text/javascript">
		//判读是请假还是公出，默认是请假
		var type = 0;
		var header_h;
		var img_size;8888
		var BASE_SERVER_NAME;
		var BASE_URL_ACTION;
		var BASE_APP_TYPE;
		var obj_scan;
		var ruleType = 1;//1请假，2公出
		var per_id = $api.getStorage("person_id");
		apiready = function() {
			commonSetTheme({"level":5,"type":0});
			header_h = api.pageParam.header_h;
			BASE_URL_ACTION = $api.getStorage('BASE_URL_ACTION');
			BASE_APP_TYPE = $api.getStorage('BASE_APP_TYPE');
			BASE_SERVER_NAME = $api.getStorage('BASE_SERVER_NAME');	
			if (api.pageParam.type == 0) {
				//请假
				$api.text($api.byId('j_select_sq'), '请假');
			} else if (api.pageParam.type == 1) {
				//公出
				$api.text($api.byId('j_select_sq'), '公出');
			}
			changeType(api.pageParam.type);
		};
		/*
		 *author:zhaoj
		 *function:更改是请假还是公出的状态type：0请假，type：1公出
		 *date：20160620
		 */
		function changeType(num) {
			type = num;
			setTime(0,getNowTime(2));//开始时间
			var endTime = Date.parse(getNowTime(2).replace(/-/g,'\/'))+24*3600*1000;
			setTime(1,getDate(endTime));//结束时间
			var styleDiv = document.getElementById('style_div');
			var typeId = styleDiv.getAttribute('styleID');
			if (type) {
				ruleType = 2;
				$api.text($api.byId('j_type'), '公出类型');
				initTypeData(ruleType,2);
				$api.attr($api.byId('j_content'), 'placeholder', '请输入公出事由（必填）');
				//获取时间段
				getSinglePersonWaiChuInfo(typeId,getNowTime(2),getDate(endTime),function(flag,ret){
					if(flag){
						$api.val($api.byId('j_days'), ret.days);
						$api.val($api.byId('j_hours'), ret.hours);
						$api.val($api.byId('j_minutes'), ret.minutes);
					}else{
						getTimeSlot(getNowTime(2),getDate(endTime));
					}
				});
				//isAllowInput(false)
			} else {
				ruleType = 1;
				$api.text($api.byId('j_type'), '请假类型');
				initTypeData(ruleType,1);
				$api.attr($api.byId('j_content'), 'placeholder', '请输入请假事由（必填）');
				getSinglePersonLeaveInfo(typeId,getNowTime(2),getDate(endTime),function(flag,ret){
					if(flag){
						$api.val($api.byId('j_days'), ret.days);
						$api.val($api.byId('j_hours'), ret.hours);
						$api.val($api.byId('j_minutes'), ret.minutes);
					}else{
						getTimeSlot(getNowTime(2),getDate(endTime));
					}
				});
				//isAllowInput(true);
			}
			setImgBtnHeight();
		}
		/*
		 *author:zhaoj
		 *function:设置添加图片按钮的高度
		 *date：20160623
		 */
		function setImgBtnHeight(){
			var addBtnWidth = $api.cssVal($api.byId('j_add_btn'), 'width');
			$api.css($api.dom($api.byId('j_add_btn'),'dt'), 'height:'+addBtnWidth+';line-height:'+(addBtnWidth.replaceAll('px','')*1-4)+'px;');
		}
		/*
		 *author:zhaoj
		 *function:添加点击事件
		 *date：20160316
		 */
		function addClickedEvent(div_name, method_name) {
			var name = document.getElementById(div_name);
			name.addEventListener("click", method_name);
		}
		
		/*
		 *author:zhaoj
		 *function:根据模块获取子文件的个数
		 *date：20160224
		 */
		function getfilesNum() {
			var dlArray = $api.domAll($api.byId('j_files'), '.j_img');
			return dlArray.length;
		}
		
		/*
		 *author:zhaoj
		 *function:图片格式
		 *date：20160222
		 */
		function getImgSize() {
			img_size = (api.winWidth - 30) * 0.18;
			img_size = Math.floor(img_size);
			var img_format = '@' + img_size + 'w_' + img_size + 'h_100Q_1x.';
			return img_format;
		}	

		/*
		*author:zhaoj
		*function:选择时间type=1开始时间，type=2结束时间
		*date：20160622
		*/
		function openPickerTime(type){
			var nowDay;
			var nowTime;
			var title;
			var title1;
			if(type==0){
				nowDay = $api.text($api.byId('start_time')).substring(0,10);
				nowTime = $api.text($api.byId('start_time')).substring(0,16);
				title ='开始时间';
				title1 = '开始日期';
				
			}else{
				nowDay = $api.text($api.byId('end_time')).substring(0,10);
				nowTime = $api.text($api.byId('end_time')).substring(0,16);
				title ='结束时间';
				title1 = '结束日期';
			}
			var styleDiv = document.getElementById('style_div');
			var typeId = styleDiv.getAttribute('styleID');
			if(api.systemType=='android'){
			    api.openPicker({
			        type: 'date',
					date: nowDay,
			        title:title1,
			    },function(ret,err){
					if(ret){
				        var year = ret.year;
				        var month = ret.month;
						month = month > 9 ? month : '0'+month;
				        var day = ret.day;
						day = day > 9 ? day : '0'+day;
				        //这是选择的是日期
				        var value1 = year+'-'+month+'-'+day;
				        //选择时间
						setTimeout(function(){
							api.openPicker({
					            type: 'time',
								date: nowTime,
					            title:title
					        },function(ret,err){
					            var hours = ret.hour;
								hours  = hours  > 9 ? hours  : '0'+ hours;
					            var minutes = ret.minute;
								minutes  = minutes  > 9 ? minutes  : '0'+ minutes;
					            var value2 = hours+':'+minutes;
					            var time = value1+' '+value2;
								var time1 = Date.parse(value1.replace(/-/g,'\/'))+24*3600*1000;
								time1 = getDate(time1).substring(0,10)+' '+value2; 
					            //组装一下
								if(type == 0){
						    		//开始时间
						    		setTime(0,time);
						    		//结束时间
						    		setTime(1,time1);
						    		getTimeSlot(time,time1);
						    		//选择结束时间
						    		setTimeout(function(){
						    			openPickerTime(1);
						    		},250);
						    	}else{
									if(Date.parse($api.text($api.byId('start_time')).replace(/-/g,'\/'))<Date.parse(time.replace(/-/g,'\/'))){
						    			setTime(1,time);
						    			//获取时间段
							    		if(ruleType == 2){	    											getSinglePersonWaiChuInfo(typeId,$api.text($api.byId('start_time')),time,function(flag,ret){
												if(flag){
													$api.val($api.byId('j_days'), ret.days);
													$api.val($api.byId('j_hours'), ret.hours);
													$api.val($api.byId('j_minutes'), ret.minutes);
												}else{
													getTimeSlot($api.text($api.byId('start_time')),time);
												}
											});
						    			}else{
						    				getSinglePersonLeaveInfo(typeId,$api.text($api.byId('start_time')),time,function(flag,ret){
												if(flag){
													$api.val($api.byId('j_days'), ret.days);
													$api.val($api.byId('j_hours'), ret.hours);
													$api.val($api.byId('j_minutes'), ret.minutes);
												}else{
													getTimeSlot($api.text($api.byId('start_time')),time);
												}
											})
						    			}
						    		}else{
						    			popAlertBackData('结束时间不能小于开始时间，请重新选择！',function(flag){
						    				openPickerTime(1);
						    			})
						    		}
						    	}
					        });
						},250);
					}
				});
			}else{
				api.openPicker({
			        type: 'date_time',
					date: nowTime,
			        title:title
			    },function(ret,err){
			        var year = ret.year;
			        var month = ret.month;
					month = month > 9 ? month : '0'+month;
			        var day = ret.day;
					day = day > 9 ? day : '0'+day;
					var hours = ret.hour;
					hours  = hours  > 9 ? hours  : '0'+ hours;
		            var minutes = ret.minute;
					minutes  = minutes  > 9 ? minutes  : '0'+ minutes;
			        //这是选择的是日期
					var value1=year+'-'+month+'-'+day;
			        var time = year+'-'+month+'-'+day+' '+hours+':'+minutes;
					var time1 = Date.parse(value1.replace(/-/g,'\/'))+24*3600*1000;
					time1 = getDate(time1).substring(0,10)+' '+hours+':'+minutes;
			        if(type == 0){
			    		//开始时间
			    		setTime(0,time);
			    		//结束时间
			    		setTime(1,time1);
			    		//选择结束时间
			    		setTimeout(function(){
			    			openPickerTime(1);
			    		},250);
			    	}else{
						if(Date.parse($api.text($api.byId('start_time')).replace(/-/g,'\/'))<Date.parse(time.replace(/-/g,'\/'))){
			    			setTime(1,time);
			    			//获取时间段
			    			if(ruleType == 2){
			    				getSinglePersonWaiChuInfo(typeId,$api.text($api.byId('start_time')),time,function(flag,ret){
									if(flag){
										$api.val($api.byId('j_days'), ret.days);
										$api.val($api.byId('j_hours'), ret.hours);
										$api.val($api.byId('j_minutes'), ret.minutes);
									}else{
										getTimeSlot($api.text($api.byId('start_time')),time);
									}
								});
			    			}else{
			    				getSinglePersonLeaveInfo(typeId,$api.text($api.byId('start_time')),time,function(flag,ret){
									if(flag){
										$api.val($api.byId('j_days'), ret.days);
										$api.val($api.byId('j_hours'), ret.hours);
										$api.val($api.byId('j_minutes'), ret.minutes);
									}else{
										getTimeSlot($api.text($api.byId('start_time')),time);
									}
								})
			    			}
			    		}else{
			    			popAlertBackData('结束时间不能小于开始时间，请重新选择！',function(flag){
			    				openPickerTime(1);
			    			})
			    		}
			    	}
			    });
			} 
		}
		/*
		*author:zhaoj
		*function:是否允许输入框输入
		*date：20160730
		*/
		function isAllowInput(flag){
			if(flag){
				$api.attr($api.byId('j_days'), 'disabled',flag);
				$api.attr($api.byId('j_hours'), 'disabled',flag);
				$api.attr($api.byId('j_minutes'), 'disabled',flag);
			}else{
				$api.removeAttr($api.byId('j_days'), 'disabled');
				$api.removeAttr($api.byId('j_hours'), 'disabled');
				$api.removeAttr($api.byId('j_minutes'), 'disabled');
			}
		}
		/*
		*author:zhaoj
		*function:获取当前时间,返回年月日
		*date：20160622
		*/
		function getNowTime(type){
			time = new Date();
			var year = time.getFullYear();
			var month = time.getMonth() + 1;
			month = month > 9 ? month : '0'+month;
			var day = time.getDate();
			day = day > 9 ? day : '0'+day;
			var hours = time.getHours();
			hours  = hours  > 9 ? hours  : '0'+ hours;
			var minutes = time.getMinutes();
			minutes  = minutes  > 9 ? minutes  : '0'+ minutes;
			var startTime = year+'-'+month+'-'+day +' '+hours+':'+minutes;
			switch(type){
				case 0:
					return year+'-'+month+'-'+day;
					break;
				case 1:
					return hours+':'+minutes;
					break;
				case 2:
					return year+'-'+month+'-'+day +' '+hours+':'+minutes;;
					break;
				default:
					break;
			}
		}
		/*
		*author:zhaoj
		*function:设置时间type=0开始时间，type=1结束时间
		*date：20160622
		*/
		function setTime(type,time){
			if(type){
				$api.text($api.byId('end_time'), time);
			}else{
				$api.text($api.byId('start_time'), time);
			}
		}
		/*
		*author:zhaoj
		*function:初始化请假类型和公出类型数据
		*date：20160623
		*/
		function initTypeData(rule_type,id){
			getRuleTypeList(1,ruleType,function(flag,data){
				if(flag){
					if(data.list.length > 0){
						modifyStyle(data.list[0].name, data.list[0].id);
						data.rule_type = rule_type;
						for(var i = 0; i <data.list.length; i++){
							if(api.pageParam.id == data.list[i].id){
								data.list[i].right = 1;
							}else{
								data.list[i].right = 0;
							}
						}
						addTemplateHtml('style_body', 'style_script', data,1);
					}else{
						if(ruleType == 1){
							$api.html($api.byId('style'), '暂无请假类型');
						}else{
							$api.html($api.byId('style'), '暂无公出类型');
						}
					}
				}
			})
		}
		/*
		 *author:zhaoj
		 *function:修改请假或公出的类型
		 *date：20160623
		 */
		function modifyStyle(name, id) {
			if(ruleType == 1){
				$api.html($api.byId('style'),name);
				getSinglePersonLeaveInfo(id,$api.text($api.byId('start_time')),$api.text($api.byId('end_time')),function(flag,ret){
					if(flag){
						$api.val($api.byId('j_days'), ret.days);
						$api.val($api.byId('j_hours'), ret.hours);
						$api.val($api.byId('j_minutes'), ret.minutes);
					}else{
						getTimeSlot($api.text($api.byId('start_time')),time);
					}
				});
			}else{
				$api.html($api.byId('style'),name);
				getSinglePersonWaiChuInfo(id,$api.text($api.byId('start_time')),$api.text($api.byId('end_time')),function(flag,ret){
					if(flag){
						$api.val($api.byId('j_days'), ret.days);
						$api.val($api.byId('j_hours'), ret.hours);
						$api.val($api.byId('j_minutes'), ret.minutes);
					}else{
						getTimeSlot($api.text($api.byId('start_time')),time);
					}
				});
			}
			$api.attr($api.byId('style_div'), 'styleID', id);
		}
		/*
		 *author:zhaoj
		 *function:申请请假或公出
		 *date：20160623
		 */
		function addLeaveInfo(){
			var styleDiv = document.getElementById('style_div');
			var typeId = styleDiv.getAttribute('styleID');
			if(!typeId){
				$api.css($api.byId('shadow'),'z-index:-1;');
				if(ruleType == 1){
					popAlert("没有相关的请假类型");
				}else{
					popAlert("没有相关的公出类型");
				}
				return false;
			}
			
			var start_time = $api.text($api.byId('start_time'));
			var end_time = $api.text($api.byId('end_time'));
			if(Date.parse(start_time.replace(/-/g,'\/'))>=Date.parse(end_time.replace(/-/g,'\/'))){
				$api.css($api.byId('shadow'),'z-index:-1;');
				popAlert("开始时间不能大于或等于结束时间");
				return false;
			}
			var content = $api.val($api.byId('j_content'));
			if(content.length == 0){
				$api.css($api.byId('shadow'),'z-index:-1;');
				if(ruleType == 1){
					popAlert("请输入请假事由");
				}else{
					popAlert("请输入公出事由");
				}
				return false;
			}
			var days = $api.val($api.byId('j_days'));
			var hours = $api.val($api.byId('j_hours'));
			var minutes = $api.val($api.byId('j_minutes'));
			if(!days){
				days = 0;
			}
			if(!hours){
				hours = 0;
			}
			if(!minutes){
				minutes = 0;
			}
			if(days==0&&hours==0&&minutes==0){
				$api.css($api.byId('shadow'),'z-index:-1;');
				popAlert("请假时间在休息时间之内，不用请假！");
				return false;
			}
			//验证是否有附件
			var file_id='';
			var dlArray = $api.domAll($api.byId('j_files'), '.j_img');
			if (dlArray.length != 0) {
				for (var i = 0; i < dlArray.length; i++) {
					var img_src = $api.attr(dlArray[i], 'src');
					var firstIndex = img_src.lastIndexOf('/');
					var lastIndex = img_src.lastIndexOf('@');
					img_src = img_src.substring(firstIndex+1,lastIndex);
					if(i != dlArray.length-1){
						file_id = file_id + img_src+',';
					}else{
						file_id = file_id + img_src;
					}
				}
			}
			showSelfProgress('申请中...');
			api.ajax({
				url : BASE_URL_ACTION + '/leave/addLeaveInfo',
				method : 'post',
				timeout : 0,
				dataType : 'json',
				data : {
					values : {
						"random_num" : creatRandomNum(),
						"rule_type" : ruleType,
						"type_id" : typeId,
						"start_time" : start_time,
						"end_time" : end_time,
						"content" : content,
						"days" : days,
						"hours" : hours,
						"minutes" : minutes,
						"file_id" : file_id
					}
				},
				headers : {
		'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
		}
				}, function(ret, err) {
					if (err) {
						api.hideProgress();
						$api.css($api.byId('shadow'),'z-index:-1;');
						popToast('申请失败');
					} else {
						if(ret.success){
							if(ruleType == 1){
								
							}else{
								
							}
							//发送系统消息通知审批
								var target_person = ret.check_person_id + "_5_" + $api.getStorage("BASE_SERVER_NAME");
								if(ret.check_person_id) {
									sendSysMsg(target_person);
								}
							setTimeout(function(){
								popToast('申请成功');
								if(ruleType == 1){
									commonExecScript('kaoqinIpad_wdkq_window','','openQjListFrame();',0);
									commonExecScript('kaoqinIpad_wdkq_window','kaoqinIpad_qjlist_frame','initData(0);',1);
								}else{
									commonExecScript('kaoqinIpad_wdkq_window','','openGcListFrame();',0);
									commonExecScript('kaoqinIpad_wdkq_window','kaoqinIpad_gclist_frame','initData(0);',1);
								}
								commonCloseFrame();
							},3000);
						}else{
							api.hideProgress();
							$api.css($api.byId('shadow'),'z-index:-1;');
							popAlert(ret.info);
						}
					}
			});
		}
		/*
		 *author:zhaoj
		 *function:将毫秒数转换成正常的日期
		 *date：20160624
		 */
		function getDate(end_time) {
			var time = new Date(end_time);
			var year = time.getFullYear();
			var month = time.getMonth() + 1;
			month = month > 9 ? month : '0'+month;
			var day = time.getDate();
			day = day > 9 ? day : '0'+day;
			var hours = time.getHours();
			hours  = hours  > 9 ? hours  : '0'+ hours;
			var minutes = time.getMinutes();
			minutes  = minutes  > 9 ? minutes  : '0'+ minutes;
			return year+'-'+month+'-'+day +' '+hours+':'+minutes;;
		}
		/*
		 *author:zhaoj
		 *function:获取时间段
		 *date：20160630
		 */
		function getTimeSlot(sDataTime,eDataTime){
			var s_data = Date.parse(sDataTime.substring(0,10).replace(/-/g,"/")); 
			var e_data = Date.parse(eDataTime.substring(0,10).replace(/-/g,"/")); 
			var s_time = parseInt(sDataTime.substring(11,13));
			var e_time = parseInt(eDataTime.substring(11,13));
			var s_minutes = parseInt(sDataTime.substring(14,16));
			var e_minutes = parseInt(eDataTime.substring(14,16));
			
			var days = 0;
			var hours = 0;
			var minutes = 0;	
			if ((e_time-s_time) >8){
				days+=Math.floor((e_time-s_time)/8);
				hours+=(e_time-s_time)%8;	
			}else{
				hours = e_time-s_time;
			}
			
			minutes = e_minutes - s_minutes;
			if(minutes < 0 || e_time-s_time < 0){
				minutes = 0;
			}
			
			if(hours < 0){
				hours = 0;
			}
			var time = Math.ceil((e_data-s_data)/(24*60*60*1000));
			if(time == 0){
				days = 0;
			}else{
				days=days+time;
			}
			$api.val($api.byId('j_days'), days);
			$api.val($api.byId('j_hours'), hours);
			$api.val($api.byId('j_minutes'), minutes);
		}
		/*
		 *author:zhaoj
		 *function:验证时间
		 *date：20160630
		 */
		function clearNoNum(obj)
		{
			if(obj.value.match(/[^\d.]/g)){
		   		popAlertBackData('只能输入数字和小数点',function(flag){
    				obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
    			})
    			return false;
		   	}
		   	if(obj.value.match(/^\./g)){
		   		popAlertBackData('第一位必须是数字',function(flag){
    				obj.value = obj.value.replace(/^\./g,"");  //验证第一个字符是数字而不是.
    			})
    			return false;
		   	}
		   if(obj.value.match(/\.{2,}/g)){
		   		popAlertBackData('只能保留一个小数点',function(flag){
    				obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的.
    			})
    			return false;
		   	}
		   obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
		   var index = obj.value.indexOf('.');
		   if(index>0){
		   		if(obj.value.substring(index+1,index+2)*1!=5&&obj.value.substring(index+1,obj.value.length).length==1){
			   		popAlertBackData('小数点之后只能保留一位数字5',function(flag){
	    				obj.value = obj.value.substring(0,index+1)+'5';
	    			})
	    		}else if(obj.value.substring(index+1,obj.value.length).length>1){
	    			popAlertBackData('小数点之后只能保留一位数字',function(flag){
	    				obj.value = obj.value.substring(0,index+2);
	    			})
	    		}
    			return false;
		   }
		}
		function yzhours(obj)
		{
		   	if(obj.value.match(/[^0-7]/g)){
		   		popAlertBackData('只能输入0-7之内的数字',function(flag){
    				obj.value = obj.value.replace(/[^0-7]/g,"");  //清除0-8以外的字符
    			})
    			return false;
		   	}
		   	if(obj.value.length>1){
		   		popAlertBackData('只能输入0-7之内的数字',function(flag){
    				obj.value = obj.value.substring(0,1);
    			})
    			return false;	
		  	}
		}
		function yzMinutes(obj)
		{
		  	if(obj.value.match(/[^0-9]/g)){
		   		popAlertBackData('只能输入0-59之内的数字',function(flag){
    				obj.value = obj.value.replace(/[^0-9]/g,"");  //清除0-8以外的字符
    			})
		   	}
		   	if(obj.value.length>2){
		   		popAlertBackData('只能输入0-59之内的数字',function(flag){
    				obj.value = obj.value.substring(0,2);
    			})	
    			return false;
		  	}
		  	if(obj.value>59){
		   		popAlertBackData('只能输入0-59之内的数字',function(flag){
    				obj.value = "";
    			})	
		  	}
		}
		
		/**
		 * 发布申请系统消息
		 * 周枫
		 * 2016.07.02 
		 */
		function sendSysMsg(target_login_name){
			var sender_id = $api.getStorage('person_id');
			var sender_person_name = $api.getStorage("person_name");
			var sender_login_name = commonNewParamToOldParam($api.getStorage("login_name")); 
			var sender_identity = $api.getStorage("identity");
			var target_login_names = [target_login_name];
			var is_url = 1;
			var url_name = 'kaoqinIpad_kqsp_window';
			var param_num = 101;
			var sysmsg_code = 'KAOQIN_ADD_FRAME';
			var qj_type = $api.html($api.byId('style'));
			if(qj_type == '' || typeof(qj_type) == 'undefined') {
				qj_type = '事假';
			}
			var bureau_id = $api.getStorage('bureau_id');
			( typeof (bureau_id) == 'undefined') ? bureau_id = -1 : bureau_id = bureau_id;
			
			var district_id = $api.getStorage('district_id');
			( typeof (district_id) == 'undefined') ? district_id = -1 : district_id = district_id;
			
			var city_id = $api.getStorage('city_id');
			( typeof (city_id) == 'undefined') ? city_id = -1 : city_id = city_id;
			
			var province_id = $api.getStorage('province_id');
			( typeof (province_id) == 'undefined') ? province_id = -1 : province_id = province_id;
//			var p_2 = '审批申请(' + sender_person_name + ')';
			var params = ['考勤消息',sender_person_name,qj_type];
			commonSendSysMsg(sender_id, sender_person_name, sender_login_name, sender_identity, target_login_names, is_url, url_name, param_num, sysmsg_code, bureau_id, district_id, city_id, province_id, params, function(is_true){
				if(is_true) {
	               
				} else {
					
				}
			});
		}
		
		/*
		 *author:zhaoj
		 *function:获取输入框的值或图片的数量
		 *date：201600707
		 */
		function verExitContent(callBack){
		      document.getElementById('j_content').blur();
			var content = $api.val($api.byId('j_content'));
			var msg = ruleType == 1 ? '是否放弃请假？' : '是否放弃公出？'
			var name = ruleType == 1 ? selectSq(1,event) : selectSq(0,event);
			if(content.length > 0 || getfilesNum() > 0){
			 setTimeout(function(){
				api.confirm({
				    title: '提示',
				    msg: msg,
				    buttons: ['确定', '取消']
				}, function(ret, err){
				    var index = ret.buttonIndex;
				    if(index == 1){
				    	resetValue();	
				    	name;	    
				    }
				});
			  },200);
			}else{
				name;	
			}
		}
		/*
		 *author:zhaoj
		 *function:重置
		 *date：201600707
		 */
		function resetValue(){
			$api.val($api.byId('j_content'), '');
			var imgHtml = '<li id="j_add_btn" class="add-btn fl" onclick="selectPicture();"><a class="aui-iconfont aui-icon-add fl"></a></li>';
			$api.html($api.byId('j_files'),imgHtml);
		}
		
		/*
		*author:zfz
		*function:关闭页面
		*date：20171013
		*/
		function closeFrame(){
			commonCloseFrame('kaoqinIpad_add_frame'); 
		}
		
		/*
		*author:zfz
		*function:选择级别
		*date：20171015
		*/
		function selectSq(sq_type,event) {
			type = sq_type;
			if (type == 0) {
				//请假
				$api.text($api.byId('j_select_sq'), '请假');
			} else if (type == 1) {
				//公出
				$api.text($api.byId('j_select_sq'), '公出');
			}
			changeType(type);
			closeSqMenu(event);
		}
		
		/*
		*author:zfz
		*function:打开级别菜单
		*date：20171015
		*/
		function showSqMenu(dom){
			$api.addCls($api.byId('j_select_type_menu'), 'aui-hide');
			$api.removeCls($api.byId('j_select_sq_menu'), 'aui-hide');
		}
		/*
		*author:zfz
		*function:关闭级别菜单
		*date：20161015
		*/
		function closeSqMenu(event){
			$api.addCls($api.byId('j_select_sq_menu'), 'aui-hide');
			event.stopPropagation();
		}
		
		/*
		*author:zfz
		*function:选择假类型
		*date：20171017
		*/
		function selectedType(event,name,styleID){
			closeSqMenu(event)
			modifyStyle(name,styleID);
			closeTypeMenu(event);
		}

		/*
		*author:zfz
		*function:打开假类型选择页面 
		*date：20171015
		*/
		function showTypeMenu(){
			$api.addCls($api.byId('j_select_sq_menu'), 'aui-hide');
			$api.removeCls($api.byId('j_select_type_menu'), 'aui-hide');
		}
	
		/*
		*author:zfz
		*function:关闭假类型选择页面 
		*date：20161015
		*/
		function closeTypeMenu(event){
			$api.addCls($api.byId('j_select_type_menu'), 'aui-hide');
			event.stopPropagation();
		}
		
		/*
		*author:zfz
		*function:关闭选择图片
		*date：20171013
		*/
		function closePicture(){
			$api.addCls($api.byId('j_select_picture'),'aui-hide');
		}
		
		/*
	     *author:zhaoj
	     *function:选择图片
	     *date：20170914
	     */
	    function getAlbum() {
			var num = 5 - judgeImgCount();
			if(num != 0){
				UIAlbumBrowser.open(num,function(data){
					//递归上传图片
					commonUiUploadFiles({"data":data,"is_trans":1}, function(ret_data) {
						for(var i = 0; i < ret_data.length; i++){
							var json_data = JSON.parse(ret_data[i]);
		            		var file_id = json_data.file_id;
							var ext = json_data.ext;
							var param_json = {"file_id" : file_id,"ext" : ext,};
                            showPicture(param_json);
						}
						closePicture();
					})
				})
			}else{
				popToast('最多上传5张图片');
			}
	    }
	    
	    
	    
	    /*
	 	*author:zhaoj
	 	*function:显示图片
	 	*date：20170914
	 	*/
	    function showPicture(param_json){
	    	var img_url='';//图片路径
	    	var img_url_original="";//原图
	    	if (BASE_APP_TYPE == 1) {
				img_url = BASE_IMAGE_PRE+"down/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext + commonReturnPhotoCutSize(0);	
				img_url_original = 	BASE_IMAGE_PRE+"down/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext;		
			} else {
				img_url = BASE_URL_ACTION + "/html/thumb/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext + commonReturnPhotoCutSize(0);
				img_url_original = BASE_URL_ACTION + "/html/thumb/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext;
			}
			var error_html ="this.src='../../../../../image/fun-module/common/wk_default.png'";
	    	var li_html = '<li class="fl">';
				li_html += '<img class="j_img" onclick="openImg(this);" openSrc="'+img_url_original+'" onerror="'+error_html+'" src="'+img_url+'" />';
				li_html += '<div class="delete" onclick="deleteImg(event,this);"></div>';
				li_html += '</li>';
	    	$api.before($api.byId('j_add_btn'), li_html);
	    	judgeImgCount();
	    }
	    
	    /*
	 	*author:zhaoj
	 	*function:删除图片
	 	*date：20170915
	 	*/
	    function deleteImg(e,self){
	    	var parent = self.parentNode;
	    	var grandpa = parent.parentNode;
	    	grandpa.removeChild(parent);
	    	judgeImgCount();
	    	e.stopPropagation();
	    }
	    
	    /*
	 	*author:zhaoj
	 	*function:判断图片的数量
	 	*date：20170915
	 	*/
	    function judgeImgCount(){
	    	var imgArray = $api.domAll($api.byId('j_files'), '.j_img');
	    	if(imgArray.length == 5){
	    		$api.addCls($api.byId('j_add_btn'), 'aui-hide');
	    	}else{
	    		$api.removeCls($api.byId('j_add_btn'), 'aui-hide');
	    	}
	    	return imgArray.length;
		}

		 /*
	 	*author:zhaoj
	 	*function:打开图片
	 	*date：20170915
	 	*/
	    function openImg(self){
	    	var parent = self.parentNode;
	    	var grandpa = parent.parentNode;
	    	//获取当前文件的位置
	    	var index;
			if (parent) {
				index = 0;
				while ( parent = parent.previousSibling) {
					if (parent.nodeType == 1)
						index++;
				}
			}
			//获取图片路径
			var openImgArray = [];
			var imgArray = $api.domAll($api.byId('j_files'), '.j_img');
			for (var i = 0; i < imgArray.length; i++) {
				openImgArray.push($api.attr(imgArray[i], 'openSrc'));
			}
			//打开图片
			photoBrowser.open(openImgArray, index,function(is_true){
				api.execScript({
				    name: 'kaoqinIpad_wdkq_window',
				    script: 'back()'
				});
			});
	    }
		 /*
	 	*author:zhaoj
	 	*function:删除图片
	 	*date：20170915
	 	*/
	    function deleteImg(e,self){
	    	var parent = self.parentNode;
	    	var grandpa = parent.parentNode;
	    	grandpa.removeChild(parent);
	    	judgeImgCount();
	    	e.stopPropagation();
	    }
	    
	    /*
		 *author:zhaoj
		 *function:删除当前文件
		 *date：20160225
		 */
		function deleteFile(e, parent) {
			parent.parentNode.removeChild(parent);
			var dlArray = $api.domAll($api.byId('j_files'), '.j_img');
			var length = getfilesNum() - 1;
			if (length == 3) {
				$api.removeCls(dlArray[length], 'mr0');
				$api.css($api.byId('j_add_btn'), 'display:inline-block');
			}
			e.stopPropagation();
		}
		/**
		 * 选择要上传的图片
		 * 周枫
		 * 2016.4.27 
		 */
		function openPicture(sourceType) {
			getPicture.open({"type":1},function(data){
	    		//递归上传图片
            	commonUiUploadFiles({"data":data,"is_trans":0}, function(ret_data) {
            		for(var i = 0; i < ret_data.length; i++){
						var json_data = JSON.parse(ret_data[i]);
	            		var file_id = json_data.file_id;
						var ext = json_data.ext;
						var param_json = {"file_id" : file_id,"ext" : ext,};
                        showPicture(param_json);
					}
					closePicture();
            	})
	    	});
		}
		
		/*
		*author:zfz
		*function:选择图片
		*date：20171013
		*/
		function selectPicture(){
			$api.removeCls($api.byId('j_select_picture'),'aui-hide');
		}
	</script>
</html>