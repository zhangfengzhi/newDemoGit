<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>打卡统计</title>
    <link rel="stylesheet" type="text/css" href="../../../../../css/aui_css_new/aui.css"/>
    <link rel="stylesheet" type="text/css" href="../../../../../css/module/ipad/left-right-layout.css"/>
    <link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
    <style>
    	body{color:#000000;height:100%;}
    	.start_time{position: fixed;width:100%; z-index: 10; background: #fff;}
    	.content{height:55px;line-height:55px;padding:0 15px 0 155px; }
    	.content div{display:inline-block;float:right;line-height:52px;color:#666666;}
    	.bb{border-bottom:1px solid #dfdfdf;}
    	.bt{border-top:1px solid #dfdfdf;}
    	.hr{height:10px;}
    	.bgf{}
    	.mb10{margin-bottom:10px;}
    	.person-list li{position:relative;padding:10px 20px;border:1px solid #dfdfdf; float:left;width:45%;margin-left:3.33%;background: #fff;margin-top: 20px;}
    	.person-list li img{position:absolute;left:15px;top:50%;display:inline-block;float:left;width:60px;height:60px;margin-top:-30px;border-radius: 50%;}
    	.person-list li .detail{padding-left:80px;color:#333333;}
    	.person-list li .detail .person-name{font-size:16px;padding: 6px 0 10px 0;border-bottom: 1px dashed #dfdfdf;margin-bottom: 10px;}
    	.person-list li .detail .time span,.person-list li .detail .time div{display:inline-block;float:left;width:50%;font-size:14px;padding:2px 0;}
    	.person-list li .detail .time div{width:100%;}
    	.pt{padding-top:1px;}
    	.display-none{display:none;}
    	.no-data{line-height:55px;padding-top:0px;border-bottom:1px solid #dfdfdf;}
		
		.left-layout-body .left-tag{width:140px;height:100%;top:0; z-index:11;}
		.left-layout-body .left-tag .tag-item .parting-line{width:108px;}
		@media screen and (max-width: 1024px) {
			.left-layout-body .left-tag{width:140px;}
			.left-layout-body .left-tag .tag-item .parting-line{width:108px;}
		}
		
		.left-layout-body .left-tag .tag-item{height:65px;}
		.fl{float:left;}
		.fr{float:right;}
		.right_tag{width:100%; padding-left:140px;height:100%; overflow-y:auto;padding-top:55px;}
	</style>
</head>
<body class="left-layout-body common-ipad-datjIpad-tea">
	<div id="start_time_div" class="content bb bgf start_time display-none" onclick="selectTime();">
		选择日期
		<div id="start_time"></div>
	</div>
	<div id="dktj_body">
	</div>
	<script type="text/html" id="dktj_script">
		<div id="j_left_tag" class="left-tag">
			<div class="tag-item active" onclick="openPersonDetail('j_wqrs',this);">
				<div class="name">未签人数(<%=wdk_list.length%>)</div>
				<div class="parting-line">
					<div class="left-rectangle fl"></div>
					<div class="right-rectangle fr"></div>
					<hr />
				</div>
			</div>
			<div class="tag-item" onclick="openPersonDetail('j_cdrs',this);">
				<div class="name">迟到人数(<%=cd_list.length%>)</div>
				<div class="parting-line">
					<div class="left-rectangle fl"></div>
					<div class="right-rectangle fr"></div>
					<hr />
				</div>
			</div>
			<div class="tag-item" onclick="openPersonDetail('j_qjrs',this);">
				<div class="name">请假次数(<%=qj_list.length%>)</div>
				<div class="parting-line">
					<div class="left-rectangle fl"></div>
					<div class="right-rectangle fr"></div>
					<hr />
				</div>
			</div>
			<div class="tag-item" onclick="openPersonDetail('j_gcrs',this);">
				<div class="name">公出次数(<%=wc_list.length%>)</div>
				<div class="parting-line">
					<div class="left-rectangle fl"></div>
					<div class="right-rectangle fr"></div>
					<hr />
				</div>
			</div>
			<div class="tag-item <%if(!is_show_zt){%>display-none<%}%>" onclick="openPersonDetail('j_ztrs',this);">
				<div class="name">早退人数(<%=zt_list.length%>)</div>
				<div class="parting-line">
					<div class="left-rectangle fl"></div>
					<div class="right-rectangle fr"></div>
					<hr />
				</div>
			</div>
		</div>
		<div id="right_tag" class="right_tag">
			<ul id="j_wqrs_person" class="person-list bgf clearfix display-none">
				<%if(wdk_list.length == 0){%>
					<div class="no-data">暂无未签的人员</div>
				<%}else{%>
					<%for(var i = 0; i < wdk_list.length; i++){%>
						<li class="clearfix">
							<img onerror="this.src='../../../../../image/common/header.png'" src="<%=wdk_list[i].avatar_url%>" />
							<div class="detail">
								<div class="person-name ellipsis"><%=wdk_list[i].person_name%></div>
								<div class="time pt">
									<%for(var j = 0; j < wdk_list[i].kq_info.length; j++){%>
										<span><%=wdk_list[i].kq_info[j]%></span>
									<%}%>
								</div>
							</div>
						</li>
					<%}%>
				<%}%>
			</ul>
			<!--//未签人数-->
		
			<ul id="j_cdrs_person" class="person-list bgf clearfix display-none">
				<%if(cd_list.length == 0){%>
					<div class="no-data">暂无迟到的人员</div>
				<%}else{%>
					<%for(var i = 0; i < cd_list.length; i++){%>
						<li class="clearfix">
							<img onerror="this.src='../../../../../image/common/header.png'" src="<%=cd_list[i].avatar_url%>" />
							<div class="detail">
								<div class="person-name ellipsis pt"><%=cd_list[i].person_name%></div>
								<div class="time pt">
									<%for(var j = 0; j < cd_list[i].cd_info.length; j++){%>
										<span><%=cd_list[i].cd_info[j].memo%>:<%=cd_list[i].cd_info[j].dksj%></span>
									<%}%>
								</div>
							</div>
						</li>
					<%}%>
				<%}%>
			</ul>
			<!--//迟到人数-->
		
			<ul id="j_qjrs_person" class="person-list bgf clearfix display-none">
				<%if(qj_list.length == 0){%>
					<div class="no-data">暂无请假的人员</div>
				<%}else{%>
					<%for(var i = 0; i < qj_list.length; i++){%>
						<li class="clearfix">
							<img onerror="this.src='../../../../../image/common/header.png'" src="<%=qj_list[i].avatar_url%>" />
							<div class="detail">
								<div class="person-name ellipsis pt">[<%=qj_list[i].qj_type%>]&nbsp;<%=qj_list[i].person_name%></div>
								<div class="time pt">
									<div>开始时间：<%=qj_list[i].start_time.substring(0,16)%></div>
									<div>结束时间：<%=qj_list[i].end_time.substring(0,16)%><div>
								</div>
							</div>
						</li>
					<%}%>
				<%}%>
			</ul>
			<!--//请假人数-->
		
			<ul id="j_gcrs_person" class="person-list bgf clearfix display-none">
				<%if(wc_list.length == 0){%>
					<div class="no-data">暂无公出的人员</div>
				<%}else{%>
					<%for(var i = 0; i < wc_list.length; i++){%>
						<li class="clearfix">
							<img onerror="this.src='../../../../../image/common/header.png'" src="<%=wc_list[i].avatar_url%>" />
							<div class="detail">
								<div class="person-name ellipsis pt">[<%=wc_list[i].wc_type%>]&nbsp;<%=wc_list[i].person_name%></div>
								<div class="time pt">
									<div>开始时间：<%=wc_list[i].start_time.substring(0,16)%></div>
									<div>结束时间：<%=wc_list[i].end_time.substring(0,16)%><div>
								</div>
							</div>
						</li>
					<%}%>
				<%}%>
			</ul>
			<!--//公出人数-->
		
			<ul id="j_ztrs_person" class="person-list bgf clearfix display-none">
				<%if(zt_list.length == 0){%>
					<div class="no-data">暂无早退的人员</div>
				<%}else{%>
					<%for(var i = 0; i < zt_list.length; i++){%>
						<li class="clearfix">
							<img onerror="this.src='../../../../../image/common/header.png'" src="<%=zt_list[i].avatar_url%>" />
							<div class="detail">
								<div class="person-name ellipsis pt"><%=zt_list[i].person_name%></div>
								<div class="time pt">
									<%for(var j = 0; j < zt_list[i].zt_info.length; j++){%>
										<span><%=zt_list[i].zt_info[j].memo%>:<%=zt_list[i].zt_info[j].dksj%></span>
									<%}%>
								</div>
							</div>
						</li>
					<%}%>
				<%}%>
			</ul>
			<!--//早退人数-->
		</div>
	</script>
</body>
<script type="text/javascript" src="../../../../../script/api.js"></script>
<script type="text/javascript" src="../../../../../script/base_config.js" ></script>
<script type="text/javascript" src="../../../../../script/plug-in/template.js" ></script>
<script type="text/javascript" src="../../../../../script/common/common.js"></script>
<script type="text/javascript">
	var BASE_URL_ACTION;
	var nowData;//获取服务器的当前时间
	apiready = function(){
		commonSetTheme({"level":5,"type":0});
		BASE_URL_ACTION = $api.getStorage('BASE_URL_ACTION');
		commonGetCurrentDate(function(nowTime,nowMillisecond){
			var year = nowTime.getFullYear();
			var month = nowTime.getMonth()*1+1;
			month = month < 10 ? '0'+month : month;
			var day = nowTime.getDate();
			day = day < 10 ? '0'+day : day;
			nowData = year+'-'+month+'-'+day;
			setTime(nowData);//设置时间
			getDayClockInStatisticalInfo(nowData);
		});
	};
	/*
	*author:zhaoj
	*function:打开人员列表
	*date：20170215
	*/
	function openPersonDetail(id,dom){
		var tag_item_array = $api.domAll($api.byId('j_left_tag'), 'div.tag-item');
		for(var i=0;i<tag_item_array.length;i++){
			$api.removeCls(tag_item_array[i], 'active');
		}
		$api.addCls(dom, 'active');
		
		var ul_array = $api.domAll($api.byId('right_tag'), 'ul');
		for(var i=0;i<ul_array.length;i++){
			$api.addCls(ul_array[i], 'display-none');
		}
		$api.removeCls($api.byId(id+'_person'), 'display-none');
	}
	/*
	*author:zhaoj
	*function:设置时间
	*date：20170215
	*/
	function setTime(time){
		$api.html($api.byId('start_time'), time+'<i class="aui-iconfont aui-icon-right"></i>');
	}
	/*
	*author:zhaoj
	*function:选择时间
	*date：20170215
	*/
	function selectTime(){
		var time = $api.text($api.byId('start_time'));
		api.openPicker({
	        type: 'date',
			date: time,
	        title:'选择时间'
	    },function(ret,err){
			if(err){
				popToast('网络繁忙，请稍候重试');
			}else if(ret){
				var year = ret.year;
		        var month = ret.month;
				month = month > 9 ? month : '0'+month;
		        var day = ret.day;
				day = day > 9 ? day : '0'+day;
		        //这是选择的是日期
				var value=year+'-'+month+'-'+day;
				if(Date.parse(value.replace(/-/g,'\/')) <= Date.parse(nowData.replace(/-/g,'\/'))){
					setTime(value);
					getDayClockInStatisticalInfo(value);
				}else{
					popToast('不支持未来日期，请重新选择');
				}
			}
	    });
	}
	/*
	*author:zhaoj
	*function:获取详细数据
	*date：20170216
	*/
	function getDayClockInStatisticalInfo(data){
		showSelfProgress('加载中...');
		api.ajax({
			url : BASE_URL_ACTION + '/leave/getDayClockInStatisticalInfo?bureau_id='+$api.getStorage("bureau_id")+'&date='+data+'&random_num='+creatRandomNum(),
			method : 'get',
			timeout : 0,
			dataType : 'json',
			headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
			}, function(ret, err) {
				api.hideProgress();
				if (err) {
					popToast('获取打卡统计失败，请稍候重试');
				} else {
					if(ret){
						//未签到
						ret.wdk_list = getPersonHeaderImg(ret.wdk_list);
						//请假
						ret.qj_list = getPersonHeaderImg(ret.qj_list);
						//外出
						ret.wc_list = getPersonHeaderImg(ret.wc_list);
						//早退
						ret.zt_list = getPersonHeaderImg(ret.zt_list);
						//迟到
						ret.cd_list = getPersonHeaderImg(ret.cd_list);
						//如果是鄂托克前旗教育云平台，不显示早退
						if($api.getStorage('bureau_id') == '300372'){
							ret.is_show_zt = 0;
						}else{
							ret.is_show_zt = 1;
						}
						commonAddOnceHtml('dktj_body','dktj_script',ret);
						$api.removeCls($api.byId('start_time_div'), 'display-none');
						$api.removeCls($api.byId('j_wqrs_person'), 'display-none');
					}else{
						popToast('获取打卡统计失败，请稍候重试');
					}
				}
		});
	}
	/*
	*author:zhaoj
	*function:获取头像
	*date：20170216
	*/
	function getPersonHeaderImg(data){
		//早退
		for(var i = 0; i < data.length; i++){
			var img_url;
			if(BASE_APP_TYPE == 1){
				img_url = BASE_IMAGE_PRE + url_path_suffix+ data[i].avatar_file_id.substring(0, 2) + "/" + data[i].avatar_file_id + commonReturnPhotoCutSize(0);
			}else{
				img_url = BASE_URL_ACTION + BASE_IMAGE_BEGIN + data[i].avatar_file_id.substring(0, 2) + "/" + data[i].avatar_file_id + commonReturnPhotoCutSize(0);
			}
			data[i].avatar_url=img_url;
		}
		return data;
	}
</script>
</html>