<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>学校圈子</title>
		<link rel="stylesheet" type="text/css" href="../../../../../css/aui/aui.css" />
		<link rel="stylesheet" type="text/css" href="../../../../../css/module/ipad/popup-body.css"/>
		<link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
		<style>
			.popup-body-new	.commont-content{padding:52px 0 70px 0;height: 410px;}
	    	.content-name{height:60px;}
	    	input[type='text'],textarea{border:none;margin-bottom:0;}
	    	input[type='text']{height:59px;border-bottom:1px dashed #aaaaaa;padding:10px 0;}
	    	textarea{height:165px;padding:20px;max-height:165px ;overflow-y: auto;}
	    	.popup-body-new .commont-content .position{font-size:16px;padding:20px 0 0 30px;}
	    	.back-div{font-size: 20px;bottom: auto}
			.aui-iconfont{font-size: 20px}
			.publishBtn{
				position: absolute;
				right: 10px;
				top: 0;
				width: 50px;
				height: 100%;
				font-size: 20px;
			}
			
			.range-div{
				display: inline-block;
				width: 25%;
				height: 40px;
				line-height: 40px;
				font-size: 20px;
				background: #f8b62b;
				margin-left: 20px;
				border-radius: 5px;
				color: #FFFFFF;
			}
			.range-text{
				text-align: center;
				max-width: 100%;
				height: 100%;
				overflow : hidden;
			    text-overflow: ellipsis;
			    display: -webkit-box;
			    -webkit-line-clamp: 1;
			    -webkit-box-orient: vertical;
			    word-break: break-all; /* 追加这一行代码 */
			}
			.publish-div{
				width:20%;
				margin-right: 20px;
				float: right;
				background-color: #31a8fa;
				text-align: center;
			}
			.button-div{
				font-family: 'Microsoft YaHei';
				margin-top:10px;
				padding-top: 10px;
				border-top: 1px solid #CCCCCC;
			}
		</style>
	</head>
	<body class="popup-body-new common-ipad-quanziIpad-tea">
		<div id="j_select_picture" class="select-picture-bg aui-hide">
			<div class="select-picture">
				<div class="option" onclick="getAlbum();">图片</div>
				<div class="option" onclick="openPicture();">拍照</div>
				<div class="option" onclick="commonExecScript('quanziIpad_index_window','','back();',0);">取消</div>
			</div>
		</div>
		<div class="commont-content">
			<div class="top fl">
				<div class="name">发表圈子</div>
				<div class="close fr" onclick="closeFrame();"></div>
			</div>
			<div class="content">
				<div class="content-name plr20 clearfix ">
					<input oninput="commonRemoveExpression(this)" id="article_title" type="text" placeholder="标题，最多支持40字符（必填）" maxlength ='40' />
				</div>
				<div class="content-text plr120 clearfix ">
					<textarea id="article_content" placeholder="请输入内容" rows="4"></textarea>
				</div>
				<div class="add-img-file">
					<ul id="j_files">
						<li id="j_add_btn" class="add-btn fl" onclick="selectPicture();">
							<a class="aui-iconfont aui-icon-add fl"></a>
						</li>
					</ul>
				</div>
			</div>
			<div class="button-div">
				<div class="range-div">
					<div id="personalClassfiyContent" class="range-text" onclick="opnePersonalClassifyrame()"></div>
				</div>
				<div class="range-div">
					<div id="publishRangeContent" class="range-text"onclick="openPublishRangeFrame()"></div>
				</div>
				
				<div class="range-div publish-div" onclick="getArticleValue();">发表</div>
			</div>
		</div>
		
		<div id="bxfl_div" class="common-name bgf bb plr15 clearfix ">
		</div>
		
		
	</body>
	<script type="text/javascript" src="../../../../../script/api.js"></script>
	<script type="text/javascript" src="../../../../../script/base_config.js" ></script>
	<script type="text/javascript" src="../../../../../script/common/common.js" ></script>
	<script type="text/javascript" src="../../../../../script/assembly/UIAlbumBrowser.js"></script>
	<script type="text/javascript" src="../../../../../script/assembly/getPicture.js"></script>
	<script type="text/javascript" src="../../../../../script/assembly/photoBrowser.js"></script>
	<script type="text/javascript">
		var header_h;
		var BASE_URL_ACTION;
		var BASE_APP_TYPE;
		//机构分类的数组
		var img_suffix;
		var is_flag = true;
		var img_size;
		//图片的宽高
		var openImgArray;
		var obj_scan;
		var BASE_SERVER_NAME;
		var org_name;
		var	org_id;
		var	menu_type;
		var class_id;
		var grflID = 0;
		//学校id
		var org_category_id;
		//记录打开图片地址的数组
		var BASE_SERVER_NAME;
		var bxflID = 0;
		
		var personalClassfiyContent = $api.byId('personalClassfiyContent');
		var publishRangeContent = $api.byId('publishRangeContent');
		apiready = function() {
			commonSetTheme({"level":5,"type":0});
			header_h = api.pageParam.header_h;
			org_id = api.pageParam.menu_id;
			menu_type = api.pageParam.menu_type;
			org_name = api.pageParam.menu_name;
			obj_scan = api.require('UIAlbumBrowser');
			BASE_URL_ACTION = $api.getStorage('BASE_URL_ACTION');
			BASE_APP_TYPE = $api.getStorage('BASE_APP_TYPE');
			BASE_SERVER_NAME = $api.getStorage('BASE_SERVER_NAME');
			var addBtnWidth = $api.cssVal($api.byId('j_add_btn'), 'width');
			$api.css($api.dom($api.byId('j_add_btn'),'dt'), 'height:'+addBtnWidth+';line-height:'+(addBtnWidth.replaceAll('px','')*1-4)+'px;');
			
			setPublishRangeContent();
		};
		/*
		 *author:zhaoj
		 *function:打开添加附件选项组件框
		 *date：20160220
		 */
		function openAddFilesOpn(mk_type) {
			api.actionSheet({
				cancelTitle : '取消',
				buttons : ['图片', '拍照'],
				style : {
					titleFontColor : '#ff0000'
				}
			}, function(ret, err) {
				if (ret) {
					if (ret.buttonIndex == 1) {
						//相册
						//getPicture("album");
						album();
					} else if (ret.buttonIndex == 2) {
						//拍照
						getPicture("camera");
					}
				} else {
					//		         alert( JSON.stringify( err ) );
				}
			});
		}

		/**
		 * 选取图片
		 * 周枫
		 * 2016.1.16
		 */
		function openPicture(sourceType) {
			getPicture.open({"type":1},function(data){
	    		//递归上传图片
            	commonUiUploadFiles({"data":data,"is_trans":0}, function(ret_data) {
            		for(var i = 0; i < ret_data.length; i++){
						var json_data = JSON.parse(ret_data[i]);
	            		var file_id = json_data.file_id;
						var ext = json_data.ext;
						var param_json = {"file_id" : file_id,"ext" : ext};
                        showPicture(param_json);
					}
					commonExecScript('quanziIpad_index_window','','back();',0);
            	})
	    	});
		}

		/*
		 *author:zhaoj
		 *function:图片格式
		 *date：20160222
		 */
		function getImgSize() {
			img_size = (api.winWidth - 30) * 0.18;
			img_size = Math.floor(img_size);
			var img_format = '@' + img_size + 'w_' + img_size + 'h_100Q_1x.';
			return img_format;
		}

		/*
		 *author:zhaoj
		 *function:根据模块获取子文件的个数
		 *date：20160224
		 */
		function getfilesNum() {
			var dlArray = $api.domAll($api.byId('j_files'), '.j_img');
			return dlArray.length;
		}

		/*
		 *author:zhaoj
		 *function:给模块添加文件
		 *date：20160224
		 */
		function addFiles(img_url, css) {
			var dl_height = $api.cssVal($api.byId('j_add_btn'), 'height')
			dl_height = dl_height.substring(0,dl_height.length-2)*(1.15)+'px';
			var dl_html = '<dl class="j_file' + ' ' + css + '" style="height:' + dl_height + ';">' + '<dt class="img" style="width:' + img_size + 'px;height:' + img_size + 'px;" onclick="openImage(this.parentNode,this.parentNode.parentNode)">' + '<img class="j_img" src=' + img_url + ' width="' + (img_size - 1) + '" height="' + (img_size - 4) + '" />' + '</dt>' + '<dd onclick="deleteFile(event,this.parentNode)"><img src="../../../../../image/fun-module/common/shanchu.png" /></dd>' + '</dl>';
			$api.before($api.byId('j_add_btn'), dl_html);
		}

		/*
		 *author:zhaoj
		 *function:删除当前文件
		 *date：20160225
		 */
		function deleteFile(e, parent) {
			parent.parentNode.removeChild(parent);
			var dlArray = $api.domAll($api.byId('j_files'), '.j_file');
			var length = getfilesNum() - 1;
			if (length == 7) {
				$api.removeCls(dlArray[length], 'mr0');
				$api.css($api.byId('j_add_btn'), 'display:inline-block');
			}
			e.stopPropagation();
		}

		/*
		 *author:zhaoj
		 *function:打开图片
		 *date：20160225
		 */
		function openImage(parent, grandpa) {
			var index;
			if (parent) {
				index = 0;
				while ( parent = parent.previousSibling) {
					if (parent.nodeType == 1)
						index++;
				}
			}
			var openImgArray = [];
			var dlArray = $api.domAll($api.byId('j_files'), '.j_img');
			for (var i = 0; i < dlArray.length; i++) {
				openImgArray.push($api.attr($api.dom(dlArray[i], '.j_img'), 'src'));
			}
			openPictureShowWin(openImgArray,index);
		}

		/*
		 *author:zhaoj
		 *function:选择图片
		 *date：20160225
		 */
		function getAlbum() {
			var num = 9 - judgeImgCount();
			if(num != 0){
				UIAlbumBrowser.open(num,function(data){
					//递归上传图片
					commonUiUploadFiles({"data":data,"is_trans":1}, function(ret_data) {
						for(var i = 0; i < ret_data.length; i++){
							var json_data = JSON.parse(ret_data[i]);
		            		var file_id = json_data.file_id;
							var ext = json_data.ext;
							var param_json = {"file_id" : file_id,"ext" : ext};
                            showPicture(param_json);
						}
						commonExecScript('quanziIpad_index_window','','back();',0);
					})
				})
			}else{
				popToast('最多上传9张图片');
			}
		}
		/*
	 	*author:zhaoj
	 	*function:判断图片的数量
	 	*date：20170915
	 	*/
	    function judgeImgCount(){
	    	var imgArray = $api.domAll($api.byId('j_files'), '.j_img');
	    	if(imgArray.length == 9){
	    		$api.addCls($api.byId('j_add_btn'), 'aui-hide');
	    	}else{
	    		$api.removeCls($api.byId('j_add_btn'), 'aui-hide');
	    	}
	    	return imgArray.length;
		}

		/*
	 	*author:zhaoj
	 	*function:显示图片
	 	*date：20170914
	 	*/
	    function showPicture(param_json){
	    	var img_url='';//图片路径
	    	var img_url_original="";//原图
	    	if (BASE_APP_TYPE == 1) {
				img_url = BASE_IMAGE_PRE+"down/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext + commonReturnPhotoCutSize(0);	
				img_url_original = 	BASE_IMAGE_PRE+"down/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext;		
			} else {
				img_url = BASE_URL_ACTION + "/html/thumb/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext + commonReturnPhotoCutSize(0);
				img_url_original = BASE_URL_ACTION + "/html/thumb/Material/" + param_json.file_id.substring(0, 2) + "/" + param_json.file_id + '.' + param_json.ext;
			}
			var error_html ="this.src='../../../../../image/fun-module/common/wk_default.png'";
	    	var li_html = '<li class="fl">';
				li_html += '<img class="j_img" onclick="openImg(this);" openSrc="'+img_url_original+'" onerror="'+error_html+'" src="'+img_url+'" />';
				li_html += '<div class="delete" onclick="deleteImg(event,this);"></div>';
				li_html += '</li>';
	    	$api.before($api.byId('j_add_btn'), li_html);
	    	judgeImgCount();
	    }
	    /*
	 	*author:zhaoj
	 	*function:打开图片
	 	*date：20170915
	 	*/
	    function openImg(self){
	    	var parent = self.parentNode;
	    	var grandpa = parent.parentNode;
	    	//获取当前文件的位置
	    	var index;
			if (parent) {
				index = 0;
				while ( parent = parent.previousSibling) {
					if (parent.nodeType == 1)
						index++;
				}
			}
			//获取图片路径
			var openImgArray = [];
			var imgArray = $api.domAll($api.byId('j_files'), '.j_img');
			for (var i = 0; i < imgArray.length; i++) {
				openImgArray.push($api.attr(imgArray[i], 'openSrc'));
			}
			openPictureShowWin(openImgArray,index);
	    }
		/**
		 * 上传文件
		 * 周枫
		 * 2015.11.25
		 */
		function uploadFiles(file_path, callback) {
			api.showProgress({
				title : '上传中...',
				text : '请稍候...',
				modal : true
			});
			//扩展名
			var ldot = file_path.lastIndexOf(".");
			var ext = file_path.substring(ldot + 1);
			//			var ext = file_path.substring(ldot + 1).substring(0,3);
			if (ext != "jpg" && ext != "png" && ext != "JPG" && ext != "PNG") {
				api.hideProgress();
				popToast("文件格式只支持png和jpg");
				return;
			}
			if (BASE_APP_TYPE == 1) {
				var v_guid = newGuid();
				//图片上传服务器时路径
				var _key = url_path_suffix + v_guid.substring(0, 2) + "/" + v_guid + "." + ext;
				notice_img_path = _key;
				api.ajax({
					url : BASE_URL_ACTION + '/res/uploadFileToAliyun',
					method : 'post',
					timeout : 30,
					dataType : 'json',
					returnAll : false,
					data : {
						values : {
							key : _key
						},
						files : {
							file : file_path
						}
					}
				}, function(ret, err) {
					//					api.hideProgress();
					if (err) {
						callback(false, '', '');
					} else {
						if (ret.success) {
							callback(true, v_guid, ext);
						} else {
							callback(false, '', '');
						}
					}
				});
			} else {
				//局版
				var v_guid = newGuid();
				var extension = ext;
				//图片上传服务器时路径
				var _key = url_path_suffix + v_guid.substring(0, 2) + "/" + v_guid + "." + ext;
				notice_img_path = _key;
				api.ajax({
					url : BASE_URL_ACTION + '/res/newUpload/',
					method : 'post',
					timeout : 30,
					dataType : 'json',
					returnAll : false,
					data : {
						values : {
							key : _key
						},
						files : {
							file : file_path
						}
					}
				}, function(ret, err) {
					//					api.hideProgress();
					if (err) {
						callback(false, '', '');
					} else {
						if (ret.success) {
							callback(true, v_guid, extension);
						} else {
							callback(false, '', '');
						}
					}
				});
			}
		}

		/*
		 *author:zhaoj
		 *function:上传的图片
		 *date：20160307
		 */
		function uploadImg(file_id, ext) {
			var img_width = api.winWidth - 40;
			var img_height = Math.floor((api.winWidth - 60));
			var img_url;
			img_size = commonReturnPhotoCutSize(1,img_width,img_height,ext);
			if (BASE_APP_TYPE == 1) {
				img_url = BASE_IMAGE_PRE+"down/Material/" + file_id.substring(0, 2) + "/" + file_id + '.' + ext + commonReturnPhotoCutSize(0);
			} else {
				img_url = BASE_URL_ACTION + "/html/thumb/Material/" + file_id.substring(0, 2) + "/" + file_id + '.' + ext + commonReturnPhotoCutSize(0);
			}
			var img_html = '<p id="add_sucai" class="common-content add-img bgf sucai clearfix">';
			img_html = img_html + '<img id="sucai_img" class="sucai-img" src=' + img_url + ' width=' + img_width + ' />';
			img_html = img_html + '<img class="shanchu" width="25" height="25" src="../../../../../image/fun-module/common/shanchu.png" alt="删除" onclick="deleteImg(event,this.parentNode,this.parentNode.parentNode,this);" />'
			img_html = img_html + '</p>';
			$api.after($api.byId('add_img'), img_html);
			$api.html($api.byId('img_title'), '&nbsp;素材&nbsp;');
			$api.addCls($api.byId('add_img'), 'bb');
			//给上传素材删除点击事件
		}
		/*
		 *author:zhaoj
		 *function:打开上传图片的
		 *date：20160317
		 */
		function uploadOpt() {
			api.actionSheet({
				cancelTitle : '取消',
				buttons : ['拍照', '相册']
			}, function(ret, err) {
				if (ret) {
					if (ret.buttonIndex == 1) {
						getPicture("camera");
					} else if (ret.buttonIndex == 2) {
						//getPicture("album");
						album();
					}
				}
			});
		}
		/*
		 *author:zhaoj
		 *function:删除上传图片
		 *date：20160315
		 */
		function deleteImg(e,self){
	    	var parent = self.parentNode;
	    	var grandpa = parent.parentNode;
	    	grandpa.removeChild(parent);
	    	judgeImgCount();
	    	e.stopPropagation();
	    }
	     //判断是否有敏感字符
        function cheackTextAntispamScan(param){
            var text = param;
    		text = $api.trimAll(text);
    		
			textAntispamScan(text,function(flag){
				if(flag){	//如果不存在敏感词
					if (contentAry && contentAry.length > 0) {
                            param = this.contentAry[0];
                            this.contentAry.splice(0,1);

                            cheackTextAntispamScan(param);
                     }else {
                           releaseArticleValue();
                     }
				}else {
					api.hideProgress();
				}
			});
        }
        //分析作品内容的字符
        function analysisConten(str){
            var ary = [];
            var count = Math.ceil(str.length/4000);
            if (str.length <= 4000) {
                ary.push(str);
            }else {
                for (var i = 0;i < count;i++) {
                    var newStr = str.substr(i*4000,4000);
                    ary.push(newStr);
                }
            }
            return ary;
        }
		/*
		 *author:zhaoj
		 *function:获取文章的值
		 *date：20160426
		 */
		function getArticleValue() {
			//文章标题
			var article_title = $api.val($api.byId('article_title'));
			//文章文字内容
			var article_content = $api.val($api.byId('article_content'));
			//个人id
			var person_category_id;
			//班级id
			var b_category_id;
			//图片缩略图
			var thumb_id;
			//图片缩略图数组
			var thumb_ids = new Array();
			//简介
			var overview;
			if (article_content.length > 100) {
				overview = article_content.substring(0, 100);
			} else {
				overview = article_content;
			}
			//文章加上图片和文字的整体内容
			var content = article_content;
			//验证文章标题
			var article_title_vad = $api.trimAll(article_title);
			if (article_title_vad.length == 0) {
				popAlert("标题请输入1-40个字符！");
				return;
			}
			
            contentAry = analysisConten(article_title+article_content);
            var param = contentAry[0];
            contentAry.splice(0,1);
            cheackTextAntispamScan(param);
		}
		function releaseArticleValue(){
			api.showProgress({
				title : '发表中...',
				text : '请稍候...',
				modal : true
			});
			
			//文章标题
			var article_title = $api.val($api.byId('article_title'));
			//文章文字内容
			var article_content = $api.val($api.byId('article_content'));
			//个人id
			var person_category_id;
			//班级id
			var b_category_id;
			//图片缩略图
			var thumb_id;
			//图片缩略图数组
			var thumb_ids = new Array();
			//简介
			var overview;
			if (article_content.length > 100) {
				overview = article_content.substring(0, 100);
			} else {
				overview = article_content;
			}
			//文章加上图片和文字的整体内容
			var content = article_content;
			//验证文章标题
			var article_title_vad = $api.trimAll(article_title);
			
			person_category_id = $api.getStorage('personalClassifyId');
			//班级id
				org_category_id = bxflID;
			//验证是否有附件
			var dlArray = $api.domAll($api.byId('j_files'), '.j_img');
			
			if (dlArray.length != 0) {
				if (BASE_APP_TYPE == 2) {
					for (var i = 0; i < dlArray.length; i++) {
					
						if (i == 0) {
							thumb_id = $api.attr(dlArray[i], 'src');
							var startIndex = thumb_id.indexOf('/dsideal_yy/');
							thumb_id = thumb_id.substring(startIndex,thumb_id.length);
							thumb_id = thumb_id.replaceAll(img_suffix, '');
						}
						var img_url = $api.attr(dlArray[i], 'src');
						img_url = img_url.substring(startIndex,img_url.length);
						img_url = img_url.replaceAll(img_suffix, '');
						thumb_ids.push(img_url);
						var img_html = '<img src="' + img_url + '" alt="" />'
						content = content + img_html;
					}
				} else {
					for (var i = 0; i < dlArray.length; i++) {
						if (i == 0) {
							thumb_id = $api.attr(dlArray[i], 'src');
							thumb_id = thumb_id.replaceAll(img_suffix, '');
						}
						var img_url = $api.attr(dlArray[i], 'src');
						img_url = img_url.replaceAll(img_suffix, '');
						var img_html = '<img src="' + img_url + '" alt="" />'
						thumb_ids.push(img_url);
						content = content + img_html;
					}
				}
			}
			
						
			//验证文章内容
			var article_content_vad = $api.trimAll(article_content);
			if (article_content_vad.length == 0 && dlArray.length == 0) {
				popAlert("请填写内容！");
				return;
			}
//			var value ={}; 
//			if(menu_type == 0 || menu_type == 1 || menu_type == 104){
//				value={"person_id":$api.getStorage("person_id"),"person_name":$api.getStorage('person_name'),"identity_id" : $api.getStorage("identity"),"business_type" : 1,"title" : article_title,"city_id" : $api.getStorage('city_id'),"district_id" : $api.getStorage('district_id'),"province_id" : $api.getStorage('province_id'),"school_id" : $api.getStorage('school_id'),"person_category_id" : person_category_id,"org_category_id" : org_category_id,"id" : "","content" : content,"overview" : overview,"thumb_id" : thumb_id,"thumb_ids" : JSON.stringify(thumb_ids)};
//			}else{
//				value={"person_id":$api.getStorage("person_id"),"person_name":$api.getStorage('person_name'),"identity_id" : $api.getStorage("identity"),"business_type" : 3,"title" : article_title,"city_id" : $api.getStorage('city_id'),"district_id" : $api.getStorage('district_id'),"province_id" : $api.getStorage('province_id'),"school_id" : $api.getStorage('school_id'),"person_category_id" : person_category_id,"b_category_id" : b_category_id,"org_category_id" : org_category_id,"id" : "","content" : content,"overview" : overview,"thumb_id" : thumb_id,"thumb_ids" : JSON.stringify(thumb_ids),"business_id":org_id,"business_iid":105};
//			}
			
			var value = {
				"person_category_id" : person_category_id,
				"overview" : overview,
				"title" : article_title,
				"thumb_id" : thumb_id,
				"thumb_ids" : JSON.stringify(thumb_ids),
				"content" : content,
				"person_id" : $api.getStorage("person_id"),
				"person_name" : $api.getStorage('person_name'),
				"identity_id" : $api.getStorage("identity"),
				"org_category_id" : org_category_id,
				"province_id" : $api.getStorage('province_id'),
				"city_id" : $api.getStorage('city_id'),
				"district_id" : $api.getStorage('district_id'),
				"school_id" : $api.getStorage('school_id'),
				"business_type" : 1,
			};
			saveArticle(JSON.stringify(value));
		}
		/*
		 *author:zhaoj
		 *function:保存文章
		 *date：20160415
		 */
		function saveArticle(value){
			var dataValue = JSON.parse(value);
			var typeUrl;
				typeUrl = BASE_URL_ACTION + '/ypt/blog/saveArticle';
//			var data = {
//				"org_list":[{"org_id":$api.getStorage('school_id'),"org_type":104,"category_id":org_category_id}],
//				"class_list":[],
//				"group_list":[]
//		 	};
			api.ajax({
				url : typeUrl,
				method : 'post',
				dataType : 'json',
				cache : false,
				returnAll : false,
				timeout : 30,
				data : {
					values : dataValue
				},
				headers : {
					'Cookie' : 'person_id=' + $api.getStorage("person_id") + ';identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
				}
			}, function(ret, err) {
				if (err) {
					api.hideProgress();
					popToast('当前网络繁忙，请稍候再试');
				} else {
					if (ret.success) {
						var expand_id = ret.expand_id;
						var strContent = $api.getStorage("person_name") + '发表了圈子' + dataValue.title + '。';
						var options = {
							business_type:107,
				            relatived_id:ret.id,
				            r_person_id:'',
				            r_identity_id:'',
				            operation_content:strContent,
				            e_relatived_id:expand_id
						};
						creditWriteToQueue(options);
						
						var art_id = ret.id;
						var str = "加载中...";
						 api.ajax({
	                         url:BASE_URL_ACTION + '/ypt/blog_expand/release_article',
							 method :　'post',
							 dataType : 'json',
							 cache : false,
							 timeout : 30,
							 data : {
							 	values:{
								 	article_id : art_id,
								 	random_num : creatRandomNum(),
								 	data :JSON.stringify($api.getStorage('areaRange'))
								}
							 	
							},
							headers : {
					'Cookie' : 'person_id=' + $api.getStorage("person_id") + ';identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
							}
                         },function(ret,err){
                         	if(err){
                         		popToast('发表失败，请稍候再试');
                         	}else{
                     		     if(ret.success){
                     		     	var areaRange = $api.getStorage('areaRange');
		                     		for(var i=0;i < areaRange.class_list.length;i++){
		                                var options = {
		                                    business_type:131,
		                                    relatived_id:art_id,
		                                    r_person_id:areaRange.class_list[i].org_id,
		                                    r_identity_id:105,
		                                    operation_content:strContent,
		                                    e_relatived_id:expand_id
		                                };
		                                creditWriteToQueue(options);
		                            }
	                                for(var i=0;i < areaRange.group_list.length;i++){
	                                    var options = {
	                                        business_type:151,
	                                        relatived_id:art_id,
	                                        r_person_id:areaRange.group_list[i].org_id,
	                                        r_identity_id:106,
	                                        operation_content:strContent,
	                                        e_relatived_id:expand_id
	                                    };
	                                    creditWriteToQueue(options);
		                            }
                     		     	
		                     		setTimeout(function() {	
										api.execScript({
				                            name:'quanziIpad_index_window',
				                            frameName : 'quanziIpad_index_frame',
				                            script: 'initData(1);'
			                            });  
									},2000);
									   		                                      
									setTimeout(function() { 
										api.hideProgress(); 
										api.execScript({
										name : 'quanziIpad_index_window',
										script : 'back();'
										});
									}, 3000);							         
	                     		}else{
	                     			popToast('发表失败，请稍候再试');
	                     		}
                         	}
    					
                         });
					} else {
						api.hideProgress();
						popToast('当前网络繁忙，请稍候再试');
					}
				}
			});
		}

		/*
		 *author:zhaoj
		 *function:添加点击事件
		 *date：20160316
		 */
		function addClickedEvent(div_name, method_name) {
			var name = document.getElementById(div_name);
			name.addEventListener("click", method_name);
		}

		/*
		 *author:zhaoj
		 *function:删除点击事件
		 *date：20160317
		 */
		function removeClickedEvent(div_name, method_name) {
			var name = document.getElementById(div_name);
			name.removeEventListener("click", method_name);
		}

		/*
		 *author:zhaoj
		 *function:弹出Alert提示框
		 *date：20160314
		 */
		function popAlert(message) {
			api.alert({
				msg : message
			}, function(ret, err) {
			});
		}

		/*
		 *author:zhaoj
		 *function:弹出Toast提示框
		 *date：20160314
		 */
		function popToast(message) {
			api.toast({
				msg : message,
				location : 'middle'
			});
		}
		function extend(destination, source) { 
		    for (var property in source) 
			destination[property] = source[property]; 
		    return destination; 
		} 
				/*
		 *author:zhaoj
		 *function:打开本校分类window
		 *date：20160425
		 */
		function openbxflWindow(){
			var bxflID = this.getAttribute("bxflID");
			var org_id = $api.getStorage('school_id');
			var org_name = '学校分类';
			openflWindow(bxflID,104,$api.getStorage('school_id'),$api.getStorage('school_name'),'bxfl_div');
		}
		
			/*
		 *author:zhaoj
		 *function:打开学校分类window
		 *date：20160317
		 */
		function openflWindow(flID,org_type,org_id,org_name,div_id){
			api.openWin({
				name : 'quanziIpad_fl_window',
				url : 'quanziIpad_fl_window.html',
				pageParam : {
					header_h : header_h,
					flID : flID,
					org_id : org_id,
					org_type : org_type,
					org_name : org_name,
					div_id : div_id
				},
				bounces : false,
				opaque : false,
				showProgress : false,
				vScrollBarEnabled : false,
				hScrollBarEnabled : false,
				slidBackEnabled : false,
				delay : 0,
				animation : {
					type : "reveal", //动画类型（详见动画类型常量）
					subType : "from_right", //动画子类型（详见动画子类型常量）
					duration : 300
				},
			});
		}
		
		/*
		 * 提示是否要经过审核发布文章
		 * 张自强
		 * 20170726 
		 */
		function checkFB(){
			getArticleValue();
		}
		/*
		*author:zhaoj
		*function:关闭页面
		*date：20170912
		*/
		function closeFrame(){
			commonExecScript('quanziIpad_index_window','','back();',0);
		}
		
		/*
		*author:zhaoj
		*function:选择图片
		*date：20170914
		*/
		function selectPicture(){
			commonExecScript('quanziIpad_index_window','','reBackType("picture_sel_xx");',0);
			$api.removeCls($api.byId('j_select_picture'),'aui-hide');
		}
		
		/*
		*author:zhaoj
		*function:关闭选择图片
		*date：20170914
		*/
		function closePicture(){
			$api.addCls($api.byId('j_select_picture'),'aui-hide');
		}
		
		/**
		 * 打开个人分类界面
		 * 王俭
		 *  2018.5.15
		 */
		function opnePersonalClassifyrame(){
			api.execScript({
                    name : 'quanziIpad_index_window',
                    script: 'reBackType("personalClassify");'
                });
				var  pageParamJson = {
					'org_id' : org_id,
					'menu_type' : 104,
					'org_name' : org_name,
					'header_h':header_h,
					'lx_id' : 0
				};
				commonOpenFrame('personalClassify_frame','quanziIpad_personalClassify_frame.html', 0, false, false, 'rgba(0,0,0,0)', pageParamJson);
		}
		
		/**
		 * 打开发布范围界面
		 * 王俭
		 * 2018.5.15 
		 */
		function openPublishRangeFrame(){
			api.execScript({
                    name : 'quanziIpad_index_window',
                    script: 'reBackType("publishRange");'
                });
				var  pageParamJson = {
					'org_id' : org_id,
					'menu_type' : 104,
					'org_name' : org_name,
					'header_h':header_h,
					'lx_id' : 0
				};
				commonOpenFrame('publishRange_frame','quanziIpad_publishRange_frame.html', 0, false, false, 'rgba(255,255,255,0)', pageParamJson);
		}
		
		/**
         * 显示发布范围内容  personalClassfiyContent publishRangeContent
         */
        function setPublishRangeContent(){
        	var _text = $api.getStorage('publishRangeContent');
        	if (_text == "" || _text == " "){
        		_text = "仅自己可见";
        	}
        	$api.text(personalClassfiyContent, $api.getStorage('personalClassifyContent'));
        	$api.text(publishRangeContent, _text);
        }
	</script>
</html>