<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>班级通知</title>
    <link rel="stylesheet" type="text/css" href="../../../../../css/aui/aui.css"/>
    <link rel="stylesheet" type="text/css" href="../../../../../css/module/ipad/popup-body.css"/>
    <link rel="stylesheet" type="text/css" href="../../../../../css/module/common/table-body.css"/>
    <link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
    <style>
    	.popup-body-new	.commont-content{width:650px;margin-left:-325px;height:460px;margin-top:-230px;}
    	.popup-body-new	.commont-content{padding:52px 0 15px 0;}
    	.popup-body-new .commont-content .position{font-size:16px;padding:20px 0 0 30px;}
    	.content{padding:15px;max-width:100%;overflow-y:auto;}
    	.table-body th, .table-body td{font-size:15px;line-height:36px;}
    	.table-body td{padding:0;}
    	.que-answer{position:absolute;width:650px;height:408px;top:50%;left: 50%;margin-top:-178px;margin-left:-325px;z-index:99;background:rgba(0,0,0,0.6);border-radius: 0 0 15px 15px;}
    	.que-details{position:absolute;width:620px;height:380px;top:50%;left: 50%;margin-top:-190px;margin-left:-310px;z-index:999;background:#fff;padding-bottom:45px;padding:10px 15px;}
    	.max-height{max-height:320px;height:320px;overflow-y: auto;border-bottom:1px dashed #d0d0d0;}
    	.close-btn{width: 60px;position: absolute;right: 30px;bottom: 25px;line-height: 30px;font-size: 16px;text-align: center;color: #fff;z-index:9999;}
    	.title{color:#000;}
    	.fj-answer li{width:16%;float:left;margin-right: 4.5%;padding-bottom: 10px;color:#333;}
    	.text-answer{color:#333;}
    	.fj-answer li:nth-child(5n){margin-right:0;}
    	.fj-answer li img{width:100%;}
    	.zoomImage{padding-bottom:80%;}
        .zoomImage img{position:absolute;width:100%;top:0;bottom:0;height:100%;}
    </style>
</head>
<body class="popup-body-new common-ipad-tibenIpad-tea">
	<div id="j_answer" class="que-answer aui-hide">
		<div class="que-details">
			<div class="max-height">
				<div class="title ptb10">附件答案</div>
				<div d="j_fj_answer" class="fj-answer">
					<div id="j_no_data" class="no-data aui-hide">
                      	  没有附件答案
                    </div>
					<ul id="j_zg_answers">
					</ul>
				</div>
				<div class="title ptb10">文本答案</div>
				<div id="j_text_answer" class="text-answer word-wrap pb15">
					<div id="j_text_data" class="no-data ">
                      	  没有附件答案
                    </div>
				</div>
			</div>
		</div>
		<div class="close-btn" onclick="commonAddOrRemoveHideCss('j_answer',0);">关闭</div>
	</div>
	<div class="commont-content">
		<div class="top fl">
			<div class="name">错误详情</div>
			<div class="close fr" onclick="closeFrame();"></div>
		</div>
		<div id="div_body" class="content"></div>
		<script id="div_script" type="text/html">
			<table class="table-body">
				<tbody>
					<tr>
						<th>序号</th>
						<th>学生姓名</th>
						<th>所在班级</th>
						<th>收录时间</th>
						<th>学生答案</th>
					</tr>
					<%if(stu_list.length == 0){%>
						<tr>
							<td colspan="5">暂无错误详情</td>
						</tr>
					<%}else{%>
						<%for(var i=0;i<stu_list.length;i++){%>
							<tr>
								<td><%=i+1%></td>
								<td><%=stu_list[i].student_name%></td>
								<td><%=stu_list[i].class_name%></td>
								<td><%=stu_list[i].create_time.substring(0,16)%></td>
								<td>
									<%if(stu_list[i].stu_answer!=""&&stu_list[i].stu_answer!=null){%>
										<%if(stu_list[i].qt_type==1){%>
											<%=stu_list[i].stu_answer%>
										<%}else{%>
											<a title="查看"  onclick="getAnswerByStuZyQueId('<%=stu_list[i].student_id%>','<%=stu_list[i].question_id_char %>','<%=stu_list[i].zy_id%>','<%=stu_list[i].que_source %>','<%=stu_list[i].jy_subject_en_name %>');" data-target="#gridSystemModal" data-toggle="modal">查看</a>
										<%}%>
									<%}else{%>
										未作答 
									<%}%>
								</td>
							</tr>
						<%}%>	
					<%}%>
				</tbody>
			</table>
		</script>
	</div>
</body>
<script type="text/javascript" src="../../../../../script/api.js"></script>
<script type="text/javascript" src="../../../../../script/base_config.js" ></script>
<script type="text/javascript" src="../../../../../script/common/common.js"></script>
<script type="text/javascript" src="../../../../../script/plug-in/template.js" ></script>
<script type="text/javascript" src="../../../../../script/assembly/Merge.js"></script>
<script type="text/javascript" src="../../../../../script/assembly/executeApp.js" ></script>
<script type="text/javascript" src="../../../../../script/assembly/openResource.js" ></script>
<script type="text/javascript" src="../../../../../script/assembly/photoBrowser.js"></script>
<script type="text/javascript" src="../../../../../script/assembly/trans.js"></script>
<script type="text/javascript">
	apiready = function(){
		commonSetTheme({"level":5,"type":0});
		getStuListByQuesId()
	};
	/*
	*author:zhaoj
	*function:关闭页面
	*date：20170912
	*/
	function closeFrame(){
		commonExecScript('tibenIpad_detail_window','','back();',0);
	}
	/*
	* author:zhaoj
	* function:获取错误详情学生列表数据
	* interface：陈续刚
	* data:20171012
	*/
	function getStuListByQuesId(){
		showSelfProgress('加载中...');
		api.ajax({
			url : BASE_URL_ACTION + '/xx/getStuListByQuesId?teacher_id='+$api.getStorage("person_id")+'&wq_type=1&pageSize=10000&pageNumber=1&question_id_char='+api.pageParam.question_id_char+'&que_source='+api.pageParam.que_source+'&random_num='+creatRandomNum(),
			method : 'get',
			timeout : 30,
			dataType : 'json',
			cache : false,

			headers : {
				'Cookie' : 'person_id='+$api.getStorage("person_id")+';identity_id='+$api.getStorage("identity")+'; token='+$api.getStorage("token_ypt")+';'
			}
		}, function(ret, err) {
			api.hideProgress();
			if (err) {
				popToast('获取题目详情失败，请稍候重试');
			} else {
				if(ret.success){
					for(var i=0;i<ret.stu_list.length;i++) {
							if (ret.stu_list[i].que_source == 2) {
								if (ret.stu_list[i].qt_type == 1) {
									ret.stu_list[i].stu_answer=ret.stu_list[i].stu_answer.replace("0", "A");
									ret.stu_list[i].stu_answer=ret.stu_list[i].stu_answer.replace("1", "B");
									ret.stu_list[i].stu_answer=ret.stu_list[i].stu_answer.replace("2", "C");
									ret.stu_list[i].stu_answer=ret.stu_list[i].stu_answer.replace("3", "D");
								}
							}
						}
					commonAddOnceHtml('div_body','div_script',ret);
				}else{
					popToast('获取题目详情失败，请稍候重试');
				}
			}
		});
	}
	/*
	* author:zhaoj
	* function:获取主观题学生作答详情
	* interface：陈续刚
	* data:20171012
	*/
	function getAnswerByStuZyQueId(student_id,question_id_char,zy_id,que_source,jy_subject_en_name){
		showSelfProgress('加载中...');
		api.ajax({
			url : BASE_URL_ACTION + '/xx/getAnswerByStuZyQueId?student_id='+student_id+'&p_type=2&identity_id=6&is_need_html=0&zy_id='+zy_id+'&pageNumber=1&question_id_char='+question_id_char+'&que_source='+que_source+'&jy_subject_en_name='+jy_subject_en_name+'&random_num='+creatRandomNum(),
			method : 'get',
			timeout : 30,
			dataType : 'json',
			cache : false,

			headers : {
				'Cookie' : 'person_id='+$api.getStorage("person_id")+';identity_id='+$api.getStorage("identity")+'; token='+$api.getStorage("token_ypt")+';'
			}
		}, function(ret, err) {
			$api.text($api.byId('j_zg_answers'), '');
			if (err) {
				api.hideProgress();
				popToast('获取答案失败，请稍候重试');
			} else {
				if(ret.success){
					if(ret.qt_type != 1){
						//主观题
						var answer_list = ret.stu_answer;
						//文本答案
						if($api.trim(ret.stu_answer_txt).length > 0){
                        	$api.text($api.byId('j_text_answer'),ret.stu_answer_txt);
                        }
						for(var i = 0; i < answer_list.length; i++){
							if(answer_list[i].resource_id_int > 0){
								if(answer_list[i].resource_type == 1){
									//图片
									answer_list[i].type = 5;
								}else{
									//其他格式
                            		answer_list[i].type = 3;
                            	}
                            }else{
                            	answer_list[i].type = 4;
                            }
                            answer_list[i].img_url = '';
							answer_list[i].resource_format = answer_list[i].ext;
							var img_url= getImgUrl(answer_list[i]);
							answer_list[i].img_url = img_url;
						}
						if(answer_list.length > 0){
							exePic(0,answer_list,function(flag,data){
								api.hideProgress();
								if(flag){
									for(var i = 0; i < data.length; i++){	
										showImg(data[i]);
									}
								}
							});
						}else{
							api.hideProgress();
							commonAddOrRemoveHideCss('j_no_data',1);
						}
						commonAddOrRemoveHideCss('j_answer',1);
					}
				}else{
					api.hideProgress();
					popToast('获取答案失败，请稍候重试');
				}
			}
		});
	}
	/*
    *author:zhaoj
    *function:获取缩略图路径
    *date：20170901
    */
	function getImgUrl(img_json){
		var img_url;//缩略图路径
        if(img_json.type == 0 || img_json.type == 5){
            //图片
            if (BASE_APP_TYPE == 1) { 
                img_url = BASE_IMAGE_PRE + url_path_suffix + img_json.file_id.substring(0, 2) + '\/' + img_json.file_id + '.' + img_json.resource_format + commonReturnPhotoCutSize(0);
            } else {
                img_url = BASE_URL_ACTION + BASE_IMAGE_BEGIN + img_json.file_id.substring(0, 2) + '/' + img_json.file_id + '.' + img_json.resource_format + commonReturnPhotoCutSize(0);
            }
        }else if(img_json.type == 1){
            //音频
            img_url = "../../../../../image/module/iphone/zuoye/audio.png";
        }else if(img_json.type == 2){
            //视频
            img_url = "../../../../../image/module/iphone/zuoye/player.png";
        }else if(img_json.type == 3){
        	//资源库中的缩略图
            if (BASE_APP_TYPE == 1) {
				img_url = url_path + BASE_THUMB_BEGIN + img_json.thumb_id.substring(0, 2) + '\/' + img_json.thumb_id + BASE_THUMB_END;
			} else {
				img_url = BASE_URL_ACTION + BASE_THUMB_BEGIN + img_json.thumb_id.substring(0, 2) + '/' + img_json.thumb_id + BASE_THUMB_END;
			}
		}else{
			//之前上传的答案图片
			 if (BASE_APP_TYPE == 1) {
				img_url = BASE_IMAGE_PRE+"down/App/"+ img_json.file_id.substring(0, 2) + "/" + img_json.file_id + '.' + img_json.ext + commonReturnPhotoCutSize(0);
			} else {
				img_url = BASE_URL_ACTION + "/html/thumb/App/" + img_json.file_id.substring(0, 2) + "/" + img_json.file_id + '.' + img_json.ext + commonReturnPhotoCutSize(0);
			}
		}
		return img_url;
	}
	/*
    *author:zhaoj
    *function:上传音频、视频、图片的缩略图
    *date：20170901
    */
    function showImg(img_json){
        var openHtml = "openAnswer('"+img_json.resource_id_int+"','"+img_json.img_url+"','"+ img_json.resource_info_id+"','"+ img_json.resource_type+"','"+ img_json.is_base64+"','"+ img_json.file_id+"','"+ img_json.ext+"')";
        var li_html = '<li class="fl" onclick="'+openHtml+'">';
        var mr_picture = "this.src='../../../../../image/fun-module/common/wk_default.png'";
    	if(img_json.type == 2){
    		//视频默认图片
    		li_html +='<div class="zoomImage" style="background:#141414 url('+img_json.img_url+') center center no-repeat;background-size:35% auto;"></div>';
    	}else{
        	li_html +='<div class="zoomImage"><img src="'+img_json.img_url+'" onerror="'+mr_picture+'" /></div>';
        }
        li_html +='<div class="title ellipsis pt5">'+img_json.resource_title+'</div>';
        li_html +='</li>';
        $api.append($api.byId('j_zg_answers'), li_html);
    }
    /*
        *author:zhaoj
        *function:打开主观题答案
        *date：20170904
        */
        function openAnswer(resource_id_int,img_url,resource_info_id,resource_type,is_base64,file_id,ext){
        	if(resource_id_int < 0 || resource_type == 1){
        		api.execScript({
				    name: api.winName,
				    script: 'reBackType("picture")'
				});
        		if(is_base64==1){
        			//有批阅痕迹的图片，先将base64转换成图片，接下来在进行显示
        			var save_url = BASE_DOWNLOAD_YY_PATH.substring(0,BASE_DOWNLOAD_YY_PATH.length-1);
        			var index = img_url.indexOf('base64');
        			var finish_img_url = img_url.substring(index+7,img_url.length);
        			var imgName = file_id+'.'+ext;
        			trans.saveImage({"base64Str":finish_img_url,"imgPath":save_url,"imgName":imgName},function(flag,data){
        				if(flag){
        					common_openPicture.open(data,api.winName);
        				}else{
        					popToast('打开失败，请稍候重试');
        				}
        			});
        		}else{
        			common_openPicture.open(img_url,api.winName);
        		}
        	}else{
        		var param_json = {"is_show_tip":1,"resource_id_int":resource_id_int,"resource_info_id":resource_info_id};
        		commonGetResInfo(param_json,function(flag,ret){
        			api.hideProgress();
        			if(flag){
 						common_openResource.open(ret.resource_format,ret.file_id,ret.resource_title,ret.m3u8_status,api.winName,'reBackType("voice");','back();',ret.resource_id_int);
        			}else{
        				popToast('打开失败，请稍候重试');
        			}
        		});
        	}
        }
	//处理图片
		function exePic(index,answer_list,callback){
			if(index < answer_list.length){
				if(answer_list[index].piyue_file_path != null && answer_list[index].resource_type == 1){
					api.download({
					    url: answer_list[index].img_url,
					    savePath: 'fs://lxjxt/yingyong/zuoye/'+answer_list[index].file_id+'.'+answer_list[index].ext,
					    report: false,
					    cache: true,
					    allowResume: true
					},function( ret, err ){
						if(err) {
							api.toast({
			                    msg:'服务器连接失败，未找到主观题检测'
		                    });
		                    callback(true);
						} else {
							if(ret.percent == 100) {
	                    		var savePath = ret.savePath;
					            MergePic(savePath, answer_list[index].piyue_file_path, function(result) {
				            		//调用这个方法合成试题和批阅痕迹,reslut为base64；建议用chrome查看该demo
									for(var i = 0; i < answer_list.length; i++){
										if(answer_list[i].file_id == answer_list[index].file_id){
											answer_list[i].img_url = result;
											answer_list[i].is_base64 = 1;
											index++;
											return exePic(index,answer_list,callback);
										}
									}
								});
	                    	}else{
	                    		index++;
								return exePic(index,answer_list,callback);
	                    	}
						}
					});
				}else{
					index++;
					return exePic(index,answer_list,callback);
				}
			}else{
				callback(true,answer_list);
			}
		}
</script>
</html>