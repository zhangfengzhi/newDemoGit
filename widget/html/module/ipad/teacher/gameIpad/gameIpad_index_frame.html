<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>游戏</title>
    <link rel="stylesheet" type="text/css" href="../../../css/aui/aui.css"/>
    <style>
		.time-axis{padding:30px 0 10px 0;}
    	.time-axis-body{background:#fff;}
    	.time-axis-top-blank{height:20px !important;}
    	.time-axis-content{min-height:155px;}
    	.time-axis-content .tip{color:#fff;width:40px !important;height:20px !important;line-height:20px;text-align:center;border-radius:5px !important;top:0 !important;right:-18px !important;font-size:14px !important;}
    	.time-axis-body .time-axis-content .img img{bottom:0 !important;width:100%;height:100%;}
    	.bottom-name,.study-count{position:absolute;bottom:0;height:30px;line-height:32px;color:#fff;font-size:14px;}
    	.bottom-name{width:100%;left:0;background:rgba(0,0,0,0.6);padding:0 110px 0 8px;}
    	.study-count{right:0;padding-right:8px;}
    	.time-axis-body .time-axis-content .zoomImage{padding-bottom:63%;}
	</style>
</head>
<body class="axis-body">
	<div class="msg-top"></div>
	<div id="msg_top_all" style="height:0px; overflow:hidden"></div>
	<div class="time-axis">
		<div id="j_blank" class="time-axis-top-blank aui-hide"></div>
		<div id="div_body" class="time-axis-body clearfix"></div>
		<script type="text/html" id="div_script">
			<% if(list.length == 0){ %>
				<div class="no-data"><span>暂无游戏</span></div>
			<% }else{ %>
				<%for(var i=0; i < list.length; i++) {%>
					<div class="time-axis-content clearfix" onclick="openDetailWindow('<%=list[i].name_base64%>','<%=list[i].zt_thumb_url%>',<%=list[i].id%>,<%=list[i].res_id%>,'<%=list[i].create_time.substring(0,16)%>');"">
						<div class="img zoomImage">
							<img onerror="this.src='../../../image/yingyong/weike/wk_default.png'" src="../../../image/yingyong/weike/wk_default.png" data-echo="<%=list[i].game_thumb_url%>" />
							<div class="bottom-name ellipsis"></div>
							<div class="study-count">学习次数：<%=list[i].play_count%></div>
						</div>
						<div class="name ellipsis"><%=list[i].res_name%></div>
					</div>
				<%}%>
			<% } %>
		</script>
	</div>
</body>
<script type="text/javascript" src="../../../script/api.js"></script>
<script type="text/javascript" src="../../../script/base_config.js" ></script>
<script type="text/javascript" src="../../../script/plug-in/base64.js" ></script>
<script type="text/javascript" src="../../../script/plug-in/template.js" ></script>
<script type="text/javascript" src="../../../script/plug-in/echo.min.js"></script>
<script type="text/javascript" src="../../../script/common/common.js"></script>
<script type="text/javascript" src="../../../script/yingyong/game/game.js"></script>
<script type="text/javascript">
	var header_h;//顶部header高度
	var currentPage=1;//当前分页数
	var totalPages;//总页数
	var BASE_URL_ACTION;
	var subject_id;//学科id
	var type_id;//专题类型
	var keyword = "";//搜索条件
	var order_type=1;//排序方式，1最新，2最热
	var subject_data;//菜单学科html
	var total_param={};
	apiready = function(){
		header_h = api.pageParam.header_h;
		BASE_URL_ACTION = $api.getStorage('BASE_URL_ACTION');
		total_param.person_id = $api.getStorage("person_id");
		total_param.identity = $api.getStorage("identity");
		showSelfProgress("加载中...");
		isSamePerson(function(flag){
			getSubjectByStudentId(function(ret){
				if(ret.ssvt_list.length>0){
					subject_data =ret;
					if(flag && $api.getStorage("game_subject_id")>=0&&$api.getStorage("game_order_type")){
						subject_id = $api.getStorage("game_subject_id");
						order_type = $api.getStorage("game_order_type");
					}else{
						subject_id = ret.ssvt_list[0].xk_id;
					}
					openNavigationBar();//打开专题类型滑动条
				}else{
					popAlertAndShowTitle("提示",Base64.encode("您还没有任课教师"),"closeIpadWindow()");
				}
			});
		});	
		commonRefreshHeaderInfo();//下拉刷新
		commonScrollBottomReload();//上拉加载更多数据
	};
	
	/**
	 * 打开游戏类型
	 * 周枫
	 * 2016.12.26 
	 */
	function openNavigationBar() {
		commonCloseNavigationBar();
		//获取游戏类型
		gametypelist(function(data){
			var bar_items = [
				{
					"title" : '全部',
					"id" : -1,
				}
			];
			for(var i = 0; i < data.list.length; i++){
				var oparam = new Object();
				oparam.title = data.list[i].game_type_name;
				oparam.id = data.list[i].game_type_id;
				bar_items.push(oparam);
			}
			var params = {
				y : header_h+1,
				w : api.winWidth-300,
				h:64,
				items : bar_items,
				winName : 'gameIpad_index_window',
				frameName : 'gameIpad_index_frame',
				file_level:2
			};
			commonMyNavigationBar(params);
		});
	}
	/*
	*author:zhaoj
	*function:点击游戏类型回调函数
	*date：20161220
	*/
	function callBackNew(id, index) {
		type_id = id;
		showSelfProgress("加载中...");
		msg_top_all.scrollIntoView();//切换学科时，定位到最上方 
		initData(1);
	}
	/*
	*author:zhaoj
	*function:加载数据
	*date：20161220
	*/
	function initData(current_page){
		currentPage = current_page;
		var list_url = "";
		if(subject_id>0){
			getGameOrTopicList(function(ret){
				totalPages = ret.totalPage;
				var data = getImgUrl(ret);
				commonAddManyHtml('div_body','div_script',data);
				//延迟加载图片
				setTimeout(function() {
					echoInit();
				}, 300);
			});
		}else{
			getGameTopicPreview(function(ret){
				var data = getImgUrl(ret);
				commonAddOnceHtml('div_body','div_script',data);
				//延迟加载图片
				setTimeout(function() {
					echoInit();
				}, 300);
			});
		}
		
		//通知顶部下拉刷新数据加载完毕，组件会恢复到默认状态
		commonControlRefresh();
		api.hideProgress();
	}
	
	function getImgUrl(ret){
		var list_l = getJsonObjLength(ret.list);
        if (list_l > 0) {
            for (var i = 0; i < list_l; i++) {
                var game_thumb_id = ret.list[i].thumb_url;
                var extension = game_thumb_id.split(".")[1];
                var index = game_thumb_id.lastIndexOf('.');
                game_thumb_id = game_thumb_id.substring(0,index);
                var game_thumb_url = BASE_IMAGE_PRE_ONLY_YUN + BASE_GAME_TOPIC_PATH + game_thumb_id.substring(0, 2) + '\/' + game_thumb_id+'.' + extension + commonReturnPhotoCutSize(0,0,0,undefined,1);
                ret.list[i]["game_thumb_url"] = game_thumb_url;
                
                ret.list[i]["name_base64"] = Base64.encode(ret.list[i].res_name);
            }
        }
        return ret;
	}
	
	/*
	*author:zhaoj
	*function:打开游戏详情页面
	*date：20161220
	*/
	function openDetailWindow(name_base64,img_url,id,res_id,create_time) {
		var pageParamJson = {"header_h":header_h,"name_base64":name_base64,"img_url":img_url,"id":id,"res_id":res_id,"create_time":create_time};//打开window页面json数据
		commonOpenWin('gameIpad_detail_window', 'gameIpad_detail_window.html', false, false, pageParamJson);
	}
	
	function openMenuFrame(){
		var li_html = "";
		if(subject_id == 0){
			li_html = '<li class="active" onclick="changeType(this,1,0)"><span>最近访问</span></li>';
		}else{
			li_html = '<li onclick="changeType(this,1,0)"><span>最近访问</span></li>';
		}
		for(var i = 0; i < subject_data.ssvt_list.length; i++){
			if(subject_id == subject_data.ssvt_list[i].xk_id){
				li_html = li_html + '<li class="active" onclick="changeType(this,1,'+subject_data.ssvt_list[i].xk_id+')"><span>'+subject_data.ssvt_list[i].xk_name+'</span></li>';
			}else{
				li_html = li_html + '<li onclick="changeType(this,1,'+subject_data.ssvt_list[i].xk_id+')"><span>'+subject_data.ssvt_list[i].xk_name+'</span></li>';
			}
		}
		pageParamJson={"header_h":header_h,"subject_id":subject_id,"order_type":order_type,"li_html":li_html};//打开frame页面json数据
		//打开游戏菜单的frame页面
		commonOpenFrame("gameIpad_menu_frame","gameIpad_menu_frame.html",header_h,false,false,"#ffffff",pageParamJson);
	}
	
	
	/*
	*author:zhaoj
	*function:切换学科和排序
	*date：20161224
	*/
	function changeType(subject,order){
		subject_id = subject;
		order_type = order;
		recordeHistoryType();
		openNavigationBar();
		initData(1);
		commonExecScript('gameIpad_index_window','','back();',0);
	}
	/*
	*author:zhaoj
	*function:设置搜索值，并根据搜索条件加载相关数据数据
	*date：20161220
	*/
	function setKeyword(data) {
		keyword = data;
    	currentPage = 1;
    	initData(currentPage);
	}
	
	function setMenuReload(sub_id, ord_type){
		showSelfProgress("加载中...");
		subject_id = sub_id;
		order_type = ord_type;
		initData(1);
	}
	/*
	*author:zhaoj
	*function:记录这次的操作
	*date：20161226
	*/
	function recordeHistoryType(){
		$api.setStorage("game_subject_id",subject_id);
		$api.setStorage("game_order_type",order_type);
		$api.setStorage('game_person_id',$api.getStorage("person_id"));
	}
	/*
	*author:zhaoj
	*function:判断是否为同一个人登录
	*date：20161226
	*/
	function isSamePerson(callback){
		if($api.getStorage('game_person_id') == $api.getStorage("person_id")){
			callback(true);
		}else{
			callback(false);
		}
	}
	
</script>
</html>