<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
        <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
        <title></title>
        <link rel="stylesheet" type="text/css" href="../../../../../css/aui/aui.css"/>
        <link rel="stylesheet" type="text/css" href="../../../../../css/module/iphone/init-screen.css"/>
    	<link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
        <link rel="stylesheet" type="text/css" href="../../../../../css/module/ipad/popup-body.css"/>
        <style>
			body{background:transparent;}
			.popup-body-new .commont-content .name{font-size:18px;}
			.popup-body-new	.commont-content{width:60%;height:550px;margin-top:-260px;margin-left:-30%;padding:45px 0 0 0}
			.popup-body-new .commont-content .top{height:45px;line-height:45px;border-radius:10px 10px 0 0;}
			.popup-body-new	.commont-content{border-radius:10px;}
			.popup-body-new .commont-content .close{background-size:15px auto;}
            .right-content { height: 100%; max-height:100%; overflow-y:auto; padding: 0 15px;background: #ffffff;
border-radius: 0 0 10px 10px; }
            .right-content ul > li { height: 49px; line-height: 49px;  border-bottom: 1px solid #ececec; color: #717171;font-size: 16px; }
            .right-content ul > li.active {color: #FF9304 !important;}
            .more_confirm{position: absolute;bottom: 10px;right: 10px;background: #4991dd;color: #fff;padding: 5px 12px 4px 12px;}
            .no-data{font-size:15px; }
            .select-person{position:relative;padding:10px 0 0 80px;}
	    	.select-person .per-name{position:absolute;left:0;line-height:50px;padding-left:20px;font-size:16px;}
	    	.select-show ul li{display:inline-block;padding: 0 10px;margin:7px 10px 0 0;background:#EEEEEE;height:35px;line-height:35px;font-size:16px;}
	    	.select-show ul li.active{color:#fff;}
	    	.participant-top{margin:10px 0px;}
	    	
	    	.time-title{
        		padding-top: 15px;
        	}
        	.time-div{
        		text-align: center;
        		padding-top: 15px;
        	}
        	.select-time-div{
        		display: inline-block;
        		width: 45%;
        	}
        	.link-div{
        		display: inline-block;
        		width: 5%;
        	}
        	
        	.no-clcik{
        		pointer-events: none;
        		background-color: #c0c0c0 !important;
        	}
        </style>
    </head>
    <body class="common-ipad-zthd-tea popup-body-new">
		<div class="commont-content">
			<div class="top fl">
				<div class="name" id="title"></div>
				<div class="close fr" onclick="closeFrame();"></div>
			</div>
			<div class="content">
				<div class="right-content">
					<div class="time-title">活动日期：</div>
					<div class="time-div">
						<div class="select-time-div">
							<div id="j_time_0_div" onclick="openTime(0);">
								<input oninput="commonRemoveExpression(this)" id="j_time_0" type="text" disabled="true" placeholder="开始日期（必填）"/>
							</div>
						</div>
						<div class="link-div">至</div>
						<div class="select-time-div">
							<div id="j_time_1_div" class="input-box-jieshao clearfix" onclick="openTime(1);">
								<input oninput="commonRemoveExpression(this)" id="j_time_1" type="text" disabled="true" placeholder="结束日期（必填）"/>
							</div>
						</div>
					</div>
				
		            <ul id="ul_body">
		            	<li id="1" onclick="changeCyqx(1,this)">所有人</li>
						<li id="2" onclick="changeCyqx(2,this)">全部教师</li>
						<li id="3" onclick="changeCyqx(3,this)">全部学生</li>
						<li id="4" onclick="changeCyqx(4,this)">指定对象</li>
		            </ul>
		            <div id="j_xzdx" class="select-show aui-hide clearfix">
						<div class="select-person clearfix">
							<div class="per-name">学生：</div>
							<ul id="j_select_object" class="clearfix pb10">
			<!--					<li>2016级5班</li>
								<li class="active">2016级5班</li>
								<li>2016级5班</li>
								<li>2016级5班</li>-->
							</ul>
							<script id="select_object_script" type="text/html">
								<%if(class_list == 0){%>
									<li>暂无班级</li>
								<%}else{%>
									<%for(var i=0;i<list.length;i++){%>
									    <%if(!list[i].is_group){%>
									      <li id="j_<%=list[i].org_id%>" c_org_id='<%=list[i].c_org_id%>' onclick="selectObject(this,'<%=list[i].org_id%>','<%=list[i].c_org_id%>');">
									      	<%=list[i].org_name%>
									      </li>
										<%}%>
										<%if (class_length - 1 == i){%>
			                        		<br />
			                        	<%}%>
									<%}%>
								<%}%>	
							</script>
						</div>
						<div class="select-person clearfix">
			                <div class="per-name">群组:</div>
			                <ul id="j_select_object_qz" class="clearfix pb10">
			<!--                    <li>2016级5班</li>
			                    <li class="active">2016级5班</li>
			                    <li>2016级5班</li>
			                    <li>2016级5班</li>-->
			                </ul>
			                <script id="select_object_script_qz" type="text/html">
			                    <%if(group_list == 0){%>
			                        <li>暂无群组</li>
			                    <%}else{%>
			                        <%for(var i=0;i<list.length;i++){%>
			                             <%if(list[i].is_group){%>
			                            	<li id="j_<%=list[i].org_id%>" c_org_id='<%=list[i].c_org_id%>' onclick="selectObject(this,'<%=list[i].org_id%>','<%=list[i].c_org_id%>');"><%=list[i].org_name%></li>
			                            <%}%>
			                        <%}%>
			                    <%}%>   
			                </script>
			            </div>
					</div>
					<div id="participant_show" class="aui-hide participant-top">
						<input id="participant_show_checkBox" type="checkbox" class="aui-checkbox" onchange="changeVisible(this.checked)">
						<label for="participant_show_checkBox">&nbsp;仅参与对象可见</label>
					</div>
	            </div>
			</div>
			<div id="more_confirm" class="more_confirm" onclick="confirm();">确定</div>
		</div>
	</body>
    <script type="text/javascript" src="../../../../../script/api.js"></script>
    <script type="text/javascript" src="../../../../../script/base_config.js" ></script>
    <script type="text/javascript" src="../../../../../script/plug-in/template.js" ></script>
    <script type="text/javascript" src="../../../../../script/common/common.js" ></script>
    <script type="text/javascript" src="../../../../../script/assembly/openPicker.js"></script>
    <script type="text/javascript" src="../../../../../script/plug-in/base64.js" ></script>
    <script type="text/javascript">
    	var title;
    	var lobal_variable={};//全局变量json
    	var from_html;
    	var participant_show;
    	var isOnlyShowOfPartaker = false;//是否仅参与对象可见
    	var jsonData;//发布活动时的数据
    	var nowTime = {};//活动时间
    	var first_check_time=true;//第一次选择时间
        apiready = function() {
        	commonSetTheme({"level":5,"type":0});
        	participant_show = $api.byId('participant_show');
        	from_html = api.pageParam.from_html;
        	if (from_html == 'detail' || from_html == 'edit'){
        		if (api.pageParam.jsonData && api.pageParam.jsonData.isAgainPublish){
	        		lobal_variable.p_object = api.pageParam.jsonData.p_object;
	        		lobal_variable.release_org = api.pageParam.jsonData.release_org;
	        		lobal_variable.toopic_id = api.pageParam.jsonData.toopic_id;
	        		$api.val($api.byId('j_time_0'), api.pageParam.jsonData.start_time.substring(0,10));
	        		$api.removeAttr($api.byId('j_time_0_div'), 'onclick');
	        		$api.css($api.byId('j_time_0'), 'color:#ddd');
	        		$api.val($api.byId('j_time_1'), api.pageParam.jsonData.end_time.substring(0,10));
	        		if (api.pageParam.jsonData.is_show_person){
	        			$api.attr($api.byId('participant_show_checkBox'), 'checked',true);
	        			isOnlyShowOfPartaker = true;
	        		}
	        	}else{
	        		lobal_variable.p_object =1;
	        	}
        	}else{
				lobal_variable=$api.getStorage('zthd_lobal_variable');
        	}
        	
        	title = api.pageParam.title;
        	if (api.pageParam.jsonData && api.pageParam.jsonData.isAgainPublish){
        		$api.text($api.byId("title"),"修改发布");
        	}else{
        		$api.text($api.byId("title"),"发布活动");
        	}
        	
        	changeCyqx(lobal_variable.p_object*1,$api.byId(lobal_variable.p_object));
        };
         /*
    *author:zhaoj
    *function:设置参与权限
    *date：20171019
    */
    function changeCyqx(type,self){
    	var domAll = $api.domAll($api.byId('ul_body'), '.active');
    	for(var i=0;i<domAll.length;i++){
    		$api.removeCls(domAll[i],'active');
    	}
    	$api.addCls(self,'active');
    	switch(type*1){
    		case 1:
    			//公开
    			lobal_variable.p_object =1;
    			commonAddOrRemoveHideCss('j_xzdx',0);
    			$api.addCls(participant_show, 'aui-hide');
    			break;
    		case 2:
    			//全部教师
    			lobal_variable.p_object =2;
    			commonAddOrRemoveHideCss('j_xzdx',0);
    			$api.removeCls(participant_show, 'aui-hide');
    			break;
    		case 3:
    			//全部学生
    			lobal_variable.p_object =3;
    			commonAddOrRemoveHideCss('j_xzdx',0);
    			$api.removeCls(participant_show, 'aui-hide');
    			break;
    		case 4:
    			//指定参与对象
    			lobal_variable.p_object =4;
    			get_class_byteacherid();
    			$api.removeCls(participant_show, 'aui-hide');
    			break;
    	}
    }
    /*
    *author:zhaoj
    *function:通过教师id和身份获取所任教班级
    *interface:张海
    *date：20171023
    */
    function get_class_byteacherid(){
    	showSelfProgress('加载中...');
    	api.ajax({
	    	url : BASE_URL_ACTION+'/ypt/space/topic/get_class_byteacherid?random_num='+creatRandomNum()+'&person_id='+$api.getStorage("person_id")+'&identity_id='+$api.getStorage("identity"),
			method : 'get',
			timeout : 30,
			dataType : 'json',
			headers : {
				'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
			}
        },function(ret,err){
        	if(err){
        		api.hideProgress();
        		popToast('获取任教班级信息失败，请稍候重试');
        	}else{
        		if(ret.success){
        		       ret.class_length = ret.list.length;
        			for(var i =0; i < ret.list.length; i++){
        				ret.list[i].is_group = 0;
        				if (!ret.list[i].c_org_id){
        					ret.list[i].c_org_id = -1;
        				}
        			}
        			get_group_bypersonid(ret);
//      			get_topic_spanclass_group_bypersonid(ret);
        		}else{
        			api.hideProgress();
        			popToast('获取任教班级信息失败，请稍候重试');
        		}
        	}
        });
    }
    /**
     *获取跨班分组 
     */
    function get_topic_spanclass_group_bypersonid(data){
    	api.ajax({
	        url:BASE_URL_ACTION+'/ypt/space/topic/get_topic_spanclass_group_bypersonid?random_num='+creatRandomNum()+'&person_id='+$api.getStorage("person_id"),
        	method : 'get',
			timeout : 30,
			dataType : 'json',
			headers : {
				'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
			}
        },function(ret,err){
        	if(ret.success){
        		  for(var i =0; i < ret.list.length; i++){
        				ret.list[i].is_group = 0;
        				ret.list[i].c_org_id = -1;
        				data.list.push(ret.list[i]);
        			}
        			get_group_bypersonid(data);
        		}else{
        			popToast('获取群组信息失败，请稍候重试');
        		}
        });
    }
    
    /*
    *author:zhaoj
    *function:通过person_id和身份id 获取所在的群组
    *interface:张海
    *date：20171023
    */
    function get_group_bypersonid(data){
    	api.ajax({
	    	url : BASE_URL_ACTION+'/ypt/space/topic/get_group_bypersonid?random_num='+creatRandomNum()+'&person_id='+$api.getStorage("person_id")+'&identity_id='+$api.getStorage("identity"),
			method : 'get',
			timeout : 30,
			dataType : 'json',
			headers : {
				'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
			}
        },function(ret,err){
        	api.hideProgress();
        	if(err){
        		popToast('获取群组信息失败，请稍候重试');
        	}else{
        		if(ret.success){
        		  data.group_list = ret.list.length;
        			for(var i =0; i < ret.list.length; i++){
        				ret.list[i].is_group = 1;
        				ret.list[i].org_level = 106;
        				ret.list[i].org_name = ret.list[i].group_name;
        				ret.list[i].org_id = ret.list[i].group_id;;
        				ret.list[i].c_org_id = "false";
        				
        				data.list.push(ret.list[i]);
        			}
        		}else{
        			popToast('获取群组信息失败，请稍候重试');
        		}
        	}
        	object_json= data;
        	commonAddOnceHtml('j_select_object','select_object_script',data);
        	commonAddOnceHtml('j_select_object_qz','select_object_script_qz',data);
			commonAddOrRemoveHideCss('j_xzdx',1);
			if(lobal_variable.p_object == 4 && lobal_variable.release_org){
				for(var i = 0; i < lobal_variable.release_org.length; i++){
					var _dom = $api.byId('j_'+lobal_variable.release_org[i].org_id);
                    //设置选中对象选中样式
                    selectObject(_dom,lobal_variable.release_org[i].org_id,$api.attr(_dom, 'c_org_id'));
				}
			}
        });
    }
    /*
    *author:zhaoj
    *function:选择对象
    *date：20171023
    */
    function selectObject(self,org_id,c_org_id){
    	if (c_org_id != -1){
    		var domList = $api.domAll($api.byId("j_select_object"), 'li[c_org_id="'+c_org_id+'"]');
    	}else{
    		var domList = $api.domAll($api.byId("j_select_object"), 'li[c_org_id="'+org_id+'"]');
    	}
    	
		if($api.hasCls(self, 'active')){
			//取消选中的情况
			$api.removeCls(self, 'active');
			
			if (c_org_id != -1){
				var hasSel = false;
				for (var i = 0; i < domList.length; i++){
					if ($api.hasCls(domList[i], 'active')){
						hasSel = true;
					}
				}
				
				if (!hasSel){
					$api.removeCls($api.byId('j_'+c_org_id), "no-clcik");
				}
			}else{
				for (var i = 0; i < domList.length; i++){
					$api.removeCls(domList[i], "no-clcik");
				}
			}
		}else{
			//选中
			$api.addCls(self, 'active');
			if (c_org_id != -1){
				$api.addCls($api.byId('j_'+c_org_id), "no-clcik");
			}else{
				for (var i = 0; i < domList.length; i++){
					$api.addCls(domList[i], "no-clcik");
				}
			}
		}
  	}
    /*
    *author:zhaoj
    *function:设置选中角色的样式
    *date：20171023
    */
    function selectRole(self){
    	if($api.hasCls(self, 'active')){
			//取消选中的情况
			$api.removeCls(self, 'active');
		}else{
			//选中
			$api.addCls(self, 'active');
		}
    }
    
    /*
     *author:zfz
     *function:关闭弹出页
     *date：20171219
     */
    function closeFrame(){
		commonExecScript(api.winName, '', 'back();', 0);
    }
    
    function confirm(){
    	//参与对象
    	lobal_variable.release_org=[];
    	if(lobal_variable.p_object == 1){
    		//公开
    		var release_param = {"org_id": $api.getStorage("school_id"),"org_type": 104,"r_identity_id": "5,6,7","org_name":$api.getStorage("school_name")};
    		lobal_variable.release_org.push(release_param);
    	}else if(lobal_variable.p_object == 2){
    		//全体老师
    		var release_param = {"org_id": $api.getStorage("school_id"),"org_type": 104,"r_identity_id": "5","org_name":$api.getStorage("school_name")};
    		lobal_variable.release_org.push(release_param);
    	}else if(lobal_variable.p_object == 3){
    		//全校学生
    		var release_param = {"org_id": $api.getStorage("school_id"),"org_type": 104,"r_identity_id": "6","org_name":$api.getStorage("school_name")};
    		lobal_variable.release_org.push(release_param);
    	}else if(lobal_variable.p_object == 4){
    		//指定对象
    		for(var i = 0; i < object_json.list.length; i++){
				if(!object_json.list[i].is_group){
				    //判断班级是否选中，如果班级选中，没有选中角色，进行提示
					if($api.hasCls($api.byId('j_'+object_json.list[i].org_id), 'active')){
						var release_param = {"org_id": object_json.list[i].org_id,"org_type": object_json.list[i].org_level,"r_identity_id": "6","org_name":object_json.list[i].org_name};
						lobal_variable.release_org.push(release_param);
    				}
				}else{
					//群组
					if($api.hasCls($api.byId('j_'+object_json.list[i].org_id), 'active')){
						var release_param = {"org_id": object_json.list[i].org_id,"org_type": object_json.list[i].org_level,"r_identity_id": "5,6,7","org_name":object_json.list[i].org_name};
						lobal_variable.release_org.push(release_param);
					}
				}
			}
    	}
    	if(lobal_variable.release_org.length == 0){
    		popToast('请选择参与对象！');
    		return;
    	}
    	
    	//获取开始结束时间
    	var tempJson = {};
    	tempJson.start_time = $api.val($api.byId('j_time_0'));
    	if($api.trimAll(tempJson.start_time).length == 0){
    		popToast('活动开始日期不能为空');
    		return;
    	}
    	tempJson.start_time = tempJson.start_time+ ' 00:00:00';
    	
    	tempJson.end_time = $api.val($api.byId('j_time_1'));
    	if($api.trimAll(tempJson.end_time).length == 0){
    		popToast('活动结束日期不能为空');
    		return;
    	}
    	tempJson.end_time = tempJson.end_time+' 23:59:59';
    	
    	closeFrame();
    	
    	if (from_html !='detail'){
    		lobal_variable.start_time = tempJson.start_time;
    		lobal_variable.end_time = tempJson.end_time;
    		$api.setStorage('zthd_lobal_variable',lobal_variable)
    		commonExecScript(api.winName, 'zthdIpad_'+from_html+'_frame', 'getTopicParam("'+from_html+'",'+isOnlyShowOfPartaker+');', 1);
    	}else{
    		var jsonData = api.pageParam.jsonData;//发布活动时的数据
    		jsonData.p_object = lobal_variable.p_object;
    		jsonData.release_org = lobal_variable.release_org;
    		jsonData.start_time = tempJson.start_time;
    		jsonData.end_time = tempJson.end_time;
    		if (isOnlyShowOfPartaker){
    			jsonData.show_identity = 1;
    		}
    		jsonData.isAgainPublish = jsonData.isAgainPublish;
    		jsonData = JSON.stringify(jsonData);
    		commonExecScript(api.winName, 'zthdIpad_'+from_html+'_frame', 'publishact('+jsonData+');', 1);
    	}
    }
    
    function changeVisible(bol){
		isOnlyShowOfPartaker = bol;
	}
	
	/*
	*author:zhaoj
	*function:活动日期选择
	*param:type=0:活动开始日期；type=1：活动结束日期（必填）；
	*date：201701019
	*/
	function openTime(type){
		var nowTime = $api.val($api.byId('j_time_'+type));
		if(nowTime){
			setTime(type,nowTime);
		}else{
			getCurrentData(function(time){
			    now_time = time;
				setTime(type,time);
			});
		}
		
	}
	
	/*
	*author:zhaoj
	*function:获取当前服务器时间
	*date：201701019
	*/
	function setTime(type,nowTime){
		openPicker.open({"type":0,"time":nowTime},function(time){
			if(type){
				//结束日期
				if(Date.parse($api.val($api.byId('j_time_0')).replace(/-/g,'\/'))<=Date.parse(time.replace(/-/g,'\/'))){
					$api.val($api.byId('j_time_'+type), time);
				}else{
					if($api.val($api.byId('j_time_0')) == '' || typeof($api.val($api.byId('j_time_0'))) == undefined || $api.val($api.byId('j_time_0')) == null){
                        popAlert('请先选择开始日期！');
                    }else{
                        popAlert('结束日期不能小于开始日期！');
                    }
				}
			}else{
				//开始日期
				if(first_check_time){//第一次选择开始日期
					first_check_time = false;
					if(Date.parse(now_time.substring(0,10).replace(/-/g,'\/'))<=Date.parse(time.replace(/-/g,'\/'))){
	                    $api.val($api.byId('j_time_'+type), time);
	                }else{
	                    popAlert('不能是过去日期，请重新选择！');
	                }
				}else{//非第一次选择开始日期
					var falg_old_time = false;//结束日期小于开始日期
					var falg_less_time = false;//开始日期是过去的时间
					falg_old_time = Date.parse(time.replace(/-/g,'\/'))<=Date.parse($api.val($api.byId('j_time_1')).replace(/-/g,'\/'));
					falg_less_time = Date.parse(now_time.substring(0,10).replace(/-/g,'\/'))<=Date.parse(time.replace(/-/g,'\/'));
					if($api.val($api.byId('j_time_1')) == '' && falg_less_time){
					   falg_old_time = falg_less_time = true;
					}
					if(falg_old_time && falg_less_time){
	                    $api.val($api.byId('j_time_'+type), time);
	                }else{
	                	if(falg_old_time == false && $api.val($api.byId('j_time_1')) != ''){
	                		popAlert('结束日期不能小于开始日期！');
	                    	return;	
	                	}else{
	                		popAlert('不能是过去日期，请重新选择！');
							return;	
	                	}

	                }
				}
			}
		});
	}
	/*
	*author:zhaoj
	*function:获取当前服务器时间
	*date：201701019
	*/
	function getCurrentData(callback){
		commonGetCurrentDate(function(nowTime,nowMillisecond){
			var year = nowTime.getFullYear();    //获取完整的年份(4位,1970-????)
			var month = nowTime.getMonth()*1+1;       //获取当前月份(0-11,0代表1月)
			month = month < 10?'0'+month:month;
			var day = nowTime.getDate();        //获取当前日(1-31)
			day = day < 10?'0'+day:day;
			var hour = nowTime.getHours();       //获取当前小时数(0-23)
			hour = hour < 10?'0'+hour:hour;
			var minutes = nowTime.getMinutes();     //获取当前分钟数(0-59)
			minutes = minutes < 10?'0'+minutes:minutes;
			var time = year+'-'+month+'-'+day+' '+hour+':'+minutes;
			callback(time);
		});
	}
	
    </script>
</html>