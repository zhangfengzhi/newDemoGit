<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <title>另存为</title>
    <link rel="stylesheet" type="text/css" href="../../../../../../css/aui/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../../css/module/common/jszy_new_common.css" />
    <link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
    <style>
    </style>
</head>
<body>	
	<div id="j_shadow" class="shadow" tapmode></div>
	<div class="main bdr-rdu">
		<div id="title" class="title bdr-rdu-top"></div>
		<div class="content">
			<div class="group-name">分组名称</div>
			<div class="input-div">
				<input id="fl_val" type="text" oninput='showTip(this.value.length,this);' maxlength="10" />
				<div id="tip" class="tip">最多支持输入10个字符</div>
			</div>
		</div>
		<div class="button bdr-rdu-bottom">
			<button class="smt-btn bdr-rdu-bottom-left" tapmode="btn-click" onclick="commonCloseFrame('stuGroup_group_name_frame');">取消</button>
			<button class="cnl-btn bdr-rdu-bottom-right" tapmode="btn-click" onclick="saveGroupName();">确定</button>
		<div>
	</div>
</body>
<script type="text/javascript" src="../../../../../../script/api.js"></script>
<script type="text/javascript" src="../../../../../../script/plug-in/base64.js" ></script>
<script type="text/javascript" src="../../../../../../script/base_config.js" ></script>
<script type="text/javascript" src="../../../../../../script/common/common.js" ></script>
<script type="text/javascript">
	var BASE_URL_ACTION;
	var type;//判断是添加分组还是编辑分组，1添加，0编辑
	apiready = function(){
		commonSetTheme({"level":5,"type":0});
		BASE_URL_ACTION = $api.getStorage('BASE_URL_ACTION');	
		type = api.pageParam.type;
		if(type){
			$api.text($api.byId('title'), '添加分组');
		}else{
			$api.val($api.byId('fl_val'), Base64.decode(api.pageParam.name_base64));
			showTip(Base64.decode(api.pageParam.name_base64).length,"");
			$api.text($api.byId('title'), '编辑分组');
		}
	};
	/*
	*author:zhaoj
	*function:分组名称最多字数
	*date：20161205
	*/
	function showTip(length,self){
        var count = 10 - length;
        if(count == 10){
        	$api.text($api.byId('tip'),'最多支持输入10个字符');
        }else{
        	$api.text($api.byId('tip'),'剩余'+count+'个字符');
        }
        commonRemoveExpression(self);
    }
    /*
	*author:zhaoj
	*function:添加或编辑学生分组
	*date：20161206
	*/
    function saveGroupName(){
    	if(type){
    		showSelfProgress('添加中...');
    		saveGroup();
    	}else{
    		showSelfProgress('保存中...');
    		updateGroup();
    	}
    }
    /*
	*author:zhaoj
	*function:创建学生分组
	*date：20161206
	*/
	function saveGroup(){
		$api.css($api.byId('j_shadow'),'z-index:3');
		var group_name = $api.trimAll($api.val($api.byId('fl_val')));
		if(group_name.length == 0){
			api.hideProgress();
			popAlert('群组名称不能为空！');
			$api.css($api.byId('j_shadow'),'z-index:-1');
			return;
		}
		api.ajax({
			url : BASE_URL_ACTION + '/ypt/group/saveGroup',
			method : 'post',
			timeout : 30,
			dataType : 'json',
			cache : false,
			data : {
				values : {
					"random_num" : creatRandomNum(),
					"avater_url" : "Li4vLi4vLi4vaW1hZ2VzL2hlYWRfaWNvbi9ncm91cC9kZWZhdWx0LnBuZw==",
					"group_desc" : "",
					"group_name" : group_name,
					"group_type" : 2,
					"parent_id" : -1,
					"parent_type" : 2,
					"plat_id" : 0,
					"plat_type" : 4,
					"use_range" : 1
				}
			},
			headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
		}, function(ret, err) {
			if (err) {
				api.hideProgress();
				popAlert('添加失败，请稍候重试');
				$api.css($api.byId('j_shadow'),'z-index:-1');
			} else {
				if(ret){
					addXxGroup(ret.id);
				}else{
					api.hideProgress();
					popAlert('添加失败，请稍候重试');
					$api.css($api.byId('j_shadow'),'z-index:-1');
				}
			}
		});
	}
	/*
	*author:zhaoj
	*function:创建学生分组
	*date：20161206
	*/
	function addXxGroup(group_id){
		api.ajax({
			url : BASE_URL_ACTION + '/ypt/xx/addXxGroup',
			method : 'post',
			timeout : 30,
			dataType : 'json',
			cache : false,
			data : {
				values : {
					"random_num" : creatRandomNum(),
					"class_id" : api.pageParam.id,
					"group_id" : group_id,
					"person_id" : $api.getStorage("person_id")
				}
			},
			headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
		}, function(ret, err) {
			if (err) {
				popTipInfo(1);
			} else {
				if(ret){
					if(ret.success){
						setTimeout(function(){
							popToast('添加成功');
							commonExecScript('stuGroup_index_window','stuGroup_index_frame','initData();',1);
						},1500);
						setTimeout(function(){
							api.hideProgress();
							commonCloseFrame("stuGroup_group_name_frame");
						},1600);
						
					}else{
						popTipInfo(1);
					}
				}else{
					popTipInfo(1);
				}
			}
		});
	}
	/*
	*author:zhaoj
	*function:编辑学生分组
	*date：20161206
	*/
	function updateGroup(){
		$api.css($api.byId('j_shadow'),'z-index:3');
		var group_name = $api.trimAll($api.val($api.byId('fl_val')));
		if(group_name.length == 0){
			api.hideProgress();
			popAlert('群组名称不能为空！');
			$api.css($api.byId('j_shadow'),'z-index:-1');
			return;
		}
		api.ajax({
			url : BASE_URL_ACTION + '/ypt/group/updateGroup',
			method : 'post',
			timeout : 30,
			dataType : 'json',
			cache : false,
			data : {
				values : {
					"random_num" : creatRandomNum(),
					"avater_url" : -1,
					"group_desc" : "",
					"id" : api.pageParam.id,
					"group_name" : group_name
				}
			},
			headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
		}, function(ret, err) {
			if (err) {
				popTipInfo(0);
			} else {
				if(ret){
					if(ret.success){
						setTimeout(function(){
							popToast('编辑成功');
							commonExecScript('stuGroup_index_window','stuGroup_index_frame','initData();',1);
						},1500);
						setTimeout(function(){
							api.hideProgress();
							commonCloseFrame("stuGroup_group_name_frame");
						},1600);
					}else{
						popTipInfo(0);
					}
				}else{
					popTipInfo(0);
				}
			}
		});
	}
	/*
	*author:zhaoj
	*function:添加和编辑失败的提示消息
	*date：20161206
	*/
	function popTipInfo(type){
		if(type==1){
			popAlert('添加失败，请稍候重试');
		}else if(type==2){
			popAlert('删除失败，请稍候重试');
		}else{
			popAlert('编辑失败，请稍候重试');
		}
		api.hideProgress();
		$api.css($api.byId('j_shadow'),'z-index:-1');
	}
</script>
</html>