<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no" />
    <title>通知</title>
    <link rel="stylesheet" type="text/css" href="../../../../../css/aui/aui.css"/>
    <link rel="stylesheet" type="text/css" href="../../../../../css/module/common/aui-list-swipe.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../css/module/ipad/left-right-layout.css"/>
    <link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
    <style>
    	.tip-image{position:absolute;top:0px;right:0;width:55px;}
    	.aui-list-view:before{height:0;}
    	.aui-user-view-cell{padding:0;}
    	.aui-user-view-cell:after {height:0;}
    	.aui-user-view-cell:last-child:after {background-color: #c8c7cc;}
    	.aui-list-view::after{height:0;}
    	.aui-list-view .aui-img-object{width:60px;}
    	.red{color:#ff0000 !important;}
    	.left-layout-body .thumb-content ul li{padding-left:0;}
    	.aui-swipe-div{padding-left: 185px;min-height: 146px;}
    	.pr35{padding-right:35px;}
    </style>
</head>
<body class="left-layout-body common-ipad-noticeIpad-tea">
	<div id="j_top" style="height:0px; overflow:hidden"></div>
	<div id="j_box_shadow" class="box-shadow aui-hide"></div>
	<div class="thumb-content clearfix">
	<section class="aui-content" id="banner">
		<ul id="tz_body" class="aui-list-view">
			
		</ul>
		<script type="text/html" id="tz_script">
			<% if(list.length == 0){ %>
				<div class="no-data"><span>暂无通知公告</span></div>
			<% }else{ %>
				<%for(var i=0; i<list.length; i++) {%>
					<li class="aui-user-view-cell" tapmode onclick="showMsg(this,<%=list[i].notice_id%>,'<%=list[i].flag%>');">
		            	<div class="aui-swipe-div <%if(is_xxgly){%>aui-swipe-handle<%}%>">
			                <img class="thumb-img" onerror="this.src='../../../../../image/fun-module/common/bjtz.png'"  src="<%=list[i].img_src%>" />
			                <div class="title pr35 pt20">
								<span class="ellipsis">
									
									&nbsp;<%=#list[i].update_text%><%if(list[i].flag != -1){%><%=#list[i].flag%>&nbsp;&nbsp;<%}%><%=list[i].notice_title%>&nbsp;
									
								</span>
							</div>
							<div class="detail-infor mt20">
								<div class="person-name ellipsis"><%=list[i].person_name%></div>
								<div class="time pt5"><%=list[i].create_time%></div>
							</div>
			                <img class="tip-image" src="../../../../../image/fun-module/iphone/notice/<%=list[i].level%>.png" />
		                </div>
		                <%if(list[i].send_status*1 == 0){%>
		                  <div class="aui-swipe-right-btn aui-bg-danger" type="3" noticeID=<%=list[i].notice_id%> noticePublic=<%=list[i].notice_public%> tapmode onclick="rightBtn(this);">删除</div>
		                  <div class="aui-swipe-right-btn aui-bg-warning" type="2" noticeID=<%=list[i].notice_id%> noticePublic=<%=list[i].notice_public%> tapmode onclick="rightBtn(this);">编辑</div>
		                  <div class="aui-swipe-right-btn aui-bg-blue" type="1" noticeID=<%=list[i].notice_id%> noticePublic=<%=list[i].notice_public%> tapmode onclick="rightBtn(this);">发布</div>
		                <%}else{%>
		                  <div class="aui-swipe-right-btn aui-bg-pink" type="4" noticeID=<%=list[i].notice_id%> noticePublic=<%=list[i].notice_public%> tapmode onclick="rightBtn(this);">撤销</div>
		                <%}%>
		            </li>
				<% } %>
			<% } %>
		</script>
	</section>
	</div>
</body>
<script type="text/javascript" src="../../../../../script/api.js"></script>
<script type="text/javascript" src="../../../../../script/plug-in/aui-list-swipe.js"></script>
<script type="text/javascript" src="../../../../../script/base_config.js" ></script>
<script type="text/javascript" src="../../../../../script/plug-in/template.js" ></script>
<script type="text/javascript" src="../../../../../script/plug-in/base64.js" ></script>
<script type="text/javascript" src="../../../../../script/common/common.js"></script>
<script type="text/javascript">
	var BASE_URL_ACTION;
	var header_h;//顶部header高度
	var is_xxgly;//是否为学校管理员，0代表不是，1代表是
	var levelArray = [0,1,2,3];//日程类型参数数组
	var currentPage = 1;//第几页
	var totalPage = 1;//总页数
	var levelValue = 0;//类型 0代表全部
	var swipe;
	var type = 1;
	var n_id;
	apiready = function(){
		commonSetTheme({"level":5,"type":0});
		header_h = api.pageParam.header_h;
		is_xxgly = api.pageParam.is_xxgly;
		BASE_URL_ACTION = $api.getStorage('BASE_URL_ACTION');
//		openNavigationBar();
		changeLevelType(levelValue);  //默认获取全部通知
		refreshDataInfo();//下拉刷新
		scrollBottomReload();//上拉刷新
		
	};
	function showMsg(el,notice_id,flag){
		if(!el.classList.contains("aui-swipe-selected")){
			openContentWindow(notice_id,flag,el);
		}
	}
	function rightBtn(obj){
		var type = obj.getAttribute('type')*1;
		var noticeID = obj.getAttribute('noticeID')*1;
		var noticePublic = obj.getAttribute('noticePublic')*1;
		switch(type){
		    case 1://发布
		      commonExecScript(api.winName,'','openAddFrame("'+noticeID+'",'+noticePublic+',0,1)',0);
		      break;
		    case 2://编辑
		      openEditWindow(noticeID,noticePublic)
		      break;
		    case 3://删除
		      delNotice(noticeID);
		      break;
		    case 4://撤销
		      kjCancelNotice(noticeID)
		      break;
		}
	}
	
	/*
     * 功能：撤销通知
     * 作者：张自强
     * 时间：20180730
     */
    function kjCancelNotice(noticeID){
       api.ajax({
            url : BASE_URL_ACTION + '/new_notice/kjCancelNotice',
            method : 'post',
            timeout : 0,
            dataType : 'json',
            data : {
                values : {
                    'notice_id' : noticeID
                }
            },
            headers : {
    'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
    }
            }, function(ret, err) {
                if (err) {
                    popToast('撤销失败');
                } else {
                    if(ret.success){
                        changeLevelType(levelValue);
                        popToast('撤销成功');
                    }else{
                       popToast('撤销失败');
                    }
                }
        });
    }
	
	/*
	*author:zhaoj
	*function:打开选择权限的window页面
	*date：20160625
	*/
	function openContentWindow(notice_id,flag,self){
			setLiCss(self);
			commonCloseFrame('noticeIpad_content_frame');
			var param={
				notice_id:notice_id,
				flag:flag,
				is_xxgly:is_xxgly
			}
			var oparam=Base64.encode(JSON.stringify(param))
			commonExecScript('noticeIpad_index_window','','openDetailFrame("'+oparam+'");',0);
	}
	
	/*
	*author:zfz
	*function:设置选中样式
	*date：20171013
	*/
	function setLiCss(self){
		var li_array = $api.domAll($api.byId('tz_body'), 'li');
		for(var i = 0; i < li_array.length; i++){
			$api.removeCls(li_array[i], 'active');
		}
		$api.addCls(self, 'active');
	}
	/*
	*author:zhaoj
	*function:打开选择权限的window页面
	*date：20160625
	*/
	function openEditWindow(notice_id,notice_public){
        commonExecScript('noticeIpad_index_window','','openAddFrame("'+notice_id+'",'+notice_public+',1,1)',0);
	}
	/*
	 *author:zhaoj
	 *function:初始化右滑按钮的点击事件
	 *date：20160625
	 */
	function initSwipe(){
		$('.aui-swipe-right-btn').each(function () {
	       $(this).tap(function(event) {
	            var type = $(this).attr('type')*1;
				var noticeID = $(this).attr('noticeID')*1;
				var noticePublic = obj.getAttribute('noticePublic')*1;
				switch(type){
                    case 1://发布
                      commonExecScript(api.winName,'','openAddFrame("'+notice_id+'",'+notice_public+',0,1)',0);
                      break;
                    case 2://编辑
                      openEditWindow(noticeID,noticePublic)
                      break;
                    case 3://删除
                      delNotice(noticeID);
                      break;
                    case 4://撤销
                      kjCancelNotice(noticeID)
                      break;
                }
	        });
	    });
	}
	/*
	 *author:zhaoj
	 *function:更改type值
	 *date：20160702
	 */
	function changeType(num){
		if(num == 1){
			type = 1;
		}else{
			type = 2;
		}
		changeLevelType(levelValue);
		//openNavigationBar();
	}
	/*
	*author:zhaoj
	*function:打开通知类型滑动
	*date：20160625
	*/
	function openNavigationBar() {
	
	commonCloseNavigationBar();
		closeNav();
		var bar_items = [
			{
				title : '全部',
				titleSelected : '全部',
				bg : "#ffffff",
				alpha : 0.8,
				bgSelected : "#ffffff"
			},
			{
				title : '日常',
				titleSelected : '日常',
				bg : "#ffffff",
				alpha : 0.8,
				bgSelected : "#ffffff"
			},
			{
				title : '紧急',
				titleSelected : '紧急',
				bg : "#ffffff",
				alpha : 0.8,
				bgSelected : "#ffffff"
			}
			,
			{
				title : '重要',
				titleSelected : '重要',
				bg : "#ffffff",
				alpha : 0.8,
				bgSelected : "#ffffff"
			},
			
		];
		var itemWidth = Math.floor(api.frameWidth/4);
		
		var params = {
				y : header_h +1,
				items : bar_items,
				winName : 'noticeIpad_index_window',
				frameName : 'noticeIpad_index_frame',
				itemSize : {
			          w : Math.floor(api.frameWidth/4)
			          }
				};
				commonMyNavigationBar(params);
	}

	function callBackNew(id, index) {
		var bar_index = 0;
		bar_index = index;
		n_id = id;
		levelValue = levelArray[bar_index];
		$api.setStorage('notice_level_id',levelValue);
		currentPage = 1;
		getNoticeList(1,1,levelArray[bar_index],'',function(data){
			dealData(data,function(flag){
				api.parseTapmode();
				// 初始化
				swipe = new ListSwipe();
				//initSwipe();
			});
		})
		
	}
	
	/*
	*author:zhaoj
	*function:获取通知的列表数据
	*date：20160627
	*/
	function changeLevelType(levelVal){
		levelValue = levelVal;
		commonCloseFrame('noticeIpad_content_frame');
		$api.setStorage('notice_level_id',levelValue);
		getNoticeList(1,1,levelValue,'',function(data){
			dealData(data,function(flag){
				api.parseTapmode();
				// 初始化
				swipe = new ListSwipe();
			});
		})
	}
	
	
	/*
	*author:zhaoj
	*function:获取通知的列表数据
	*date：20160627
	*/
	function getNoticeList(is_show,current_page,level,page_size,callback){
		if(is_show){showSelfProgress('加载中...');}
		if(page_size != ''){
			pageSize = page_size;
		}else{
			pageSize = BASE_PAGE_SIZE;
		}
		var src_url;
		if(is_xxgly){
//			src_url = BASE_URL_ACTION + '/new_notice/getManageSendNoticeList?person_id='+$api.getStorage("person_id")+'&type='+type+'&level='+level+'&pageNumber='+current_page+'&pageSize='+pageSize+'&bureau_id='+$api.getStorage('bureau_id')+'&random_num='+creatRandomNum();
            src_url = BASE_URL_ACTION + '/new_notice/kjGetSendNoticeList?person_id='+$api.getStorage("person_id")+'&level='+level+'&pageNumber='+current_page+'&pageSize='+pageSize+'&bureau_id='+$api.getStorage('bureau_id')+'&random_num='+creatRandomNum();
		}else{
			src_url = BASE_URL_ACTION + '/new_notice/kjGetMyNoticeList?person_id='+$api.getStorage("person_id")+'&level='+level+'&bureau_id='+$api.getStorage('bureau_id')+'&pageNumber='+current_page+'&pageSize='+pageSize+'&random_num='+creatRandomNum();
		}
		api.ajax({
			url : src_url,
			method : 'get',
			timeout : 0,
			dataType : 'json',
			headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
			}, function(ret, err) {
			
				api.hideProgress();
				var data={"list": []};
				if (err) {
					callback(data,true);
				} else {
					if(ret.success){
						totalPage = ret.totalPage;
						callback(ret,true);
					}else{
						callback(data,true);
					}
				}
				//通知顶部下拉刷新数据加载完毕，组件会恢复到默认状态
				commonControlRefresh();
		});
	}
	/*
	*author:zhaoj
	*function:处理数据
	*date：20160627
	*/
	function dealData(data,callback){
		data.is_xxgly = is_xxgly;
		for(var i = 0; i < data.list.length; i++){
			data.list[i].create_time = data.list[i].create_time.substring(0,16);
			switch(data.list[i].level_name){
				case "日常":
					data.list[i].level = 1;
					break;
				case "紧急":
					data.list[i].level = 2;
					break;
				case "重要":
					data.list[i].level = 3;
					break;
				default:
					break;
			}
			if(data.list[i].thumb_id == "default.png"){
				data.list[i].img_src = "../../../../../image/fun-module/common/bjtz.png";
			}else{
				var img_url;
				if (BASE_APP_TYPE == 1) {
					img_url = BASE_IMAGE_PRE+"down/Material/" + data.list[i].thumb_id.substring(0, 2) + "/" + data.list[i].thumb_id +  commonReturnPhotoCutSize(0);
				} else {
					img_url = BASE_URL_ACTION + "/html/thumb/Material/" + data.list[i].thumb_id.substring(0, 2) + "/" + data.list[i].thumb_id + commonReturnPhotoCutSize(0);
				}
				data.list[i].img_src = img_url;
			}
			if(data.list[i].flag=='[未签]' || data.list[i].flag=='[未阅]'){
				data.list[i].flag='<span class="red">'+data.list[i].flag+'</span>';
			}
			if(data.list[i].is_update == 1){
				data.list[i].update_text='<span class="red">[已改]</span>';
			}else{
				data.list[i].update_text='';
			}
		}
		addTemplateHtml('tz_body', 'tz_script', data);
		callback(true);
	}
	/*
	 *author:zhaoj
	 *function:渲染html
	 *date：20160627
	 */
	function addTemplateHtml(div_id, script_id, data){
		var html_type = template.render(script_id, data);
		if (currentPage == 1) {
			document.getElementById(div_id).innerHTML = html_type;
		} else {
			$api.append($api.byId(div_id), html_type);
		}
	}
	/*
	*author:zhaoj
	*function:打开加载数据的提示框
	*date：20160627
	*/
	function showSelfProgress(msg){
		api.showProgress({
			title : msg,
			text : '请稍候...',
			modal : false
		});
	}
	/**
	 * 下拉刷新
	 * 周枫
	 * 2016.2.29
	 */
	function refreshDataInfo() {
		//绑定下拉刷新历史会话事件
		api.setRefreshHeaderInfo({
			visible : true,
			loadingImg : 'widget://image/local_icon_refresh.png',
			bgColor : '#F0F0F0',
			textColor : '#8E8E8E',
			textDown : '下拉加载更多...',
			textUp : '松开加载...',
			showTime : true
		}, function(ret, err) {
			//从服务器加载数据，完成后调用commonControlRefresh()方法恢复组件到默认状态
			//调用获取历史会话监听
			//打开滑动条
				currentPage = 1;
				getNoticeList(1,1,levelValue,'',function(data){
					dealData(data,function(flag){
						api.parseTapmode();
						// 初始化
						swipe = new ListSwipe();
						//initSwipe();
					})
				});
			});
	}
	
	/*
	 * 
	 */
	function initData(){
	    currentPage = 1;
        getNoticeList(1,1,levelValue,'',function(data){
            dealData(data,function(flag){
                api.parseTapmode();
                // 初始化
                swipe = new ListSwipe();
                //initSwipe();
            })
        });
	}
	/**
	 * 上拉刷新页面数据
	 * 周枫
	 * 2015.11.24
	 */
	function scrollBottomReload() {
		//下移到底部：
		api.addEventListener({
			name : 'scrolltobottom',
			extra : {
				threshold : 100 //设置距离底部多少距离时触发，默认值为0，数字类型
			}
		}, function(ret, err) {
			if ((currentPage + 1) <= totalPage) {
				currentPage = currentPage + 1;
				getNoticeList(1,currentPage,levelValue,'',function(data){
					dealData(data,function(flag){
						api.parseTapmode();
						// 初始化
						swipe = new ListSwipe();
						//initSwipe();
					});
				});
				// 页码+1
			} else {
				api.toast({
					msg : '已经为您加载完全部通知公告',
					location : 'bottom'
				});
			}
		});
	}
	/*
	 *author:zhaoj
	 *function:删除通知
	 *date：20160629
	 */
	function delNotice(notice_id){
		api.showProgress({
			title : '删除中...',
			text : '请稍候...',
			modal : true
		});
		api.ajax({
			url : BASE_URL_ACTION + '/new_notice/delNotice?notice_id='+notice_id,
			method : 'get',
			timeout : 0,
			dataType : 'json',
			headers : {
	'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
	}
			}, function(ret, err) {
				api.hideProgress();
				if (err) {
					popToast('删除失败');
				} else {
					if(ret.success){
						popToast('删除成功');
						var page_size = currentPage*BASE_PAGE_SIZE;
						currentPage = 1;
						getNoticeList(0,1,levelValue,page_size,function(data){
							dealData(data,function(flag){
								api.parseTapmode();
								// 初始化
								swipe = new ListSwipe();
								//initSwipe();
							});
						});
					}else{
						popToast('删除失败');
					}
				}
		});
	}
	/*
	*作者:zhaoj
	*功能:关闭滑动条
	*日期：20160913
	*/
	function closeNav(){
        commonCloseNavigationBar();
    }
    
    /*
	*author:zfz
	*function:是否显示虚线
	*date：20171013
	*/
	function isShowBoxShow(type){
		type ? $api.removeCls($api.byId('j_box_shadow'), 'aui-hide') : $api.addCls($api.byId('j_box_shadow'), 'aui-hide');
	}
</script>
</html>