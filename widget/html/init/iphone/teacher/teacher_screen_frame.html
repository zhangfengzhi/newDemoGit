<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>筛选</title>
    <link rel="stylesheet" type="text/css" href="../../../../css/aui_css_new/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../../../css/module/iphone/init-screen.css" />
	<link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
    <style  type="text/css">
		body{
			width:100%;
			height:auto;
			font-size: 18px;
		}
		.radio-parent{
			width:100%;
			padding-bottom: 50px;
		}
		.ok-button{
			width:100%;
			height:50px;
			text-align: center;
			margin:0px;
			background: #34A8FA;
			line-height: 30px;
			font-size: 18px;
			line-height: 50px;
			color: #FFFFFF;
			position: fixed;
			bottom: 0px;
			z-index:999;
		}
		#group_div,#class_div{
			padding-top: 10px;
			padding-left: 30px;
			line-height: 18px;
		}
		
		.checkbox_div{
			/*display: inline-block;*/
			padding: 5px;
		}
		.btn-disabled{
			background: #bdbdbd;
			pointer-events: none;
		}
		.radio-parent label{
			margin-left: 5px;
			line-height: 1.2rem;
		}
		
		.li-div{
    		line-height: 30px;
			font-family: "Microsoft YaHei";
			border-bottom: 1px solid #CCCCCC;
		}
		
		.icon-img{
			width: 30px;
			height: 30px;
			/*margin-right: 5px;*/
		}
		
		.myself-img{
			background:#FFFFFF url(../../../../image/quanzi/screen/iphone/myself.png) center center no-repeat;background-size:100% auto;
		}
		.city-img{
			background:#FFFFFF url(../../../../image/quanzi/screen/iphone/city.png) center center no-repeat;background-size:100% auto;
		}
		.school-img{
			background:#FFFFFF url(../../../../image/quanzi/screen/iphone/school.png) center center no-repeat;background-size:100% auto;
		}
		.class-img{
			background:#FFFFFF url(../../../../image/quanzi/screen/iphone/class.png) center center no-repeat;background-size:100% auto;
		}
		.group-img{
			background:#FFFFFF url(../../../../image/quanzi/screen/iphone/group.png) center center no-repeat;background-size:100% auto;
		}
			
		.teacher-img{
			width: 35%;
			height: 30px;
			display: inline-block;
			margin: 10px 4% 0px 10%;
			background:#FFFFFF url(../../../../image/quanzi/screen/iphone/teacher-unSelect.png) center center no-repeat;background-size:100% auto;
		}
		.student-img{
			width: 35%;
			height: 30px;
			display: inline-block;
			margin: 10px 10% 0px 4%;
			background:#FFFFFF url(../../../../image/quanzi/screen/iphone/student-unSelect.png) center center no-repeat;background-size:100% auto;
		}
		.teacherAndStudent{
			white-space: nowrap;
			padding: 5px 0px;
		}
		.area-radio{
			top: 4px;
		}
		.title-div{
			margin: 10px 20px;
		}
		.title-div label{
			margin-left: 10px;
		}
		.list-div{
			background-color: #F0EFF5;
			border-top: 1px solid #CCCCCC; 
			display: none;
		}
    </style>
</head>
<body>
	<div id="root-div" class="aui-hide">
		<div class="radio-parent">
			<ul>
				<li  class="li-div">
					<div class="title-div">
						<div class="icon-img myself-img aui-pull-left"></div>
						<label for="seeMySelf">只看自己</label>
						<input id="seeMySelf" class="area-radio aui-radio aui-pull-right" type="radio" name="demo" onchange="partChange(true)">
					</div>
				</li>
				<li id="province_li" class="li-div">
					<div class="title-div">
						<label for="seeProvince">查看全省</label>
						<div class="icon-img city-img aui-pull-left"></div>
						<input id="seeProvince" class="area-radio aui-radio aui-pull-right" type="radio" name="demo" onchange="partChange(true)">
					</div>
				</li>
				<li id="city_li" class="li-div">
					<div class="title-div">
						<label for="seeCity">查看全市</label>
						<div class="icon-img city-img aui-pull-left"></div>
						<input id="seeCity" class="area-radio aui-radio aui-pull-right" type="radio" name="demo" onchange="partChange(true)">
					</div>
				</li>
				<li id="district_li" class="li-div">
					<div class="title-div">
						<label for="seeDistrict">查看全区</label>
						<div class="icon-img city-img aui-pull-left"></div>
						<input id="seeDistrict" class="area-radio aui-radio aui-pull-right" type="radio" name="demo" onchange="partChange(true)">
					</div>
				</li>
				<li id="school_li_div" class="li-div">
					<div class="title-div">
						<label for="seeSchool">查看全校</label>
						<div class="icon-img school-img aui-pull-left"></div>
						<input id="seeSchool" class="area-radio aui-radio aui-pull-right" type="radio" name="demo" onchange="partChange(true)">
					</div>
					<div class="teacherAndStudent">
						<div class="teacher-img" isSelect = "false" onclick="identityChange(0,this,'teacher')"></div>
						<div class="student-img"  isSelect = "false"  onclick="identityChange(0,this,'student')"></div>
					</div>
				</li>
				<li  id="class_li_div" class="li-div">
					<div class="title-div">
						<label for="seeClass">查看班级</label>
						<div class="icon-img class-img aui-pull-left"></div>
						<input id="seeClass" class="area-radio aui-radio aui-pull-right" type="radio" name="demo" onchange="partChange(true)">
					</div>
					<div id="class-list" class="list-div">
						<div id="class_div">
							<script id="class_script" type="text/html">
								<%if (list.length > 0){%>
									<%for(var i = 0; i < list.length; i++){%>
										<div class="checkbox_div">
											<input id="class + <%=i%>" class="aui-radio" type="radio" name="classCheckbox" onchange="classSelectChange(this)">
											<label for="class + <%=i%>"><%=list[i].class_name%></label>
										</div>
									<%}%>
								<%}else{%>
									<div style="padding-bottom: 10px;">暂无班级</div>
								<%}%>
							</script>
						</div>
						
						<div class="teacherAndStudent">
							<div class="teacher-img" isSelect = "false" onclick="identityChange(1,this,'teacher')"></div>
							<div class="student-img"  isSelect = "false"  onclick="identityChange(1,this,'student')"></div>
						</div>
					</div>
				</li>
				<li  class="li-div">
					<div class="title-div">
						<label for="seeGroup">查看群组</label>
						<div class="icon-img group-img aui-pull-left"></div>
						<input id="seeGroup" class="area-radio aui-radio aui-pull-right" type="radio" name="demo" onchange="partChange(true)">
					</div>
					<div id="group-list" class="list-div">
						<div id="group_div">
							<script id="group_script" type="text/html">
								<%if (list.length > 0){%>
									<%for(var i = 0; i < list.length; i++){%>
										<div class="checkbox_div">
											<input id="group + <%=i%>" class="aui-radio" type="radio" name="groupCheckbox" onchange="groupSelectChange(this)">
											<label for="group + <%=i%>"><%=list[i].group_name%></label>
										</div>
									<%}%>
								<%}else{%>
									<div style="padding-bottom: 10px">暂无群组</div>
								<%}%>
							</script>
						</div>
					</div>
				</li>
			</ul>
		</div>
		<div id="ok_btn"  class="ok-button" name="btn" onclick="getData();">
			确定
		</div>
	</div>
</body>
<script type="text/javascript" src="../../../../script/api.js"></script>
<script type="text/javascript" src="../../../../script/base_config.js" ></script>
<script type="text/javascript" src="../../../../script/plug-in/template.js" ></script>
<script type="text/javascript" src="../../../../script/common/init_common.js"></script>
<script type="text/javascript" src="../../../../script/common/common.js"></script>
<script type="text/javascript" src="../../../../script/plug-in/base64.js" ></script>
<script type="text/javascript">
	var currentPage = 1;//当前分页数
	var teacherImg;//教师复选数组
	var studentImg;//学生复选数组
	var radio = document.getElementsByName('demo');
	var okBtn = $api.byId('ok_btn');
	var classDiv = $api.byId('class-list');//班级div
	var groupDiv = $api.byId('group-list');//群组div
	var identityAry;//教师学生
	var	org_id;
	var org_type = 1;
	var keyword = '';
	var classList;//班级列表
	var groupList;//群组列表
	var orgAry = [];
	var identityIdAry = [];
	var partIndex = 0;
	var classAry;//班级选择框数组
	var groupAry;//班级选择框数组
	var isJuDuan = false;
	var org_level = $api.getStorage('org_level');
	apiready = function(){
		api.showProgress({
			title : '加载中',
			text : '请稍候...',
			modal : true
		});
		
		if ($api.getStorage("idy_type") == "work"){
			isJuDuan = true;
		}
		
		if (org_level == 102){
			$api.addCls($api.byId("province_li"), "aui-hide");
		}else if (org_level == 103){
			$api.addCls($api.byId("province_li"), "aui-hide");
			$api.addCls($api.byId("city_li"), "aui-hide");
		}
		
		if (isJuDuan){
			get_group_bypersonid();
			$api.addCls($api.byId("school_li_div"), "aui-hide");
			$api.addCls($api.byId("class_li_div"), "aui-hide");
		}else{
			getClass(); 
		}
		api.parseTapmode();
	};
	
	function initData(){
		if (org_level <= 101){
			radio[1].checked = true;
		}else if (org_level <= 102){
			radio[2].checked = true;
		}else if (org_level <= 103){
			radio[3].checked = true;
		}
		
		setSelTeaAndStu();
		
		identityIdAry.push(5);
		if (classAry.length > 0){
			classAry[0].checked = true;
		}
		
		if (groupAry.length > 0){
			groupAry[0].checked = true;
		}
	}
	
	function classSelectChange(self){
		var isHaveSelect = false;
		for (var i = 0; i < classAry.length; i++){
			if (classAry[i].checked){
				isHaveSelect = true;
				break;
			}
		}
		
		if (!isHaveSelect){
			self.checked = true;
			popToast('应至少选中一个班级！');
		}
	}
	
	function setSelTeaAndStu(){
		for (var i = 0; i < teacherImg.length; i++){
			teacherImg[i].setAttribute('isSelect','true');
			$api.css(teacherImg[i],'background-image: url(../../../../image/quanzi/screen/iphone/teacher-select.png)');
			studentImg[i].setAttribute('isSelect','true');
			$api.css(studentImg[i],'background-image: url(../../../../image/quanzi/screen/iphone/student-select.png)');
		}
	}
	
	function groupSelectChange(self){
		var isHaveSelect = false;
		for (var i = 0; i < groupAry.length; i++){
			if (groupAry[i].checked){
				isHaveSelect = true;
				break;
			}
		}
		
		if (!isHaveSelect){
			self.checked = true;
			popToast('应至少选中一个群组！');
		}
	}
	
	function identityChange(index,self,type){
    	if (index >=0 && index < teacherImg.length){
    		var isSelect = self.getAttribute('isSelect');
			if (isSelect == 'true'){
				isSelect = 'false'
				$api.css(self,'background-image: url(../../../../image/quanzi/screen/iphone/'+ type +'-unSelect.png)');
			}else if (isSelect == 'false'){
				isSelect = 'true';
				$api.css(self,'background-image: url(../../../../image/quanzi/screen/iphone/'+ type +'-select.png)');
			}
			
			self.setAttribute('isSelect',isSelect);
    		if (teacherImg[index].getAttribute('isSelect') == 'false' && studentImg[index].getAttribute('isSelect') == 'false'){
				self.setAttribute('isSelect','true');
				$api.css(self,'background-image: url(../../../../image/quanzi/screen/iphone/'+ type +'-select.png)');
				popToast('教师与学生至少选中一个！');
			}
		
			getSelectIdentityData(index);
    	}
	}
	
	/**
	 *获取班级
	 * 王俭
	 * 2018.4.20
	 * [{"class_name":"初中一班","class_id":862}] 
	 */
	function getClass(){
		loadClassListData(function(is_true, class_list_arr){
				if(is_true) {
					var ret = {'list':class_list_arr};
					classList = class_list_arr;
					commonAddManyHtml('class_div','class_script',ret);
					get_group_bypersonid();
				} else {
					popToast('获取班级信息失败，请稍候重试');
                    api.hideProgress();
        			commonExecScript("init_screen_window","","back()",0);
				}
			});
	}

	/**
	 *获取群组
	 * 王俭
	 * 2018.4.20
	 * {"list":[{"group_id":900000020,"category_s":[[{"id":2686,"org_person_id":900000020,"business_iid":106,"level":1,"person_name":null,"article_num":0,"sequence":1,"identity_id":106,"name":"默认分类","business_id":900000020,"is_del":0,"business_type":2}]],"group_name":"123"}]}
	 */

	function get_group_bypersonid(){
    	api.ajax({
	    	url : BASE_URL_ACTION+'/blog_expand/get_group_bypersonid?random_num='+creatRandomNum()+'&person_id='+$api.getStorage("person_id")+'&identity_id='+$api.getStorage("identity"),
			method : 'get',
			timeout : 30,
			dataType : 'json',
			headers : {
				'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
			}
        },function(ret,err){
        	if(err){
        		popToast('获取群组信息失败，请稍候重试');
        		api.hideProgress();
        		commonExecScript("init_screen_window","","back()",0);
        	}else{
        		groupList = ret.list;
        		commonAddManyHtml('group_div','group_script',ret);
        		classAry = document.getElementsByName('classCheckbox');
        		groupAry = document.getElementsByName('groupCheckbox');
        		identityAry = document.getElementsByClassName('teacherAndStudent');
        		teacherImg = document.getElementsByClassName('teacher-img');
				studentImg = document.getElementsByClassName('student-img');
        		var screenSetData = $api.getStorage('screenSetData');
        		if (screenSetData){
        			setData();
        		}else{
        			initData();
        		}
        		
				partChange();
				api.hideProgress();
				$api.removeCls($api.byId('root-div'), 'aui-hide');
			}
        });
    }
    
    /**
     * 切换区域选择
     * 王俭
     * 2018.5.14 
     */
    function partChange(isAllSel){
    	if (radio[0].checked){//自己
    		classDiv.style.display = 'none';
    		groupDiv.style.display = 'none';
    		setTeacherOrStudentShow(-1);
    		org_type = 1;
    		partIndex = 0;
    	}
    	else if (radio[1].checked || radio[2].checked || radio[3].checked){//区
    		setTeacherOrStudentShow(-1);
    		classDiv.style.display = 'none';
    		groupDiv.style.display = 'none';
    		identityIdAry.splice(0,identityIdAry.length);
    		identityIdAry.push(5);
    		if (radio[1].checked){
    			org_type = 101;
    			partIndex = 1;
    			org_id = $api.getStorage('province_id');
			}else if (radio[2].checked){
				partIndex = 2;
				org_type = 102;
				org_id = $api.getStorage('city_id');
			}else if (radio[3].checked){
				partIndex = 3;
				org_type = 103;
				org_id = $api.getStorage('district_id');
			}
    	}
    	else if (radio[4].checked){//学校
    		isAllSel?setSelTeaAndStu():"";
    		classDiv.style.display = 'none';
    		groupDiv.style.display = 'none';
    		setTeacherOrStudentShow(0);
    		org_type = 104;
    		org_id = $api.getStorage('school_id');
    		partIndex = 4;
    	}
    	else if (radio[5].checked){//班级
    		isAllSel?setSelTeaAndStu():"";
    		classDiv.style.display = 'block';
    		groupDiv.style.display = 'none';
    		setTeacherOrStudentShow(1);
    		org_type = 105;
    		partIndex = 5;
    	}
    	else if (radio[6].checked){//群组
    		classDiv.style.display = 'none';
    		groupDiv.style.display = 'block';
    		setTeacherOrStudentShow(-1);
    		org_type = 106;
    		partIndex = 6;
    	}
    }
    
    /**
     * 设置教师或学生是否显示
     * 王俭
     * 2018.5.14 
     */
    function setTeacherOrStudentShow(index){
    	for (var i = 0; i < identityAry.length; i++){
    		if (i == index){
    			identityAry[i].style.display = 'block';
    		}else{
    			identityAry[i].style.display = 'none';
    		}
    	}
    }
    
    /**
     * 获取人员选择
     * 王俭
     * 2018.5.14 
     */
    function getSelectIdentityData(index){
    	identityIdAry.splice(0,identityIdAry.length);
		if (teacherImg[index].getAttribute('isSelect') == 'true'){
			identityIdAry.push(5);
		}
		
		if (studentImg[index].getAttribute('isSelect') == 'true') {
			identityIdAry.push(6);
		}
    }
    
    /**
     * 获取筛选选择数据
     */
    function getData(){
    	orgAry.splice(0,orgAry.length);
    	if (radio[0].checked){
    		identityIdAry.slice(0,identityIdAry.length);
    	}else if(radio[1].checked || radio[2].checked || radio[3].checked){
    		identityIdAry.splice(0,identityIdAry.length);
    		identityIdAry.push(5);
    		if (!isJuDuan){
    			identityIdAry.push(6);
    		}
    	}else if(radio[4].checked){
    		getSelectIdentityData(0);
    	}else if (radio[5].checked){
    		if (classAry.length > 0){
    			getSelectIdentityData(1);
		    	for (var i = 0; i < classAry.length; i++){
		    		if (classAry[i].checked){
		    			orgAry.push(classList[i].class_id);
		    		}
	    		}
    		}else{
    			popToast("当前无班级信息，请切换筛选范围！");
    			return;
    		}
    		
    	}else if (radio[6].checked){
    		if (groupAry.length > 0){
    			for (var i = 0; i < groupAry.length; i++){
		    		if (groupAry[i].checked){
		    			orgAry.push(groupList[i].group_id);
		    		}
	    		}
    		}else{
    			popToast("当前无群组信息，请切换筛选范围！");
    			return;
    		}
    		identityIdAry.slice(0,identityIdAry.length);
    	}
    	
    	var url = getUrl();
    	saveSetData();
    	commonExecScript("init_screen_window","","back()",0);
    	if (isJuDuan){
    		commonExecScript("quanzi_index_window","quanzi_index_frame",'initData(1,"' + url + '")',1);
    	}else{
        	commonExecScript("root","center_index",'initData(1,"' + url + '")',1);
    	}
    }
    
    function getUrl(){
    	var list_url;
		if(org_type == 0 ||org_type == 101 || org_type == 102|| org_type == 103){
			list_url = BASE_URL_ACTION + '/blog/orgArticleList?';
		}else if(org_type == 105 || org_type == 106){
			//班级
			list_url = BASE_URL_ACTION + '/blog_expand/list_article_expand?';
		}else if(org_type == 104){
			//学校圈子
			list_url = BASE_URL_ACTION + '/blog/orgArticleList?';
		}else{
			list_url = BASE_URL_ACTION + '/blog/search?';
		}
		//查询类型（title，content）
		var tempUrl = list_url + 'search_type=title&pagesize=' + BASE_PAGE_SIZE +  '&random_num='
		 + creatRandomNum();
		list_url = tempUrl + "&identity_id=" + identityIdAry;
		if(org_type == 1){
		//我的圈子
			list_url = tempUrl + '&person_id=' + $api.getStorage('person_id')+ '&business_type=1' + '&identity_id='
			 + $api.getStorage('identity');
		}else if(org_type == 101 || org_type == 102|| org_type == 103){
			//机构圈子
			list_url = list_url + '&org_id=' + org_id + '&org_type=' + org_type + '&business_type=7';
		}else if(org_type == 105){//班级
			list_url = list_url + '&business_id=' + orgAry + '&business_type=3' + '&business_iid=' + org_type;
		}else if(org_type == 104){
			//学校圈子
			list_url = list_url +'&org_id=' + org_id + '&org_type=' + org_type + '&business_type=7';
		}else if(org_type == 106){
			list_url = tempUrl + '&business_type=2' + '&business_id=' + orgAry + '&business_iid=' + org_type;
		}
		
		return list_url;
	}
	
	/**
	 * 保存数据 
	 */
	function saveSetData(){
		var data = {
			'partIndex':partIndex,
			'orgAry':orgAry,
			'identityIdAry':identityIdAry,
			'org_type':org_type
		};
		
		$api.setStorage('screenSetData',data);
	}
	
	/**
	 * 还原数据 
	 */
	function setData(){
		if (classAry.length > 0){
			classAry[0].checked = true;
		}
		
		if (groupAry.length > 0){
			groupAry[0].checked = true;
		}
		var setData = $api.getStorage('screenSetData');
		var isSelect = false;
		var i = 0;
		var j = 0;
		if (setData){
			radio[setData.partIndex].checked = true;
			if (setData.partIndex == 5){
				for (i = 0; i < classList.length; i++){
					isSelect = false;
					for (j = 0; j < setData.orgAry.length; j++){
						if (setData.orgAry[j] == classList[i].class_id){
							isSelect = true;
							break;
						}
					}
					
					classAry[i].checked = isSelect;
				} 
			}else if (setData.partIndex == 6){
				for (i = 0; i < groupList.length; i++){
					isSelect = false;
					for (j = 0; j < setData.orgAry.length; j++){
						if (setData.orgAry[j] == groupList[i].group_id){
							isSelect = true;
							break;
						}
					}
					
					groupAry[i].checked = isSelect;
				}
			}
			
			var tempIndex = setData.partIndex - 4;
			identityIdAry.slice(0,identityIdAry.length);
			if (tempIndex >= 0 && tempIndex < teacherImg.length){
				for (i = 0; i < setData.identityIdAry.length; i++){
					if (setData.identityIdAry[i] == 5){
						teacherImg[tempIndex].setAttribute('isSelect','true');
						$api.css(teacherImg[tempIndex],'background-image: url(../../../../image/quanzi/screen/iphone/teacher-select.png)');
						identityIdAry.push(5);
					}
					else if (setData.identityIdAry[i] == 6){
						studentImg[tempIndex].setAttribute('isSelect','true');
						$api.css(studentImg[tempIndex],'background-image: url(../../../../image/quanzi/screen/iphone/student-select.png)');
						identityIdAry.push(6);
					}
				}
			}
			
			for (i = 0; i < teacherImg.length; i++){
				if (i != tempIndex){
					teacherImg[i].setAttribute('isSelect','true');
					$api.css(teacherImg[i],'background-image: url(../../../../image/quanzi/screen/iphone/teacher-select.png)');
				}
			}
		}
	}
</script>
</html>