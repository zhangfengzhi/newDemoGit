<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<!-- html5：在创建html时为了防止页面缩放等不兼容效果，要创建个viewport  -->
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<!-- 在IOS设备上，有时会将数字转为手机号，这里也要禁止下 -->
		<meta name="format-detection" content="telephone=no"/>
		<title>个人信息frame</title>
		<link rel="stylesheet" type="text/css" href="../../../css/aui/aui.css" />
		<link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
		<style>
			.body-p{padding:30px 50px 20px 120px;}
			.login-header{position:absolute;right:120px;top:13px;}
			.login-header dl {position: relative;text-align: center;height: 60px;}
			.login-header dl dt {border:1px solid #ccc; border-radius:100px;padding:4px;width: 100px;
height: 100px;}
			.login-header dl dt img{width:90px; height:90px;border-radius:80px;}
			.login-header dl dd{color:#fff; line-height:32px;margin-top: 10px;border-radius: 5px;}
			/* 设置条目 */
			.item {line-height: 60px;padding:0 15px;background-color: #fff;clear: both;}
			.item span{float:left; font-size:18px;}
			.item span:last-child,.colorg{color: #696969;}
			.item:before {display: table;content: " ";}
			.item:after {clear: both;}
			.item_ico {float: left;width: 30px;padding: 10px 10px 10px 0;}
			.item_arrow {float: right;width: 16px;padding: 17px 15px 15px 0;}
			.presshover {background-color: #FAFAFA;}
			.rela{position:relative;}
			.triangle-top{position:absolute;top:-9px;right:15px;display:inline-block;width: 0; height: 0;border-right: 9px solid transparent;opacity: 0.9;border-left: 9px solid transparent;}
			.select-menu{position: absolute;z-index: 9999;text-align: center;width: 170px;right: 62px;top:48px;color: #fff;opacity: 0.9;border-radius: 10px;}
	    	.select-menu div{line-height:40px; font-size:15px;border-bottom:1px solid #eee;}
	    	.borderb0{border-bottom:0 !important;}
		</style>
	</head>
	<body class="body-p w-ipad-common">
		<div class="item rela" tapmode="presshover">
			<span>名字：</span>
			<span id="name" class="colorg"></span>
			<div class="login-header header ">
				<dl>
					<dt>
						<img onerror="this.src='../../../image/common/header.png'" src="" id="user" />
					</dt>
					<dd onclick="showTxMenu(event);" class="rela">
						更改头像
						<div id="j_select_tx_menu" class="aui-hide">
							<div class="select-menu">
								<p class="triangle-top">&nbsp;</p>
								<div class="option" onclick="openPictureHeader('album',event);">图片</div>
								<div class="option" onclick="openPictureHeader('camera',event);">拍照</div>
								<div class="option borderb0" onclick="closeTxMenu(event)">取消</div>
							</div>
						</div>
					</dd>
					
				</dl>
			</div>
		</div>
		<div class="item" tapmode="presshover">
			<span>账号：</span>
			<span id="login"></span>
		</div>
		<div class="item" tapmode="presshover" onclick="updateTelNo();">
			<span>手机号：</span>
			<span id="tel"></span>
		</div>
		<div class="item">
			<span>邮箱地址：</span>
			<span id="email"></span>
		</div>
		<div class="item" tapmode="presshover">
			<span>我的二维码：</span>
			<span style="margin-top:8px;"> 
				<img id="e_img" src="" width="128" height="128" class="aui-hide" /> 
			</span>
		</div>
		<div class="item" tapmode="presshover">
			<span>机构名称：</span><span id="bureau_name"></span>
		</div>
		<!--<div class="item" tapmode="presshover">
			<span>家庭住址：</span><span id="home_name"></span>
		</div>-->
		<input oninput="commonRemoveExpression(this)" type="hidden" id="tel_hid" />
		<input oninput="commonRemoveExpression(this)" type="hidden" id="email_hid" />
		<script type="text/javascript" src="../../../script/api.js" ></script>
		<script type="text/javascript" src="../../../script/common/common.js" ></script>
		<script type="text/javascript" src="../../../script/base_config.js" ></script>
		<script type="text/javascript" src="../../../script/assembly/UIAlbumBrowser.js"></script>
		<script type="text/javascript" src="../../../script/assembly/getPicture.js"></script>
	</body>
	<script type="text/javascript">
		//头像图片上传服务器路径
		var person_img_path;
		var header_h;
		var BASE_URL_ACTION;
		var currentPage=1;
		apiready = function() {
			commonSetTheme({"level":3,"type":0});
			//			loadMyself();
			header_h = api.pageParam.header_h;
			BASE_URL_ACTION = $api.getStorage('BASE_URL_ACTION');
			commonRefreshHeaderInfo();//下拉刷新
			initData();
			encodeImg();
		};
		/**
		 * 加载个人信息
		 * 周枫
		 * 2015.12.05
		 */
		function loadMyself() {
			var user = document.getElementById("user");
			user.src = $api.getStorage('avatar_url');
			//		$api.css($api.byId('user'),'background-image: url("../../../image/user_defaulthead@2x.png"');
			$api.html($api.byId('name'), $api.getStorage('person_name'));
			var login_name_show = $api.getStorage('login_name_show');
			if ( typeof (login_name_show) != "undefined") {
				var login_name_ypt = login_name_show.substring(0, login_name_show.lastIndexOf("_"));
				//局云混合带@
				if (login_name_ypt.lastIndexOf('@') != -1) {
					var sub_index = login_name_ypt.lastIndexOf('@');
					login_name_ypt = login_name_ypt.substring(0, sub_index);
				}
				$api.html($api.byId('login'), login_name_ypt);
			} else {
				$api.html($api.byId('login'), "您当前版本需要重新登录后显示账号");
			}
			
			//机构名称
			bureau_name = ''
			if ( typeof ($api.getStorage('bureau_name')) != 'undefined') {
				bureau_name = $api.getStorage('bureau_name');
			}
			var tel_hid = $api.val($api.byId('tel_hid'));
			var email_hid = $api.val($api.byId('email_hid'));
			if ( typeof (tel_hid) == "undefined" || tel_hid == '' || tel_hid == -1 || isEmptyString(tel_hid) || tel_hid == 'undefined') {
				$api.html($api.byId('tel'), '暂无信息' + '<i style="margin-left: 10px; vertical-align: middle;" class="aui-iconfont aui-icon-right"></i>');
			} else {
				$api.html($api.byId('tel'), tel_hid + '<i style="margin-left: 10px; vertical-align: middle;" class="aui-iconfont aui-icon-right"></i>');
			}
			if ( typeof (email_hid) == "undefined" || email_hid == '' || email_hid == -1 || isEmptyString(email_hid) || email_hid == 'undefined') {
				$api.html($api.byId('email'), '暂无信息');
			} else {
				$api.html($api.byId('email'), email_hid);
			}
			$api.html($api.byId('bureau_name'), bureau_name);
			api.hideProgress();
			commonExecScript('w_index_window','','loadMyself();',0);
		}

		/**
		 * 获取个人信息
		 * 周枫
		 * 2016.1.16
		 */
		function initData() {
			showSelfProgress('加载中...');
			api.ajax({
				url : BASE_URL_ACTION + '/person/getPersonInfo?random_num=' + creatRandomNum() + '&person_id=' + $api.getStorage("person_id") + '&identity_id=' + $api.getStorage("identity") + '&token=' + $api.getStorage("token_ypt"),
				method : 'get',
				dataType : 'json',
				timeout : 30,
				cache : false,
				headers : {
					'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
				}
			}, function(ret, err) {
				api.hideProgress();
				if (ret) {
					if (ret.success) {
						getMyselfAvatarUrlInfo(function(is_true, a_info) {
							if (is_true) {
								var a_id = a_info.file_id;
								var a_ext = a_info.extension;
								var a_avatar_url = '';
								if ($api.getStorage('BASE_APP_TYPE') == 1) {
									a_avatar_url = BASE_IMAGE_PRE+"down/Material/" + a_id.substring(0, 2) + "/" + a_id + '.' + a_ext + commonReturnPhotoCutSize(1,96,96,a_ext,0);
								} else {
									a_avatar_url = BASE_URL_ACTION + "/html/thumb/Material/" + a_id.substring(0, 2) + "/" + a_id + '.' + a_ext + commonReturnPhotoCutSize(1,96,96,a_ext,0);
								}
								//赋值头像
								$api.setStorage('avatar_url', a_avatar_url);
								//赋值真实姓名
								$api.setStorage('person_name', ret.table_List.person_name);
								var email_hid = ret.table_List.EMAIL == undefined?ret.table_List.email:ret.table_List.EMAIL;
								var tel_hid=ret.table_List.TEL == undefined?ret.table_List.tel:ret.table_List.TEL;
								if ( typeof (tel_hid) == "undefined" || tel_hid == '' || tel_hid == -1 || isEmptyString(tel_hid)) 								{
									$api.html($api.byId('tel'), '暂无信息' + '<i style="margin-left: 10px; vertical-align: middle;" class="aui-iconfont aui-icon-right"></i>');
								} else {
									$api.html($api.byId('tel'), tel_hid + '<i style="margin-left: 10px; vertical-align: middle;" class="aui-iconfont aui-icon-right"></i>');
								}
								if ( typeof (email_hid) == "undefined" || email_hid == '' || email_hid == -1 || isEmptyString(email_hid)) {
									$api.html($api.byId('email'), '暂无信息');
								} else {
									$api.html($api.byId('email'), email_hid);
								}
								$api.val($api.byId('tel_hid'), tel_hid);
								$api.val($api.byId('email_hid'), email_hid);
								commonControlRefresh();
								loadMyself();
							}
						});
					} else {
						popAlert('对不起，获取个人信息失败');
					}
				} else {
					popAlert('对不起，获取个人信息失败');
				}
				//通知顶部下拉刷新数据加载完毕，组件会恢复到默认状态
				commonControlRefresh();
			});
		}

		/**
		 * 获取头像信息
		 * 周枫
		 * 2016.1.16
		 */
		function getMyselfAvatarUrlInfo(callback) {
			var person_id = $api.getStorage("person_id");
			var identity = $api.getStorage("identity");
			api.ajax({
				url : BASE_URL_ACTION + '/person/getPersonTxByYw?random_num=' + creatRandomNum() + '&person_id=' + person_id + '&identity_id=' + identity + '&yw=ypt',
				method : 'get',
				dataType : 'json',
				timeout : 30,
				cache : false,
				headers : {
					'Cookie' : 'person_id=' + person_id + '; identity_id=' + identity + '; token=' + $api.getStorage("token_ypt") + ';'
				}
			}, function(ret, err) {
				if (ret) {
					if (ret.success) {
						callback(true, ret);
					} else {
						callback(false, '对不起，获取个人头像信息失败');
					}
				} else {
					callback(false, '对不起，获取个人头像信息失败');
				}
			});
		}
		/**
		 * 选取图片
		 * 周枫
		 * 2016.1.16
		 */
		function openPictureHeader(sourceType,event) {
			if (sourceType == 'album') {
				//相册
				album();
			} else {
				//拍照
				openPicture();
			}
			closeTxMenu(event);
		}
		/*
	    *author:zhaoj
	    *function:打开拍照
	    *date：20170914
	    */
	    function openPicture(){
	    	getPicture.open({"type":1},function(data){
	    		openImageClipFrame(data[0].path);
	    	});
	    }
		/*
		 *author:zhaoj
		 *function:选择图片
		 *date：20160225
		 */
		function album() {
			UIAlbumBrowser.open(1,function(data){
				if(api.systemType == "ios"){
					 UIAlbumBrowser.transPath(data[0].path,function(pic_url_new){
				         openImageClipFrame(pic_url_new);
				     });
				}else{
				     openImageClipFrame(data[0].path);
				}
			});
		}
		/*
	    *author:zhaoj
	    *function:打开才将
	    *date：20171020
	    */
	    function openImageClipFrame(img_url){
	    	var param = {"img_url":img_url,"frameName":api.frameName,"winName":api.winName,"backFun":"getClipImageUrl","type":1};
	    	commonOpenImageClipFrame(param);
	    }
	    /*
	    *author:zhaoj
	    *function:获取裁剪后的图片路径
	    *date：20171020
	    */
	    function getClipImageUrl(img_url){
	    	//递归上传图片
		    commonUiUploadFiles({"data":[{"path":img_url,"thumbPath":img_url}],"is_trans":0}, function(ret_data) {
		    	commonCloseImageClipFrame();
		    	for(var i = 0; i < ret_data.length; i++){
	        		var json_data = JSON.parse(ret_data[i]);
	        		var file_id = json_data.file_id;
					var ext = json_data.ext;
			    	saveMyselfAvatarUrlInfo(file_id,ext);
				}
		    });
	    }
		/**
		 * 保存头像并保存到缓存
		 * 周枫
		 * 2016.1.16
		 */
		function saveMyselfAvatarUrlInfo(file_id, ext) {
			var person_id = $api.getStorage("person_id");
			var identity = $api.getStorage("identity");
			api.ajax({
				url : BASE_URL_ACTION + '/person/setPersonTxByYw?random_num=' + creatRandomNum() + '&person_id=' + person_id + '&identity_id=' + identity + '&yw=ypt&file_id=' + file_id + '&extension=' + ext,
				method : 'get',
				dataType : 'json',
				timeout : 30,
				cache : false
			}, function(ret, err) {
				api.hideProgress();
				if (ret) {
					if (ret.success) {
						var a_avatar_url = '';
						if ($api.getStorage('BASE_APP_TYPE') == 1) {
							a_avatar_url = BASE_IMAGE_PRE+"down/Material/" + file_id.substring(0, 2) + "/" + file_id + '.' + ext + commonReturnPhotoCutSize(1,96,96,ext,0);
						} else {
							a_avatar_url = BASE_URL_ACTION + "/html/thumb/Material/" + file_id.substring(0, 2) + "/" + file_id + '.' + ext + commonReturnPhotoCutSize(1,96,96,ext,0);
						}
						//赋值头像
						$api.setStorage('avatar_url', a_avatar_url);
						loadMyself();
						api.execScript({
							name : 'root',
                            script: 'setHeaderImg();'
                        });
						api.toast({
							msg : '更新成功'
						});
					} else {
						initData();
						callback(false, '对不起，获取个人头像信息失败');
					}
				} else {
					initData();
					callback(false, '对不起，获取个人头像信息失败');
				}
			});
		}
		/**
         * 修改手机号
         * 周枫
         * 2016.08.22
         */
        function updateTelNo() {
            api.prompt({
                title : '提示',
                msg : '请输入手机号',
                type : 'number',
                buttons : ['确定', '取消']
            }, function(ret, err) {
                var index = ret.buttonIndex;
                var text = ret.text;
                var login_name = $api.getStorage('login_name');
                login_name = commonNewParamToOldParam(login_name);
                if (index == 1) {
                    if(text.length == 11 || text.length == 0){
                        var reg = /^[1][1-9][0-9]{9}/g;
                        if(reg.test(text)){
                            sendSMSForTel(login_name,text);
                        }else{
                            if($api.trimAll(text) == ''){
                                popAlert('手机号码不能为空，请重新输入');
                                return 0;
                            }else{
                                popAlert('手机号格式不对，请重新输入');
                                return 0;
                            }
                        }
                    }else{
                        popToast('请您输入有效的11位手机号码');
                    }
                }
            });
        }
        
        /*
         * 功能：校验手机号是否重复
         * 作者：张自强
         * 时间：20180822
         * 接口：冯丽杰
         */
        function getTelIsExist(text,callback){
          api.ajax({
              url:BASE_URL_ACTION + '/admin/new_base/getTelIsExist?tel='+text,
              method:'get',
              dataType : 'json',
              timeout:30,
              headers : {
                'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
            }
          },function(ret,err){
             if(ret.success){
                 callback(true);
             }else{
                 switch(ret.error*1){
                     case 1:
                         popToast('手机号校验失败');
                         break;
                     case 2:
                         popToast('手机号格式不对，请重新输入');
                         break;
                     case 3:
                         popToast('手机号已被占用');
                         break;
                     default:
                        popToast('发送验证码失败');
                        break;
                 }
                 callback(false)
             }
          });
        }
        
        
        /*
         * 功能:修改手机号码时发送验证码
         * 作者：张自强
         * 时间：20180701
         * 接口：冯丽杰
         * 参数：type:1:传1 表示是  修改 手机号业务
         */
        function sendSMSForTel(login_name,textTel){
          getTelIsExist(textTel,function(flag){
            if(flag){
                  showSelfProgress('请稍候...');
                  api.ajax({
                      url:BASE_URL_ACTION + '/ypt/userinfo/sendSMSForTel',
                      method:'post',
                      dataType:'json',
                      timeout : 30,
                      data:{
                        values:{
                           'register_flag':2,
                           'tel':textTel,
                           'type':1
                        }
                      },
                      headers : {
                        'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
                    }
                  },function(ret,err){
                     api.hideProgress();
                     if(err){
                         switch(err*1){
                             case 1://验证码发送失败！
                                 popToast('验证码发送失败');
                                 break;
                             case 2://每天每个手机号只允许获取5次短信验证码！
                                 popToast('每天只允许获取5次短信验证码');
                                 break;
                             case 3://频繁获取验证码失败，请1分钟后再发送短信验证码！
                                 popToast('频繁获取验证码失败，请1分钟后再发送短信验证码');
                                 break;
                             case 4://错误手机格式！
                                 popToast('手机号格式不对');
                                 break;
                             default:
                                popToast('发送验证码失败');
                                break;
                         }
                     }else{
                         if(ret.success){
                             rePromptVcode(login_name,textTel);
                         }else{
                             popToast(ret.info);
                         }
                     }
                  });
               }
          });
        }
        
        /*
         * 功能：校验验证码是否有效
         * 作者：张自强
         * 时间：20180801
         * 接口：冯丽杰
         */
        function valideVodeForTel(login_name,text,vcode){
           if(vcode == '' || vcode == null || typeof(vcode) == undefined){
              popToast('验证码不能为空！');
              setTimeout(function(){
                  rePromptVcode(login_name,text);
              },1000);
           }else{
               showSelfProgress('请稍候...');
               api.ajax({
                    url : BASE_URL_ACTION + '/ypt/userinfo/valideVodeForTel?register_flag=2&vcode='+vcode+'&tel='+text+'&type=1',
                    method : 'get',
                    dataType : 'json',
                    timeout : 30,
                    cache : false,
                    headers : {
                    'Cookie' : 'person_id=' + $api.getStorage("person_id") + '; identity_id=' + $api.getStorage("identity") + '; token=' + $api.getStorage("token_ypt") + ';'
                }
                }, function(ret, err) {
                    api.hideProgress();
                    if (err) {
                        switch(err){
                            case 1:
                                popToast('验证码错误');
                                break;
                            case 2:
                                popToast('无效验证码');
                                break;
                            case 3:
                                popToast('手机号格式不对');
                                break;
                            default:
                                popToast('校验验证码失败');
                                break;
                        }
                        setTimeout(function(){
                            rePromptVcode(login_name,text);
                        },1000);
                    } else {
                        if (ret.success) {
                           setTel(login_name,text);
                        } else {
                            popToast(ret.info);
                            setTimeout(function(){
                                rePromptVcode(login_name,text);
                            },1000);
                        }
                    }
                });
           }
        }
        
        /*
         * 功能：保存手机号
         * 作者：张自强
         * 时间：201800801
         */
        function setTel(login_name,text){
            api.ajax({
                url : BASE_URL_ACTION + '/per/setTel?login_name=' + login_name + '&tel=' + text,
                method : 'get',
                dataType : 'json',
                timeout : 30,
                cache : false
            }, function(ret, err) {
                api.hideProgress();
                if (err) {
                    popToast('对不起，保存失败！');
                } else {
                    if (ret.success) {
                        $api.val($api.byId('tel_hid'), text);
                        addIntegral();
                        loadMyself();
                        popToast('保存成功');
                    } else {
                        popToast(ret.info);
                    }
                }
            });
        }
        
        /*
         * 功能：重新弹出输入密码对话框
         * 作者：张自强
         * 时间：20180822
         */
        function rePromptVcode(login_name,text){
          api.prompt({
                title : '提示',
                msg : '请输入收到的验证码',
                type : 'number',
                buttons : ['确定', '取消']
            }, function(ret, err) {
                var index = ret.buttonIndex;
                var vcode_text = ret.text;
                if(index == 1){
                    valideVodeForTel(login_name,text,vcode_text);
                }
            });
        }
		
		/**
		 * 生成二维码
		 * 周枫
		 * 2016.1.16
		 */
		function encodeImg() {
			var FNScanner = api.require('FNScanner');
			var person_id = $api.getStorage('person_id');
			var identity_id = $api.getStorage('identity');
			var person_name = $api.getStorage('person_name');
			var login_name = $api.getStorage('login_name');
			FNScanner.encodeImg({
				type : 'qr_image',
				content : 'DsIdeal&&lxjxt-addfriend&&'+person_name+'&='+person_id+'&='+identity_id+'&='+login_name,
				saveToAlbum : false,
				saveImg : {
					path : BASE_FS_ERWEIMA_PATH,
					w : 128,
					h : 128
				}
			}, function(ret, err) {
				if (ret.status) {
					var user = document.getElementById("e_img");
					user.src = ret.imgPath;
					$api.removeCls($api.byId('e_img'), 'aui-hide');
				} else {
					api.toast({
	                    msg:'对不起，请重新加载'
                    });
				}
			});
		}
		/*
		*author:zfz
		*function:打开类型菜单
		*date：20171015
		*/
		function showTxMenu(dom){
			$api.removeCls($api.byId('j_select_tx_menu'), 'aui-hide');
		}
		/*
		*author:zfz
		*function:关闭级别菜单
		*date：20161015
		*/
		function closeTxMenu(event){
			$api.addCls($api.byId('j_select_tx_menu'), 'aui-hide');
			event.stopPropagation();
		}
	</script>
</html>