<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<!-- html5：在创建html时为了防止页面缩放等不兼容效果，要创建个viewport  -->
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<!-- 在IOS设备上，有时会将数字转为手机号，这里也要禁止下 -->
		<meta name="format-detection" content="telephone=no"/>
		<title>校园卡frame</title>
		<link rel="stylesheet" type="text/css" href="../../../css/aui/aui.css" />
		<link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
		<style>
			.body-p{padding:0px 120px;}
            .item { line-height: 60px;padding:0 15px;padding-left: 15px; background-color: #fff;overflow: hidden;}
            .item span{float:left; font-size:18px;}
			.item span:last-child,.colorg{color: #696969;}
			.item:before {display: table;content: " ";}
			.item:after {clear: both;}
            .tip { height: 30px;color: #444; font-size: 18px;line-height: 20px; padding: 15px 0 2px 10px; }
            .tip span { font-size: 12px; color: #666;}
            .img-box { margin-top: 80px; width: 100%; text-align: center;}
            .top{height:80px;position:relative;}
            .top hr {height: 1px;background: #e0e0e0;top: 50%;position: absolute;left: 20px;right: 20px;}
            .top span { display: inline-block; position: absolute; background: #fff; z-index: 1;top: 30px; left: 50%; margin-left: -61px;color: #333; font-size:18px;}
            .aui-icon-right{margin-left: 10px;float:left;color: #696969;}
            .tr{text-align:right;}
            .tipsys{padding-right:15px; }
		</style>
	</head>
	<body class="w-ipad-common">
		<div class="top">
			<hr />
			<span id="j_name" class="plr20">校园卡</span>
		</div>
		<div class="body-p">
			<div class="item" tapmode="" >
				<span>持卡人：</span>
				<span id="ckr_name"></span>
			</div>
			<div class="item" tapmode="" onclick="addCardNoBykeyIn();">
				<span>校园卡卡号：</span>
				<span id="card_num" class="colorg" ></span>
				<i class="aui-iconfont aui-icon-right"></i>
			</div>
			<div id = "wurizhi" >
				<div class = "img-box" onclick="addCardNoWithPersonId();">
					<img id = "scan_card" class = "bg-icon" src="../../../image/fun-module/common/scancode.png" />
					<div class = "tip tipsys">
						【扫一扫】请绑定您的校园卡！
					</div>
				</div>
			</div>
		</div>
		
	</body>
	<script type="text/javascript" src="../../../script/api.js"></script>
	<script type="text/javascript" src="../../../script/base_config.js"></script>
	<script type="text/javascript" src="../../../script/common/common.js"></script>
	<script type="text/javascript" src="../../../script/assembly/scanner.js"></script>
	<script type="text/javascript">
		var header_h;
		var BASE_URL_ACTION;
		apiready = function() {
			commonSetTheme({"level":3,"type":0});
			header_h = api.pageParam.header_h;
			BASE_URL_ACTION = $api.getStorage('BASE_URL_ACTION');
			//显示校园卡
			isHaveCardNum();
		}
		/**
		 * 绑定校园卡
		 * 周枫
		 * 2017.05.20
		 */
		function addCardNoWithPersonId() {
			var card_num = "";
			card_num = $api.text($api.byId("card_num"));
			card_num = $api.trimAll(card_num);
			//第一次绑定
			if (card_num == "您还未绑定校园卡") {
				saveCardNumFirst();
			} else {
				//更换校园卡需要密码验证
				//更换校园卡
				updateCardNum(card_num);
			}
		}

	/**
		 * 第一次绑定校园卡
		 * 周枫
		 * 2017.05.20
		 */
		function saveCardNumFirst(card_num) {
			common_scanner.openScanner(function(is_true, open_info, open_status, scan_content) {
				if (is_true) {
					if (open_status == "success") {
					    if(!isNaN(scan_content)){
							card_num = scan_content;
							api.showProgress({
								title : '绑定中...',
								text : '请稍候...',
								modal : true
							});
							//绑定校园卡
							api.ajax({
								url : BASE_URL_ACTION + '/padx/addCardNoWithPersonId',
								method : 'get',
								timeout : 0,
								dataType : 'json',
								data : {
									values : {
										"person_id" : $api.getStorage("person_id"),
										"identity_id" : $api.getStorage("identity"),
										"card_num" : card_num
									}
								}
							}, function(ret, err) {
								api.hideProgress();
								if (err) {
									popBottomToast("对不起，绑定校园卡失败");
									reCardNum("");
								} else {
									if (ret.success) {
										reCardNum(card_num);
									} else {
										popBottomToast(ret.info);
										reCardNum("");
									}
								}
							});
						}else{
							popToast('请扫描您的校园卡');
						}
					}
				} else {
				}
			});
		}

		/**
		 * 更换校园卡
		 * 周枫
		 * 2017.05.09
		 */
		function updateCardNum(card_num) {
			common_scanner.openScanner(function(is_true, open_info, open_status, scan_content) {
				if (is_true) {
					if (open_status == "success") {
						if(!isNaN(scan_content)){
							var identity_id = $api.getStorage("identity");
							var person_id = $api.getStorage("person_id");
							if (identity_id == 7) {
								commonGetStudentInfoByParentId(person_id, identity_id, function(is_true, stu_info_json) {
									if (is_true) {
										var stu_id = stu_info_json.student_id;
										updateCardNumToDb(stu_id, 6, scan_content);
									} else {
										popBottomToast("对不起，更换校园卡失败");
									}
								});
							} else {
								updateCardNumToDb(person_id, identity_id, scan_content);
							}
						}else{
							popToast('请扫描您的校园卡');
						}
					}
				} else {
				}
			});
		}

		/**
		 * 更换校园卡
		 * 周枫
		 * 2017.05.20
		 */
		function updateCardNumToDb(person_id, identity_id, card_num) {
			api.showProgress({
				title : '绑定中...',
				text : '请稍候...',
				modal : true
			});
			//绑定校园卡
			api.ajax({
				url : BASE_URL_ACTION + '/padx/updateCardNoWithPersonId',
				method : 'get',
				timeout : 0,
				dataType : 'json',
				data : {
					values : {
						"person_id" : person_id,
						"identity_id" : identity_id,
						"card_num" : card_num
					}
				}
			}, function(ret, err) {
				api.hideProgress();
				if (err) {
					popBottomToast("对不起，更换校园卡失败");
					reCardNum("");
				} else {
					if (ret.success) {
						reCardNum(card_num);
					} else {
						popBottomToast("对不起，更换校园卡失败");
						reCardNum("");
					}
				}
			});
		}

		/**
		 * 显示校园卡
		 * 周枫
		 * 2017.05.09
		 */
		function isHaveCardNum() {
			api.showProgress({
				title : '加载中...',
				text : '请稍候...',
				modal : false
			});
			//查询校园卡
			api.ajax({
				url : BASE_URL_ACTION + '/padx/selectCardNoByPersonId',
				method : 'get',
				timeout : 0,
				dataType : 'json',
				data : {
					values : {
						"person_id" : $api.getStorage("person_id"),
						"identity_id" : $api.getStorage("identity")
					}
				}
			}, function(ret, err) {
				api.hideProgress();
				if (err) {
					reCardNum("");
				} else {
					if (ret.success) {
						if (ret.card_num == "") {
							reCardNum("");
						} else {
							reCardNum(ret.card_num);
						}
					} else {
						reCardNum("");
					}
				}
			});
		}

		/**
		 * 校园卡文本赋值
		 * 周枫
		 * 2017.05.09
		 */
		function reCardNum(val) {
			if (val == "") {
				val = "您还未绑定校园卡";
			}
			$api.text($api.byId("card_num"), val);
			var person_name = $api.getStorage("person_name");
			$api.html($api.byId("ckr_name"), person_name);

		}
		
		/**
		 * author:zfz
		 * function:手动输入卡号
		 * data:20170911
		 */
		function addCardNoBykeyIn(){
			var key_in_card_num = "";
			//弹出输入框
			api.prompt({
				title : '校园卡',
				msg : '请输入校园卡卡号',
				type : 'text',
				buttons : ['确定', '取消']
			}, function(ret, err) {
				var index = ret.buttonIndex;
				key_in_card_num = ret.text;
				if (index == 1) {
					key_in_card_num = $api.trimAll(key_in_card_num);
					if (key_in_card_num.length == 0) {
						popAlert('对不起，请输入校园卡卡号。')
						return false;
					}
					if(key_in_card_num.length > 0){
						var regu = /^[0-9]\d*$/;
						if(!regu.test(key_in_card_num)){
							popAlert('请输入正确的校园卡卡号。')
							return false;
						}
					}
					var card_num = "";
					card_num = $api.text($api.byId("card_num"));
					card_num = $api.trimAll(card_num);
					//第一次绑定
					if (card_num == "您还未绑定校园卡") {
						saveCardNumFirstBykeyIn(key_in_card_num);
					} else {
						//更换校园卡需要密码验证
						//更换校园卡
						updateCardNumBykeyIn(key_in_card_num);
					}
				}
			});	
		}
		
		/**
		 * author:zfz
		 * function:手动输入卡号第一次绑定校园卡
		 * data:20170911
		 */
		function saveCardNumFirstBykeyIn(card_num) {
			api.ajax({
				url : BASE_URL_ACTION + '/padx/addCardNoWithPersonId',
				method : 'get',
				timeout : 0,
				dataType : 'json',
				data : {
					values : {
						"person_id" : $api.getStorage("person_id"),
						"identity_id" : $api.getStorage("identity"),
						"card_num" : card_num
					}
				}
			}, function(ret, err) {
				api.hideProgress();
				if (err) {
					popBottomToast("对不起，绑定校园卡失败");
					reCardNum("");
				} else {
					if (ret.success) {
						reCardNum(card_num);
					} else {
						popBottomToast(ret.info);
						reCardNum("");
					}
				}
			});
		}
		
		/**
		 * author:zfz
		 * function:手动输入卡号更换校园卡
		 * data:20170911
		 */
		function updateCardNumBykeyIn(card_num) {
			var identity_id = $api.getStorage("identity");
			var person_id = $api.getStorage("person_id");
			if (identity_id == 7) {
				commonGetStudentInfoByParentId(person_id, identity_id, function(is_true, stu_info_json) {
					if (is_true) {
						var stu_id = stu_info_json.student_id;
						updateCardNumToDb(stu_id, 6, card_num);
					} else {
						popBottomToast("对不起，更换校园卡失败");
					}
				});
			} else {
				updateCardNumToDb(person_id, identity_id, card_num);
			}
		}
	</script>
</html>