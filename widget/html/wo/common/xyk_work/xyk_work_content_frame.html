<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<!-- html5：在创建html时为了防止页面缩放等不兼容效果，要创建个viewport  -->
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<!-- 在IOS设备上，有时会将数字转为手机号，这里也要禁止下 -->
		<meta name="format-detection" content="telephone=no"/>
		<title>关于软件frame</title>
		<link rel="stylesheet" type="text/css" href="../../../../css/aui/aui.css" />
		<link id="j_theme_base" rel="stylesheet" type="text/css" href="" />
		<style>
            body {
                background: #f7f9f8;
            }
            .h10 {
                height: 10px;
                background: #f7f9f8;
            }
            .h20 {
                height: 20px;
                background: #f7f9f8;
            }
            .h1 {
                height: 1px;
                background: #CCCCCC;/*margin:0 15px;*/
            }
            .fr {
                float: right;
            }
            .firstblock, .secondblock, .thirdblock {
                background-color: #fff;
            }
            /* 设置条目 */
            .item {
                height: 50px;
                line-height: 50px;
                background-color: #fff;
            }
            .presshover {
                background-color: #FAFAFA;
            }
            /* 设置条目 */
            .item {
                height: 50px;
                line-height: 50px;
                padding-left: 15px;
                background-color: #fff;
            }
            .item_ico {
                float: left;
                width: 30px;
                padding: 10px 10px 10px 0;
            }
            .item_arrow {
                float: right;
                width: 16px;
                padding: 17px 15px 15px 0;
            }
            .presshover {
                background-color: #FAFAFA;
            }
            .item_right {
                color: #696969;
                font-size: 14px;
                padding-right: 15px;
            }
            .tip {
                height: 30px;
                color: #444;
                font-size: 14px;
                line-height: 20px;
                padding: 8px 0 2px 10px;
            }
            .tip span {
                font-size: 12px;
                color: #666;
            }
            .img-box {
                padding-top: 30%;
                width: 100%;
                text-align: center;
            }
		</style>
	</head>
	<body class="w-iphone-common">
		<div class="h20"></div>
		<div id="j_tip" class="tip">
			请绑定持卡人本人的校园卡
		</div>
		<div class="h1"></div>
		<div class="secondblock">
			<div class="item" tapmode="presshover" >
				<span>持卡人</span><span class="item_right aui-pull-right"><font id="ckr_name"></font></span>
			</div>
			<div class="h1"></div>
			<div class="item" tapmode="presshover" onclick="addCardNoBykeyIn();">
				<span>校园卡卡号</span>
				
				<span id="padx_card" class="item_right aui-pull-right"><font id="card_num"></font>
				<i class="aui-iconfont aui-icon-right"></i>
				</span>
				
			</div>
			<div class="h1"></div>
		</div>
		<div class="h20"></div>
		<div id = "wurizhi" >
			<div class = "img-box" onclick="addCardNoWithPersonId();">
				<img id = "scan_card" class = "bg-icon" onerror="this.src='../../../../image/fun-module/common/scancode.png'" src="../../../../image/fun-module/common/scancode.png" />
				<div class = "tip">
					【扫一扫】绑定校园卡
				</div>
			</div>
		</div>
	</body>
	<script type="text/javascript" src="../../../../script/api.js"></script>
	<script type="text/javascript" src="../../../../script/base_config.js"></script>
	<script type="text/javascript" src="../../../../script/assembly/scanner.js"></script>
	<script type="text/javascript" src="../../../../script/common/common.js"></script>
	<script type="text/javascript">
		var header_h;
		var BASE_URL_ACTION;
		apiready = function() {
			console.log(JSON.stringify(api.pageParam))
			commonSetTheme({"level":4,"type":0});
			header_h = api.pageParam.header_h;
			BASE_URL_ACTION = $api.getStorage('BASE_URL_ACTION');
			//显示校园卡
			isHaveCardNum();
		}
		/**
		 * 绑定校园卡
		 * 周枫
		 * 2017.05.20
		 */
		function addCardNoWithPersonId() {
			var card_num = "";
			card_num = $api.text($api.byId("card_num"));
			card_num = $api.trimAll(card_num);
			//第一次绑定
			if (card_num == "您还未绑定校园卡") {
				saveCardNumFirst();
			} else {
				//更换校园卡需要密码验证
				//更换校园卡
				updateCardNum(card_num);
			}
		}

		/**
		 * 第一次绑定校园卡
		 * 周枫
		 * 2017.05.20
		 */
		function saveCardNumFirst(card_num) {
			common_scanner.openScanner(function(is_true, open_info, open_status, scan_content) {
				if (is_true) {
					if (open_status == "success") {
						if(!isNaN(scan_content)){
							card_num = scan_content;
							api.showProgress({
								title : '绑定中...',
								text : '请稍候...',
								modal : true
							});
							//绑定校园卡
							api.ajax({
								url : BASE_URL_ACTION + '/padx/addCardNoWithPersonId',
								method : 'get',
								timeout : 0,
								dataType : 'json',
								data : {
									values : {
										"person_id" : api.pageParam.id,
										"identity_id" : 6,
										"card_num" : card_num
									}
								}
							}, function(ret, err) {
								api.hideProgress();
								if (err) {
									popBottomToast("对不起，绑定校园卡失败");
//									reCardNum("");
								} else {
									if (ret.success) {
										reCardNum(card_num);
									} else {
										popBottomToast(ret.info);
//										reCardNum("");
									}
								}
							});
						}else{
							popToast('请扫描您的校园卡');
						}
					}
				} else {
				}
			});
		}

		/**
		 * 更换校园卡
		 * 周枫
		 * 2017.05.09
		 */
		function updateCardNum(card_num) {
			common_scanner.openScanner(function(is_true, open_info, open_status, scan_content) {
				if (is_true) {
					if (open_status == "success") {
						if(!isNaN(scan_content)){
							var identity_id = 6;
							var person_id = api.pageParam.id;
							if (identity_id == 7) {
								commonGetStudentInfoByParentId(person_id, identity_id, function(is_true, stu_info_json) {
									if (is_true) {
										var stu_id = stu_info_json.student_id;
										updateCardNumToDb(stu_id, 6, scan_content);
									} else {
										popBottomToast("对不起，更换校园卡失败");
									}
								});
							} else {
								updateCardNumToDb(person_id, identity_id, scan_content);
							}
						}else{
							popToast('请扫描您的校园卡');
						}
					}
				} else {
				}
			});
		}

		/**
		 * 更换校园卡
		 * 周枫
		 * 2017.05.20
		 */
		function updateCardNumToDb(person_id, identity_id, card_num) {
			api.showProgress({
				title : '绑定中...',
				text : '请稍候...',
				modal : true
			});
			//绑定校园卡
			api.ajax({
				url : BASE_URL_ACTION + '/padx/updateCardNoWithPersonId',
				method : 'get',
				timeout : 0,
				dataType : 'json',
				data : {
					values : {
						"person_id" : person_id,
						"identity_id" : identity_id,
						"card_num" : card_num
					}
				}
			}, function(ret, err) {
				api.hideProgress();
				if (err) {
					popBottomToast("对不起，更换校园卡失败");
//					reCardNum("");
				} else {
					if (ret.success) {
						reCardNum(card_num);
					} else if (ret.info){
						popBottomToast(ret.info);
//						reCardNum("");
					}else{
						popBottomToast("对不起，更换校园卡失败");
					}
				}
			});
		}

		/**
		 * 显示校园卡
		 * 周枫
		 * 2017.05.09
		 */
		function isHaveCardNum() {
			api.showProgress({
				title : '加载中...',
				text : '请稍候...',
				modal : false
			});
			//查询校园卡
			api.ajax({
				url : BASE_URL_ACTION + '/padx/selectCardNoByPersonId',
				method : 'get',
				timeout : 0,
				dataType : 'json',
				data : {
					values : {
						"person_id" : api.pageParam.id,
						"identity_id" : 6
					}
				}
			}, function(ret, err) {
				api.hideProgress();
				if (err) {
//					reCardNum("");
				} else {
					if (ret.success) {
						if (ret.card_num == "") {
							reCardNum("");
						} else {
							reCardNum(ret.card_num);
						}
					} else {
//						reCardNum("");
					}
				}
			});
		}

		/**
		 * 校园卡文本赋值
		 * 周枫
		 * 2017.05.09
		 */
		function reCardNum(val) {
			if (val == "") {
				val = "您还未绑定校园卡";
			}
			$api.text($api.byId("card_num"), val);
			var person_name = api.pageParam.name;
			$api.html($api.byId("ckr_name"), person_name);

		}
		
		/**
		 * author:zfz
		 * function:手动输入卡号
		 * data:20170911
		 */
		function addCardNoBykeyIn(){
			var key_in_card_num = "";
			//弹出输入框
			api.prompt({
				title : '校园卡',
				msg : '请输入校园卡卡号',
				type : 'text',
				buttons : ['确定', '取消']
			}, function(ret, err) {
				var index = ret.buttonIndex;
				key_in_card_num = ret.text;
				if (index == 1) {
					key_in_card_num = $api.trimAll(key_in_card_num);
					if (key_in_card_num.length == 0) {
						popAlert('对不起，请输入校园卡卡号。')
						return false;
					}
					if(key_in_card_num.length > 0){
						var regu = /^[0-9]\d*$/;
						if(!regu.test(key_in_card_num)){
							popAlert('请输入正确的校园卡卡号。')
							return false;
						}
					}
					var card_num = "";
					card_num = $api.text($api.byId("card_num"));
					card_num = $api.trimAll(card_num);
					//第一次绑定
					if (card_num == "您还未绑定校园卡") {
						saveCardNumFirstBykeyIn(key_in_card_num);
					} else {
						//更换校园卡需要密码验证
						//更换校园卡
						updateCardNumBykeyIn(key_in_card_num);
					}
				}
			});	
		}
		
		/**
		 * author:zfz
		 * function:手动输入卡号第一次绑定校园卡
		 * data:20170911
		 */
		function saveCardNumFirstBykeyIn(card_num) {
			api.ajax({
				url : BASE_URL_ACTION + '/padx/addCardNoWithPersonId',
				method : 'get',
				timeout : 0,
				dataType : 'json',
				data : {
					values : {
						"person_id" : api.pageParam.id,
						"identity_id" : 6,
						"card_num" : card_num
					}
				}
			}, function(ret, err) {
				api.hideProgress();
				if (err) {
					popBottomToast("对不起，绑定校园卡失败");
					reCardNum("");
				} else {
					if (ret.success) {
						reCardNum(card_num);
					} else {
						popBottomToast(ret.info);
//						reCardNum("");
					}
				}
			});
		}
		
		/**
		 * author:zfz
		 * function:手动输入卡号更换校园卡
		 * data:20170911
		 */
		function updateCardNumBykeyIn(card_num) {
			var identity_id = 6;
			var person_id = api.pageParam.id;
			if (identity_id == 7) {
				commonGetStudentInfoByParentId(person_id, identity_id, function(is_true, stu_info_json) {
					if (is_true) {
						var stu_id = stu_info_json.student_id;
						updateCardNumToDb(stu_id, 6, card_num);
					} else {
						popBottomToast("对不起，更换校园卡失败");
					}
				});
			} else {
				updateCardNumToDb(person_id, identity_id, card_num);
			}
		}
	</script>
</html>